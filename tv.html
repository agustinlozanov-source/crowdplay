<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrowdPlay TV</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; width: 100vw; height: 100vh; font-family: Arial; }
        #player { width: 100%; height: 100%; }
        #info { position: fixed; top: 20px; left: 20px; background: rgba(0,0,0,0.9); color: #fff; padding: 15px 20px; border-radius: 8px; font-size: 14px; z-index: 1000; }
    </style>
</head>
<body>
    <div id="player"></div>
    <div id="info">Iniciando...</div>

    <script>
        // Load Firebase
        const script1 = document.createElement('script');
        script1.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js';
        
        script1.onload = () => {
            const script2 = document.createElement('script');
            script2.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js';
            
            script2.onload = () => {
                const script3 = document.createElement('script');
                script3.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js';
                
                script3.onload = () => {
                    console.log('Firebase loaded');
                    initFirebase();
                };
                
                document.head.appendChild(script3);
            };
            
            document.head.appendChild(script2);
        };
        
        document.head.appendChild(script1);

        const firebaseConfig = {
            apiKey: "AIzaSyAia_yRHvYg3gGQ60VwPRwcRm3B0aja4cw",
            authDomain: "rocola-crowdplay2.firebaseapp.com",
            projectId: "rocola-crowdplay2",
            storageBucket: "rocola-crowdplay2.firebasestorage.app",
            messagingSenderId: "519952213703",
            appId: "1:519952213703:web:0e0ecb8cb3fc81064240e2"
        };

        let player;
        let currentVideoId = null;

        function initFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth();
                const db = firebase.firestore();

                auth.signInAnonymously().then(() => {
                    console.log('Auth OK');
                    setupQueue(db);
                }).catch(err => {
                    document.getElementById('info').textContent = 'Auth error: ' + err.code;
                });
            } catch (e) {
                console.error('Error:', e);
                document.getElementById('info').textContent = 'Error: ' + e.message;
            }
        }

        function setupQueue(db) {
            db.collection('artifacts/rocola-crowdplay2-v1/public/data/rocola_queue')
                .onSnapshot(snap => {
                    if (!snap.empty) {
                        const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        const playing = items.find(i => i.status === 'playing');
                        if (playing && playing.videoId && playing.videoId !== currentVideoId) {
                            currentVideoId = playing.videoId;
                            if (player && player.loadVideoById) {
                                player.loadVideoById(playing.videoId);
                                player.playVideo();
                            }
                            document.getElementById('info').textContent = '▶ ' + (playing.title || playing.videoId);
                        } else if (!playing) {
                            document.getElementById('info').textContent = 'Esperando canción...';
                        }
                    } else {
                        document.getElementById('info').textContent = 'Cola vacía';
                    }
                }, err => {
                    document.getElementById('info').textContent = 'Error: ' + err.code;
                });
        }

        window.onYouTubeIframeAPIReady = () => {
            console.log('YouTube ready');
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                playerVars: { autoplay: 1, controls: 1, modestbranding: 1, fs: 1 }
            });
        };

        document.addEventListener('keydown', e => {
            if ((e.key === 'f' || e.key === 'F') && player) {
                const el = document.documentElement;
                if (document.fullscreenElement) document.exitFullscreen();
                else el.requestFullscreen?.().catch(() => {});
            }
        });
    </script>
    <script async src="https://www.youtube.com/iframe_api"></script>
</body>
</html>
