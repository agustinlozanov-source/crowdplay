<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrowdPlay TV</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; width: 100vw; height: 100vh; font-family: Arial; }
        #player { width: 100%; height: 100%; }
        #info { position: fixed; top: 20px; left: 20px; background: rgba(0,0,0,0.9); color: #fff; padding: 15px 20px; border-radius: 8px; font-size: 14px; z-index: 1000; }
    </style>
</head>
<body>
    <div id="player"></div>
    <div id="info">Iniciando...</div>

    <script>
        // Load Firebase
        const script1 = document.createElement('script');
        script1.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js';
        
        script1.onload = () => {
            const script2 = document.createElement('script');
            script2.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js';
            
            script2.onload = () => {
                const script3 = document.createElement('script');
                script3.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js';
                
                script3.onload = () => {
                    console.log('Firebase loaded');
                    initFirebase();
                };
                
                document.head.appendChild(script3);
            };
            
            document.head.appendChild(script2);
        };
        
        document.head.appendChild(script1);

        const firebaseConfig = {
            apiKey: "AIzaSyAia7RLwDKkBHqjLnH-BFVLrr7m7G2xWq0",
            authDomain: "crowdplay-7cf0c.firebaseapp.com",
            projectId: "crowdplay-7cf0c",
            storageBucket: "crowdplay-7cf0c.appspot.com",
            messagingSenderId: "623433099154",
            appId: "1:623433099154:web:fef95d36c5c4e7c6a9a7df"
        };

        let player;
        let currentVideoId = null;

        function initFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth();
                const db = firebase.firestore();

                auth.signInAnonymously().then(() => {
                    console.log('Auth OK');
                    setupQueue(db);
                }).catch(err => {
                    document.getElementById('info').textContent = 'Auth error: ' + err.code;
                });
            } catch (e) {
                console.error('Error:', e);
                document.getElementById('info').textContent = 'Error: ' + e.message;
            }
        }

        function setupQueue(db) {
            db.collection('queue')
                .orderBy('createdAt', 'asc')
                .limit(1)
                .onSnapshot(snap => {
                    console.log('Queue:', snap.size);
                    if (!snap.empty) {
                        const data = snap.docs[0].data();
                        const vid = data.videoId || data.id;
                        if (vid && vid !== currentVideoId && player) {
                            currentVideoId = vid;
                            player.loadVideoById(vid);
                            document.getElementById('info').textContent = 'Reproduciendo: ' + (data.title || vid);
                        }
                    } else {
                        document.getElementById('info').textContent = 'Esperando canciÃ³n...';
                    }
                }, err => {
                    document.getElementById('info').textContent = 'Firestore: ' + err.code;
                });
        }

        window.onYouTubeIframeAPIReady = () => {
            console.log('YouTube ready');
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                playerVars: { autoplay: 1, controls: 1, modestbranding: 1, fs: 1 }
            });
        };

        document.addEventListener('keydown', e => {
            if ((e.key === 'f' || e.key === 'F') && player) {
                const el = document.documentElement;
                if (document.fullscreenElement) document.exitFullscreen();
                else el.requestFullscreen?.().catch(() => {});
            }
        });
    </script>
    <script async src="https://www.youtube.com/iframe_api"></script>
</body>
</html>
