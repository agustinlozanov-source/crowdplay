<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrowdPlay TV</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; width: 100vw; height: 100vh; font-family: Arial, sans-serif; }
        #player { width: 100%; height: 100%; }
        .info { position: fixed; top: 20px; left: 20px; background: rgba(0,0,0,0.9); color: #fff; padding: 15px 20px; border-radius: 8px; font-size: 14px; z-index: 1000; border: 1px solid rgba(255,255,255,0.2); }
    </style>
</head>
<body>
    <div id="player"></div>
    <div class="info" id="info">Iniciando...</div>

    <!-- Load Firebase scripts first -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAia7RLwDKkBHqjLnH-BFVLrr7m7G2xWq0",
            authDomain: "crowdplay-7cf0c.firebaseapp.com",
            projectId: "crowdplay-7cf0c",
            storageBucket: "crowdplay-7cf0c.appspot.com",
            messagingSenderId: "623433099154",
            appId: "1:623433099154:web:fef95d36c5c4e7c6a9a7df"
        };

        let player;
        let currentVideoId = null;
        let db, auth;

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM ready, initializing Firebase...');
            
            try {
                // Initialize Firebase
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                auth = firebase.auth();
                console.log('Firebase initialized');
                
                // Authenticate anonymously
                await auth.signInAnonymously();
                console.log('Anonymous auth successful');
                updateInfo('Conectado. Presiona F para fullscreen');

                // Listen to queue
                setupQueueListener();
            } catch (err) {
                console.error('Error:', err);
                updateInfo('Error: ' + err.message);
            }
        });

        function updateInfo(msg) {
            const el = document.getElementById('info');
            if (el) el.textContent = msg;
        }

        function setupQueueListener() {
            if (!db) {
                console.error('DB not initialized');
                return;
            }

            db.collection('queue')
                .orderBy('createdAt', 'asc')
                .limit(1)
                .onSnapshot(
                    snap => {
                        console.log('Queue snapshot:', snap.size);
                        if (!snap.empty) {
                            const doc = snap.docs[0];
                            const data = doc.data();
                            const videoId = data.videoId || data.id;
                            
                            console.log('Video:', videoId, data);
                            
                            if (videoId && videoId !== currentVideoId && player) {
                                currentVideoId = videoId;
                                player.loadVideoById(videoId);
                                updateInfo('Reproduciendo: ' + (data.title || videoId));
                            }
                        } else {
                            updateInfo('Esperando canciones...');
                        }
                    },
                    err => {
                        console.error('Firestore error:', err);
                        updateInfo('Error: ' + err.code);
                    }
                );
        }

        // YouTube Player Ready
        window.onYouTubeIframeAPIReady = () => {
            console.log('YouTube API ready');
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                playerVars: {
                    'autoplay': 1,
                    'controls': 1,
                    'modestbranding': 1,
                    'fs': 1,
                    'rel': 0
                }
            });
        };

        // Fullscreen on F key
        document.addEventListener('keydown', e => {
            if (e.key === 'f' || e.key === 'F') {
                const elem = document.documentElement;
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                } else if (elem.requestFullscreen) {
                    elem.requestFullscreen().catch(err => {
                        console.log('Fullscreen denied:', err);
                    });
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                }
            }
        });
    </script>
</body>
</html>
