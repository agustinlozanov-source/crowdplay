<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrowdPlay TV</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; width: 100vw; height: 100vh; font-family: Arial; }
        #player { width: 100%; height: 100%; }
        #info { position: fixed; top: 20px; left: 20px; background: rgba(0,0,0,0.9); color: #fff; padding: 15px 20px; border-radius: 8px; font-size: 14px; z-index: 1000; }
    </style>
</head>
<body>
    <div id="player"></div>
    <div id="info">Iniciando...</div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAia_yRHvYg3gGQ60VwPRwcRm3B0aja4cw",
            authDomain: "rocola-crowdplay2.firebaseapp.com",
            projectId: "rocola-crowdplay2",
            storageBucket: "rocola-crowdplay2.firebasestorage.app",
            messagingSenderId: "519952213703",
            appId: "1:519952213703:web:0e0ecb8cb3fc81064240e2"
        };

        let player = null;
        let playerReady = false;
        let pendingVideoId = null;
        let currentVideoId = null;
        let firestoreDb = null;
        const firestoreAppId = 'rocola-crowdplay2-v1';

        // Intenta cargar video — si el player no está listo, lo guarda pendiente
        function loadVideo(videoId) {
            if (!videoId || videoId === currentVideoId) return;
            currentVideoId = videoId;
            if (playerReady && player) {
                player.loadVideoById(videoId);
                player.playVideo();
                setTimeout(() => fadeInTV(), 500);
            } else {
                pendingVideoId = videoId;
            }
        }

        window.onYouTubeIframeAPIReady = function() {
            console.log('YouTube ready');
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                playerVars: {
                    autoplay: 1,
                    controls: 1,
                    modestbranding: 1,
                    fs: 1,
                    rel: 0,
                    iv_load_policy: 3,
                    origin: window.location.origin
                },
                events: {
                    onReady: function(e) {
                        console.log('Player ready');
                        playerReady = true;
                        e.target.setVolume(0);
                        fadeInTV();
                        if (pendingVideoId) {
                            e.target.loadVideoById(pendingVideoId);
                            e.target.playVideo();
                            pendingVideoId = null;
                        }
                    },
                    onStateChange: function(e) {
                        if (e.data === YT.PlayerState.ENDED) {
                            document.getElementById('info').textContent = 'Cambiando canción...';
                            skipToNext();
                        }
                    },
                    onError: function(e) {
                        console.error('Player error:', e.data);
                        document.getElementById('info').textContent = 'Error video: ' + e.data;
                    }
                }
            });
        };

        function setupQueue(db) {
            const appId = 'rocola-crowdplay2-v1';
            db.collection(`artifacts/${appId}/public/data/rocola_queue`)
                .onSnapshot(snap => {
                    if (snap.empty) {
                        document.getElementById('info').textContent = 'Cola vacía — esperando canciones...';
                        return;
                    }
                    const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    const playing = items.find(i => i.status === 'playing');

                    if (playing && playing.videoId) {
                        loadVideo(playing.videoId);
                        document.getElementById('info').textContent = '▶ ' + (playing.title || playing.videoId);

                        // Sincronizar comandos del DJ
                        if (playerReady && player) {
                            try {
                                if (playing.lastCommand === 'pause') {
                                    player.pauseVideo();
                                } else if (playing.lastCommand === 'play') {
                                    player.playVideo();
                                } else if (playing.lastCommand === 'seek' && playing.offset) {
                                    player.seekTo(player.getCurrentTime() + playing.offset, true);
                                }
                            } catch(e) { console.error('Command sync error:', e); }
                        }
                    } else {
                        document.getElementById('info').textContent = 'Esperando canción...';
                    }
                }, err => {
                    console.error('Firestore error:', err);
                    document.getElementById('info').textContent = 'Error Firestore: ' + err.code;
                });
        }

        function initFirebase() {
            try {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth();
                const db = firebase.firestore();
                firestoreDb = db;

                auth.signInAnonymously()
                    .then(() => {
                        console.log('Auth OK');
                        setupQueue(db);
                    })
                    .catch(err => {
                        document.getElementById('info').textContent = 'Auth error: ' + err.code;
                    });
            } catch(e) {
                console.error('Init error:', e);
                document.getElementById('info').textContent = 'Error init: ' + e.message;
            }
        }

        // Carga Firebase en cascada
        const s1 = document.createElement('script');
        s1.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js';
        s1.onload = () => {
            const s2 = document.createElement('script');
            s2.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js';
            s2.onload = () => {
                const s3 = document.createElement('script');
                s3.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js';
                s3.onload = initFirebase;
                document.head.appendChild(s3);
            };
            document.head.appendChild(s2);
        };
        document.head.appendChild(s1);

        // Fullscreen con tecla F
        document.addEventListener('keydown', e => {
            if (e.key === 'f' || e.key === 'F') {
                const el = document.documentElement;
                if (document.fullscreenElement) document.exitFullscreen();
                else el.requestFullscreen?.().catch(() => {});
            }
        });

        // Fullscreen al hacer click
        document.getElementById('player').addEventListener('click', () => {
            const el = document.documentElement;
            if (!document.fullscreenElement) el.requestFullscreen?.().catch(() => {});
        });

        function fadeOutTV() {
            return new Promise(resolve => {
                if (!player || typeof player.getVolume !== 'function') { resolve(); return; }
                let vol = player.getVolume();
                const step = setInterval(() => {
                    vol = Math.max(0, vol - 8);
                    try { player.setVolume(vol); } catch(e) {}
                    if (vol <= 0) { clearInterval(step); resolve(); }
                }, 50);
            });
        }

        function fadeInTV() {
            if (!player || typeof player.setVolume !== 'function') return;
            let vol = 0;
            player.setVolume(0);
            const step = setInterval(() => {
                vol = Math.min(100, vol + 8);
                try { player.setVolume(vol); } catch(e) {}
                if (vol >= 100) clearInterval(step);
            }, 50);
        }

        async function skipToNext() {
            if (!firestoreDb) return;
            try {
                await fadeOutTV();
                const snap = await firestoreDb
                    .collection(`artifacts/${firestoreAppId}/public/data/rocola_queue`)
                    .get();
                if (snap.empty) {
                    document.getElementById('info').textContent = 'Cola vacía';
                    return;
                }
                const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                const playing = items.find(i => i.status === 'playing');
                const pending = items
                    .filter(i => i.status === 'pending')
                    .sort((a, b) => ((b.votes || 0) - (a.votes || 0)) || ((a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)));

                if (pending.length > 0) {
                    await firestoreDb
                        .collection(`artifacts/${firestoreAppId}/public/data/rocola_queue`)
                        .doc(pending[0].id)
                        .update({ status: 'playing', lastCommand: 'play', showDedication: false });
                }
                if (playing) {
                    await firestoreDb
                        .collection(`artifacts/${firestoreAppId}/public/data/rocola_queue`)
                        .doc(playing.id)
                        .delete();
                }
            } catch(e) {
                console.error('skipToNext error:', e);
                document.getElementById('info').textContent = 'Error al cambiar canción';
            }
        }
    </script>
    <script async src="https://www.youtube.com/iframe_api"></script>
</body>
</html>
