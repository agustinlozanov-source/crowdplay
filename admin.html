<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://www.googleapis.com https://cdn.tailwindcss.com https://www.youtube.com https://s.ytimg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.tailwindcss.com; img-src 'self' data: https:; connect-src 'self' https://firestore.googleapis.com https://www.googleapis.com https://www.gstatic.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com; frame-src https://www.youtube.com https://www.youtube-nocookie.com; font-src 'self' https://fonts.gstatic.com data:;">
    <title>Rocola Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:ital,wght@0,400;0,700;0,900;1,400;1,700;1,900&family=Barlow:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* ═══════════════════════════════════════════
           DESIGN TOKENS — NEW PALETTE
        ═══════════════════════════════════════════ */
        :root {
            --bg-base:    #090b11;
            --bg-surface: #10131c;
            --bg-card:    #171b27;
            --bg-elevated:#1f2435;
            --border:     rgba(255,255,255,0.09);
            --border-mid: rgba(255,255,255,0.16);
            --text-primary:   #eef0f8;
            --text-secondary: #8b92b0;
            --text-muted:     #4a5070;
            --accent-red:   #e8362a;
            --accent-red-glow: rgba(232,54,42,0.3);
            --accent-green: #1fd670;
            --accent-amber: #f0b429;
            --accent-indigo:#5b6ef5;
            --accent-purple:#8b5cf6;
            --sidebar-w: 240px;
            --sidebar-w-collapsed: 64px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Barlow', sans-serif;
            font-size: 15px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            letter-spacing: 0.01em;
            background-color: var(--bg-base);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* Barlow Condensed = display/heading font */
        .font-display { font-family: 'Barlow Condensed', sans-serif; }

        /* ── SCROLLBAR ── */
        ::-webkit-scrollbar { width: 3px; height: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 10px; }

        /* ── GLASS CARDS ── */
        .glass {
            background: rgba(21, 24, 32, 0.8);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border);
        }
        .glass-elevated {
            background: rgba(28, 32, 48, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-mid);
        }

        /* ── NOISE TEXTURE OVERLAY ── */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.035'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 9999;
            opacity: 0.4;
        }

        /* ══════════════════════════════════════════
           ANIMATIONS
        ══════════════════════════════════════════ */
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(16px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to   { opacity: 1; }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(100%); }
            to   { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideRight {
            from { opacity: 0; transform: translateX(-20px); }
            to   { opacity: 1; transform: translateX(0); }
        }
        @keyframes pulseDot {
            0%, 100% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 0 currentColor; }
            50% { transform: scale(1.3); opacity: 0.7; box-shadow: 0 0 6px 2px currentColor; }
        }
        @keyframes pulseRed {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.5); }
        }
        @keyframes toastIn {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to   { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes toastOut {
            from { opacity: 1; transform: translateY(0) scale(1); }
            to   { opacity: 0; transform: translateY(20px) scale(0.9); }
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes nowPlaying {
            0%, 100% { transform: scaleY(0.3); }
            50% { transform: scaleY(1); }
        }
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(31,214,112,0.3); }
            50%       { box-shadow: 0 0 0 8px rgba(31,214,112,0); }
        }
        @keyframes pulse-amber {
            0%, 100% { box-shadow: 0 0 0 0 rgba(240,180,41,0.3); }
            50%       { box-shadow: 0 0 0 8px rgba(240,180,41,0); }
        }

        .animate-fade-up   { animation: fadeUp 0.4s cubic-bezier(0.16,1,0.3,1) forwards; }
        .animate-fade-in   { animation: fadeIn 0.3s ease forwards; }
        .animate-slide-up  { animation: slideUp 0.4s cubic-bezier(0.16,1,0.3,1) forwards; }
        .animate-slide-right { animation: slideRight 0.3s cubic-bezier(0.16,1,0.3,1) forwards; }
        .animate-spin-slow { animation: spin 1s linear infinite; }
        .pulse-dot         { animation: pulseDot 1.5s ease-in-out infinite; }
        .pulse-red         { animation: pulseRed 0.8s ease-in-out infinite; }

        /* Stagger helpers */
        .stagger-1 { animation-delay: 0.05s; }
        .stagger-2 { animation-delay: 0.1s; }
        .stagger-3 { animation-delay: 0.15s; }
        .stagger-4 { animation-delay: 0.2s; }
        .stagger-5 { animation-delay: 0.25s; }

        /* ══════════════════════════════════════════
           LOADING SCREEN
        ══════════════════════════════════════════ */
        #loading-screen {
            background: var(--bg-base);
            position: fixed; inset: 0; z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px;
        }
        .loading-logo {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 3rem; font-weight: 900; font-style: italic;
            letter-spacing: -0.02em;
        }
        .loading-spinner {
            width: 32px; height: 32px;
            border: 2px solid var(--text-muted);
            border-top-color: var(--accent-red);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* ══════════════════════════════════════════
           REGISTRATION SCREEN
        ══════════════════════════════════════════ */
        #registration-screen {
            background: var(--bg-base);
            min-height: 100dvh;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 24px;
        }
        .reg-card {
            width: 100%; max-width: 420px;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 28px;
            padding: 40px 32px;
        }
        .reg-input {
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px 20px;
            color: var(--text-primary);
            font-family: 'Barlow', sans-serif;
            font-size: 16px; font-weight: 600;
            outline: none;
            transition: border-color 0.2s;
        }
        .reg-input:focus { border-color: var(--accent-red); }
        .reg-input::placeholder { color: var(--text-muted); }

        /* ══════════════════════════════════════════
           MENU SCREEN (Role selector)
        ══════════════════════════════════════════ */
        #menu-screen {
            background: var(--bg-base);
            min-height: 100dvh;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 32px 24px;
        }
        .menu-card {
            display: flex; align-items: center; gap: 16px;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 20px; padding: 20px 24px;
            cursor: pointer; transition: all 0.2s;
            width: 100%; max-width: 400px;
        }
        .menu-card:hover { background: var(--bg-elevated); border-color: var(--border-mid); transform: translateX(4px); }
        .menu-card:active { transform: scale(0.98); }
        .menu-icon {
            width: 48px; height: 48px;
            border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }

        /* ══════════════════════════════════════════
           TOAST SYSTEM
        ══════════════════════════════════════════ */
        #toast-container {
            position: fixed;
            bottom: 100px; left: 50%;
            transform: translateX(-50%);
            z-index: 9000;
            display: flex; flex-direction: column; gap: 8px;
            align-items: center;
            pointer-events: none;
            width: calc(100% - 32px); max-width: 400px;
        }
        .toast {
            padding: 14px 20px;
            border-radius: 14px;
            font-family: 'Barlow Condensed', sans-serif;
            font-weight: 700; font-size: 15px; letter-spacing: 0.02em;
            text-transform: uppercase;
            display: flex; align-items: center; gap: 10px;
            width: 100%;
            pointer-events: auto;
            animation: toastIn 0.35s cubic-bezier(0.16,1,0.3,1) forwards;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }
        .toast.removing { animation: toastOut 0.3s ease forwards; }
        .toast-success { background: rgba(31,214,112,0.15); border: 1px solid rgba(31,214,112,0.3); color: #1fd670; }
        .toast-error   { background: rgba(232,54,42,0.15);  border: 1px solid rgba(232,54,42,0.3);  color: #e8362a; }
        .toast-info    { background: rgba(91,110,245,0.15); border: 1px solid rgba(91,110,245,0.3); color: #8b9cf5; }
        .toast-warning { background: rgba(240,180,41,0.15); border: 1px solid rgba(240,180,41,0.3); color: #f0b429; }

        /* ══════════════════════════════════════════
           ████ CLIENT VIEW — MOBILE FIRST ████
        ══════════════════════════════════════════ */
        #client-app {
            height: 100dvh;
            display: flex; flex-direction: column;
            background: var(--bg-base);
            overflow: hidden;
        }

        /* Client Top Bar */
        .client-topbar {
            height: 56px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px;
            background: var(--bg-base);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }
        .client-logo {
            font-family: 'Barlow Condensed', sans-serif;
            font-weight: 900; font-style: italic;
            font-size: 1.4rem; letter-spacing: -0.01em;
        }

        /* Client Content Area */
        .client-content {
            flex: 1; overflow-y: auto; overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        /* Now Playing Hero */
        .now-playing-hero {
            padding: 20px 16px;
        }
        .now-playing-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(232,54,42,0.08) 100%);
            border: 2px solid rgba(232,54,42,0.25);
            border-radius: 20px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        .now-playing-card::before {
            content: '';
            position: absolute; inset: 0;
            background: linear-gradient(135deg, transparent 60%, rgba(232,54,42,0.05));
            pointer-events: none;
        }
        .np-thumb {
            width: 72px; height: 54px;
            object-fit: cover; border-radius: 10px;
            flex-shrink: 0;
        }
        .np-thumb-placeholder {
            width: 88px; height: 66px;
            background: var(--bg-elevated);
            border-radius: 12px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
        }
        .np-thumb-placeholder svg {
            width: 28px;
            height: 28px;
        }
        .eq-bars {
            display: flex; align-items: flex-end; gap: 2px; height: 18px;
        }
        .eq-bar {
            width: 3px; background: var(--accent-red); border-radius: 2px;
        }
        .eq-bar:nth-child(1) { animation: nowPlaying 0.8s ease-in-out infinite; animation-delay: 0s; }
        .eq-bar:nth-child(2) { animation: nowPlaying 0.8s ease-in-out infinite; animation-delay: 0.15s; }
        .eq-bar:nth-child(3) { animation: nowPlaying 0.8s ease-in-out infinite; animation-delay: 0.3s; }
        .eq-bar:nth-child(4) { animation: nowPlaying 0.8s ease-in-out infinite; animation-delay: 0.1s; }

        /* Queue list — streaming style */
        .queue-section { padding: 0 16px 8px; }
        .queue-header {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 0.8rem; font-weight: 800;
            letter-spacing: 0.12em; text-transform: uppercase;
            color: var(--text-primary);
            padding: 12px 4px;
            background: linear-gradient(135deg, rgba(232,54,42,0.08) 0%, transparent 100%);
            margin: 8px -16px 0;
            padding-left: 20px;
        }
        .queue-item {
            display: flex; align-items: center; gap: 14px;
            padding: 14px 14px;
            border-radius: 14px;
            transition: background 0.15s;
            cursor: pointer;
            animation: fadeUp 0.3s ease forwards;
            opacity: 0;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .queue-item:active { background: var(--bg-card); }
        .queue-rank {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 0.75rem; font-weight: 700;
            color: var(--text-muted);
            width: 20px; text-align: center;
            flex-shrink: 0;
        }
        .queue-thumb {
            width: 62px; height: 46px;
            object-fit: cover; border-radius: 10px;
            flex-shrink: 0;
        }
        .queue-info { flex: 1; min-width: 0; }
        .queue-title {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.05rem; font-weight: 800; font-style: italic;
            color: var(--text-primary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            line-height: 1.2;
        }
        .queue-meta {
            font-size: 0.73rem; font-weight: 700;
            color: var(--text-muted); letter-spacing: 0.08em;
            text-transform: uppercase; margin-top: 3px;
        }
        .vote-btn {
            background: var(--bg-elevated);
            border: 1.5px solid var(--border);
            border-radius: 11px;
            padding: 8px 12px;
            display: flex; align-items: center; gap: 5px;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 0.88rem; font-weight: 800;
            color: var(--text-secondary);
            cursor: pointer; transition: all 0.15s;
            flex-shrink: 0;
        }
        .vote-btn:active { background: rgba(232,54,42,0.2); border-color: rgba(232,54,42,0.4); color: var(--accent-red); transform: scale(0.95); }

        /* Wait info pill */
        .wait-pill {
            display: inline-flex; align-items: center; gap: 6px;
            background: rgba(91,110,245,0.12);
            border: 1px solid rgba(91,110,245,0.25);
            border-radius: 100px; padding: 6px 14px;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 0.75rem; font-weight: 700;
            color: #8b9cf5; letter-spacing: 0.05em; text-transform: uppercase;
        }

        /* Client Bottom Nav */
        .client-bottom-nav {
            height: 72px;
            background: var(--bg-surface);
            border-top: 1px solid var(--border);
            display: flex; align-items: stretch;
            flex-shrink: 0;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-tab {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            gap: 4px; cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .nav-tab-label {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 0.6rem; font-weight: 700;
            letter-spacing: 0.08em; text-transform: uppercase;
            color: var(--text-muted);
            transition: color 0.2s;
        }
        .nav-tab-icon {
            color: var(--text-muted);
            transition: color 0.2s;
        }
        .nav-tab.active .nav-tab-label,
        .nav-tab.active .nav-tab-icon { color: var(--accent-red); }
        .nav-tab.active::before {
            content: '';
            position: absolute; top: 0; left: 50%;
            transform: translateX(-50%);
            width: 32px; height: 2px;
            background: var(--accent-red);
            border-radius: 0 0 2px 2px;
        }
        /* Center tab — CTA */
        .nav-tab-cta {
            background: var(--accent-red);
            width: 52px; height: 52px;
            border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 20px rgba(232,54,42,0.4);
            transition: all 0.2s;
            margin-bottom: 4px;
        }
        .nav-tab-cta:active { transform: scale(0.92); box-shadow: 0 2px 10px rgba(232,54,42,0.3); }

        /* Tab content panels */
        .client-tab-panel { display: none; height: 100%; overflow-y: auto; }
        .client-tab-panel.active { display: block; }

        /* Service panel */
        .service-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 14px; padding: 16px;
        }
        .service-card {
            background: var(--bg-card);
            border: 1.5px solid var(--border);
            border-radius: 22px;
            padding: 32px 22px;
            display: flex; flex-direction: column; align-items: center; gap: 12px;
            cursor: pointer; transition: all 0.2s;
            text-align: center;
        }
        .service-card:active { transform: scale(0.96); }
        .service-card-icon {
            width: 68px; height: 68px; border-radius: 18px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0;
        }
        .service-card-label {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.1rem; font-weight: 800;
            letter-spacing: 0.06em; text-transform: uppercase;
            color: var(--text-primary);
        }
        .service-card-sub {
            font-size: 0.82rem; color: var(--text-muted);
            font-weight: 700; letter-spacing: 0.04em;
        }
        /* CAMBIO 5C: Colores activos por card */
        .service-card:nth-child(1):active { border-color: rgba(31,214,112,0.3); }
        .service-card:nth-child(2):active { border-color: rgba(240,180,41,0.3); }
        .service-card:nth-child(3):active { border-color: rgba(232,54,42,0.3); }
        .service-card:nth-child(4):active { border-color: rgba(91,110,245,0.3); }

        /* Status indicators */
        .status-bubble {
            position: absolute; top: 6px; right: 6px;
            width: 8px; height: 8px;
            border-radius: 50%;
        }

        /* ══════════════════════════════════════════
           ████ STAFF SAAS LAYOUT ████
        ══════════════════════════════════════════ */
        #staff-app {
            height: 100dvh;
            display: flex;
            background: var(--bg-base);
            overflow: hidden;
        }

        /* ── SIDEBAR ── */
        .sidebar {
            width: var(--sidebar-w);
            background: var(--bg-surface);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
            flex-shrink: 0;
            transition: width 0.25s cubic-bezier(0.4,0,0.2,1);
            overflow: hidden;
            position: relative;
            z-index: 50;
        }
        .sidebar.collapsed { width: var(--sidebar-w-collapsed); }

        .sidebar-header {
            height: 64px;
            display: flex; align-items: center;
            padding: 0 16px;
            border-bottom: 1px solid var(--border-mid);
            flex-shrink: 0;
            overflow: hidden;
        }
        .sidebar-logo-text {
            font-family: 'Barlow Condensed', sans-serif;
            font-weight: 900; font-style: italic;
            font-size: 1.2rem; letter-spacing: -0.01em;
            white-space: nowrap; overflow: hidden;
            transition: opacity 0.2s, max-width 0.25s;
            max-width: 160px;
        }
        .sidebar.collapsed .sidebar-logo-text { max-width: 0; opacity: 0; }

        .sidebar-toggle {
            margin-left: auto; flex-shrink: 0;
            width: 32px; height: 32px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        .sidebar-toggle:hover { background: var(--bg-elevated); color: var(--text-primary); }

        /* Sidebar nav section */
        .sidebar-nav { flex: 1; overflow-y: auto; padding: 12px 8px; display: flex; flex-direction: column; gap: 2px; }

        .sidebar-section-label {
            font-family: 'Barlow', sans-serif;
            font-size: 0.62rem;
            font-weight: 700;
            letter-spacing: 0.14em;
            text-transform: uppercase;
            color: var(--text-muted);
            padding: 12px 10px 6px;
            white-space: nowrap; overflow: hidden;
            transition: opacity 0.2s;
            opacity: 0.6;
        }
        .sidebar.collapsed .sidebar-section-label { opacity: 0; }

        .sidebar-item {
            display: flex; align-items: center; gap: 12px;
            padding: 10px 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap; overflow: hidden;
            position: relative;
        }
        .sidebar-item:hover { background: var(--bg-elevated); }
        .sidebar-item.active {
            background: rgba(232,54,42,0.12);
            border: 1px solid rgba(232,54,42,0.2);
        }
        .sidebar-item-icon {
            width: 20px; height: 20px; flex-shrink: 0;
            color: var(--text-secondary);
            transition: color 0.15s;
        }
        .sidebar-item.active .sidebar-item-icon { color: var(--accent-red); }
        .sidebar-item-label {
            font-family: 'Barlow', sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.04em;
            text-transform: none;
            color: var(--text-secondary);
            overflow: hidden; text-overflow: ellipsis;
            transition: opacity 0.2s, color 0.15s;
        }
        .sidebar-item.active .sidebar-item-label { color: var(--text-primary); }
        .sidebar.collapsed .sidebar-item-label { opacity: 0; }

        /* Badge */
        .sidebar-badge {
            margin-left: auto; flex-shrink: 0;
            background: var(--accent-red);
            color: white;
            font-size: 0.6rem; font-weight: 700;
            border-radius: 100px; padding: 2px 6px;
            min-width: 18px; text-align: center;
            transition: opacity 0.2s;
        }
        .sidebar.collapsed .sidebar-badge { opacity: 0; }

        /* Sidebar footer */
        .sidebar-footer {
            padding: 12px 8px;
            border-top: 1px solid var(--border);
        }
        .sidebar-status {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 10px;
            border-radius: 10px;
            overflow: hidden;
        }
        .status-dot {
            width: 7px; height: 7px; border-radius: 50%;
            flex-shrink: 0;
        }
        .status-dot.online { background: var(--accent-green); animation: pulseDot 2s ease-in-out infinite; }
        .status-dot.offline { background: var(--accent-red); }
        .sidebar-status-text {
            font-size: 0.7rem; font-weight: 600;
            color: var(--text-muted);
            white-space: nowrap; overflow: hidden;
            transition: opacity 0.2s;
        }
        .sidebar.collapsed .sidebar-status-text { opacity: 0; }

        /* ── STAFF MAIN AREA ── */
        .staff-main {
            flex: 1; display: flex; flex-direction: column;
            overflow: hidden; min-width: 0;
        }

        /* Staff Topbar */
        .staff-topbar {
            height: 60px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 24px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border-mid);
            flex-shrink: 0;
        }
        .staff-page-title {
            font-family: 'Barlow', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--text-primary);
        }
        .staff-topbar-right {
            display: flex; align-items: center; gap: 12px;
        }
        .role-chip {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            color: var(--text-primary);
            font-family: 'Barlow', sans-serif;
            font-size: 0.65rem; font-weight: 700;
            letter-spacing: 0.12em; text-transform: uppercase;
            padding: 5px 12px; border-radius: 100px;
        }

        /* Staff Content */
        .staff-content {
            flex: 1; overflow-y: auto; overflow-x: hidden;
            padding: 24px;
            display: flex; flex-direction: column; gap: 20px;
        }

        /* Staff View Panels */
        .staff-panel { display: none; }
        .staff-panel.active { display: flex; flex-direction: column; gap: 20px; }

        /* ── STATS ROW ── */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
        }
        .stat-label {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 0.7rem; font-weight: 800;
            letter-spacing: 0.12em; text-transform: uppercase;
            color: var(--text-muted); margin-bottom: 8px;
            opacity: 0.9;
        }
        .stat-value {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 3rem; font-weight: 900;
            line-height: 1; letter-spacing: -0.02em;
            color: var(--text-primary);
        }
        .stat-sub {
            font-size: 0.75rem; color: var(--text-muted);
            font-weight: 700; margin-top: 6px;
            letter-spacing: 0.06em; text-transform: uppercase;
        }

        /* ── STAFF CONTENT CARDS ── */
        .content-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 24px;
        }
        .content-card-title {
            font-family: 'Barlow', sans-serif;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.14em;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        /* ── WAITER CALL CARDS ── */
        .call-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 16px; padding: 16px;
            display: flex; flex-direction: column; gap: 12px;
            animation: fadeUp 0.3s ease forwards;
        }
        .call-card.bill-type { border-color: rgba(240,180,41,0.2); background: rgba(240,180,41,0.04); }
        .call-card-header { display: flex; align-items: flex-start; justify-content: space-between; }
        .call-table {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 2rem; font-weight: 900; font-style: italic;
            line-height: 1; letter-spacing: -0.02em;
        }
        .call-type-label {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 0.65rem; font-weight: 700;
            letter-spacing: 0.08em; text-transform: uppercase;
            color: var(--text-muted); margin-top: 2px;
        }
        .call-status-badge {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 0.72rem; font-weight: 700;
            letter-spacing: 0.08em; text-transform: uppercase;
            padding: 5px 12px; border-radius: 100px;
        }
        .badge-waiting { background: rgba(232,54,42,0.15); color: var(--accent-red); border: 1px solid rgba(232,54,42,0.3); font-weight: 800; }
        .badge-onway   { background: rgba(91,110,245,0.15); color: #8b9cf5; border: 1px solid rgba(91,110,245,0.3); }

        .calls-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 12px; }

        /* History table */
        .history-table { width: 100%; border-collapse: collapse; }
        .history-table th {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 0.65rem; font-weight: 700;
            letter-spacing: 0.1em; text-transform: uppercase;
            color: var(--text-muted); padding: 8px 12px; text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .history-table td {
            padding: 12px 12px;
            font-size: 0.85rem; font-weight: 600;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
        }
        .history-table tr:last-child td { border-bottom: none; }
        .history-table tr:hover td { color: var(--text-primary); background: rgba(255,255,255,0.02); }

        /* ── DJ VIEW ── */
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 16px; background: black; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

        .sampler-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .sampler-btn {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px; padding: 16px 8px;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 0.85rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.03em;
            color: var(--text-secondary);
            cursor: pointer; transition: all 0.15s;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
        }
        .sampler-btn:active { background: rgba(232,54,42,0.15); border-color: rgba(232,54,42,0.3); color: var(--accent-red); transform: scale(0.96); }

        .transport-bar {
            display: flex; align-items: center; gap: 8px;
        }

        /* ── DJ PANEL ── */
        .dj-panel {
            display: flex;
            flex-direction: column;
            gap: 1px;
            border: 1px solid var(--border-mid);
            border-radius: 20px;
            overflow: hidden;
            background: var(--border);
        }
        .dj-section {
            background: var(--bg-elevated);
            padding: 20px 24px;
        }
        .dj-section-label {
            font-size: 0.6rem;
            font-weight: 700;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 12px;
        }
        /* Now playing */
        .dj-now-playing {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .dj-song-title {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.5rem;
            font-weight: 900;
            font-style: italic;
            letter-spacing: 0.01em;
            color: var(--text-primary);
            line-height: 1.1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .dj-song-meta {
            font-size: 0.72rem;
            font-weight: 600;
            letter-spacing: 0.06em;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        .dj-progress-bar {
            width: 100%;
            height: 3px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
        }
        .dj-progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--accent-red), #ff6b5b);
            border-radius: 4px;
            transition: width 1s linear;
        }
        /* Transport */
        .dj-transport {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .dj-btn {
            width: 44px; height: 44px;
            background: var(--bg-card);
            border: 1px solid var(--border-mid);
            border-radius: 50%;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.12s cubic-bezier(0.34, 1.56, 0.64, 1);
            flex-shrink: 0;
            position: relative;
        }
        .dj-btn:hover { background: var(--bg-card); color: var(--text-primary); border-color: rgba(255,255,255,0.25); transform: scale(1.1); }
        .dj-btn:active { transform: scale(0.9); }
        .dj-btn-play {
            width: 60px; height: 60px;
            background: #1fd670;
            border: none;
            box-shadow: 0 0 24px rgba(31,214,112,0.35);
        }
        .dj-btn-play:hover { background: #22e878; transform: scale(1.08); box-shadow: 0 0 32px rgba(31,214,112,0.5); border: none; }
        .dj-btn-pause {
            width: 60px; height: 60px;
            background: var(--accent-red);
            border: none;
            box-shadow: 0 0 24px rgba(232,54,42,0.35);
        }
        .dj-btn-pause:hover { background: #f03d31; transform: scale(1.08); box-shadow: 0 0 32px rgba(232,54,42,0.5); border: none; }
        .dj-btn-skip {
            background: rgba(232,54,42,0.1);
            border-color: rgba(232,54,42,0.25);
            color: var(--accent-red);
        }
        .dj-btn-skip:hover { background: rgba(232,54,42,0.2); border-color: rgba(232,54,42,0.4); color: var(--accent-red); }
        /* Volume */
        .dj-vol-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .dj-vol-label {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-muted);
            min-width: 30px;
            text-align: right;
            letter-spacing: 0.05em;
        }
        .dj-vol-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 3px;
            background: var(--border-mid);
            border-radius: 4px;
            outline: none;
            cursor: pointer;
        }
        .dj-vol-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px; height: 14px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
            cursor: pointer;
            transition: transform 0.1s;
        }
        .dj-vol-slider::-webkit-slider-thumb:hover { transform: scale(1.3); }
        /* Dedication card */
        .dj-dedication-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .dj-dedication-text {
            font-size: 0.95rem;
            font-weight: 700;
            font-style: italic;
            color: var(--text-primary);
            line-height: 1.4;
        }
        .dj-dedication-from {
            font-size: 0.68rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--text-muted);
        }
        .dj-dedication-empty {
            font-size: 0.78rem;
            font-weight: 600;
            color: var(--text-muted);
            text-align: center;
            padding: 8px 0;
        }
        .dj-action-btn {
            flex: 1;
            height: 42px;
            background: var(--bg-card);
            border: 1px solid var(--border-mid);
            border-radius: 12px;
            color: var(--text-secondary);
            font-family: 'Barlow', sans-serif;
            font-size: 0.72rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .dj-action-btn:hover { background: var(--bg-elevated); color: var(--text-primary); border-color: rgba(255,255,255,0.2); }
        .dj-action-btn:active { transform: scale(0.97); }
        .dj-action-btn.active {
            background: rgba(91,110,245,0.15);
            border-color: rgba(91,110,245,0.4);
            color: var(--accent-indigo);
        }
        .dj-action-btn.tv-active {
            background: rgba(31,214,112,0.1);
            border-color: rgba(31,214,112,0.3);
            color: var(--accent-green);
        }
        /* Banner upload */
        .dj-banner-upload {
            border: 1.5px dashed var(--border-mid);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        .dj-banner-upload:hover { border-color: var(--accent-indigo); background: rgba(91,110,245,0.05); }
        .dj-banner-upload input { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; }
        .dj-banner-preview {
            width: 100%;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            display: none;
            margin-bottom: 8px;
        }

        /* ── ANALYTICS VIEW ── */
        .period-tabs {
            display: flex; gap: 6px; flex-wrap: wrap;
        }
        .period-tab {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 0.75rem; font-weight: 700;
            letter-spacing: 0.06em; text-transform: uppercase;
            padding: 7px 14px; border-radius: 10px;
            cursor: pointer; transition: all 0.15s;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }
        .period-tab.active {
            background: rgba(139,92,246,0.15);
            border-color: rgba(139,92,246,0.3);
            color: #a78bfa;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }
        .kpi-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px; padding: 20px 16px;
            text-align: center;
        }
        .kpi-label {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 0.7rem; font-weight: 700;
            letter-spacing: 0.08em; text-transform: uppercase;
            margin-bottom: 8px;
        }
        .kpi-value {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 2.8rem; font-weight: 900;
            line-height: 1; letter-spacing: -0.02em;
        }
        .kpi-unit {
            font-size: 0.65rem; color: var(--text-muted);
            font-weight: 600; margin-top: 4px;
            letter-spacing: 0.05em; text-transform: uppercase;
        }

        /* ══════════════════════════════════════════
           MODALS
        ══════════════════════════════════════════ */
        .modal-overlay {
            position: fixed; inset: 0; z-index: 500;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: flex; align-items: flex-end; justify-content: center;
            padding: 0;
        }
        .modal-overlay.center { align-items: center; padding: 16px; }

        .modal-sheet {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 24px 24px 0 0;
            width: 100%; max-width: 520px;
            max-height: 92dvh;
            display: flex; flex-direction: column;
            animation: slideUp 0.35s cubic-bezier(0.16,1,0.3,1);
            overflow: hidden;
        }
        .modal-sheet.is-center {
            border-radius: 24px;
            max-height: 90dvh;
        }
        .modal-handle {
            width: 36px; height: 4px; border-radius: 2px;
            background: var(--text-muted);
            margin: 12px auto 0;
            flex-shrink: 0;
        }
        .modal-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .modal-title {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.1rem; font-weight: 900; font-style: italic;
            letter-spacing: 0.02em; text-transform: uppercase;
        }
        .modal-close {
            width: 36px; height: 36px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            color: var(--text-primary);
            background: var(--bg-elevated);
            border: 1px solid var(--border-mid);
            transition: all 0.15s;
        }
        .modal-close:hover { background: rgba(232,54,42,0.15); border-color: rgba(232,54,42,0.3); color: var(--accent-red); }
        .modal-body { flex: 1; overflow-y: auto; padding: 20px; }
        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            flex-shrink: 0;
        }

        /* Search modal specifics */
        .search-type-toggle {
            display: flex; background: var(--bg-elevated);
            border-radius: 10px; padding: 3px; gap: 2px;
        }
        .search-type-btn {
            flex: 1; padding: 8px;
            border-radius: 8px;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 0.75rem; font-weight: 700;
            letter-spacing: 0.05em; text-transform: uppercase;
            color: var(--text-muted);
            cursor: pointer; transition: all 0.2s;
        }
        .search-type-btn.active { background: var(--accent-red); color: white; }

        .search-input-wrapper {
            position: relative;
        }
        .search-input {
            width: 100%;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 16px 14px 44px;
            color: var(--text-primary);
            font-family: 'Barlow', sans-serif;
            font-size: 16px; font-weight: 600;
            outline: none; transition: border-color 0.2s;
        }
        .search-input:focus { border-color: rgba(232,54,42,0.5); }
        .search-input::placeholder { color: var(--text-muted); }
        .search-icon {
            position: absolute; left: 14px; top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted); pointer-events: none;
        }

        .search-result-item {
            display: flex; align-items: center; gap: 14px;
            padding: 14px 14px;
            border-radius: 14px;
            cursor: pointer; transition: background 0.15s;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .search-result-item:hover, .search-result-item:active { background: var(--bg-elevated); }
        .search-result-thumb {
            width: 72px; height: 54px;
            object-fit: cover; border-radius: 10px; flex-shrink: 0;
        }
        .search-result-title {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.05rem; font-weight: 800; font-style: italic;
            color: var(--text-primary);
            overflow: hidden; text-overflow: ellipsis;
            white-space: nowrap;
        }
        .search-result-meta { font-size: 0.75rem; color: var(--text-muted); font-weight: 700; }

        /* Confirmation panel inside search */
        .confirm-panel {
            background: rgba(232,54,42,0.06);
            border: 1px solid rgba(232,54,42,0.15);
            border-radius: 14px; padding: 16px;
        }
        .confirm-song-name {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.1rem; font-weight: 700; font-style: italic;
            color: var(--text-primary); letter-spacing: -0.01em;
        }

        /* Bill modal */
        .payment-option {
            flex: 1; padding: 16px;
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            border-radius: 14px;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 0.85rem; font-weight: 700;
            letter-spacing: 0.05em; text-transform: uppercase;
            color: var(--text-secondary);
            cursor: pointer; transition: all 0.2s;
            text-align: center;
        }
        .payment-option.selected { border-color: var(--accent-amber); background: rgba(240,180,41,0.1); color: var(--accent-amber); }

        .satisfaction-row { display: flex; justify-content: space-between; align-items: center; padding: 0 8px; }
        .sat-btn { font-size: 2rem; cursor: pointer; transition: all 0.2s; filter: grayscale(1) opacity(0.4); }
        .sat-btn.active { filter: grayscale(0) opacity(1); transform: scale(1.3); }

        /* Table input modal */
        .table-input {
            width: 100%; background: var(--bg-elevated);
            border: 1px solid var(--border); border-radius: 14px;
            padding: 24px; text-align: center;
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 4rem; font-weight: 900;
            color: var(--accent-green); outline: none;
            transition: border-color 0.2s;
        }
        .table-input:focus { border-color: var(--accent-green); }

        /* ══════════════════════════════════════════
           BTN SYSTEM
        ══════════════════════════════════════════ */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            border-radius: 10px; padding: 12px 20px;
            font-family: 'Barlow', sans-serif;
            font-size: 0.8rem; font-weight: 700;
            letter-spacing: 0.08em; text-transform: uppercase;
            cursor: pointer; transition: all 0.15s;
            border: 1px solid transparent;
            white-space: nowrap;
        }
        .btn:active { transform: scale(0.97); }
        .btn-primary {
            background: var(--accent-red);
            color: white;
            box-shadow: 0 2px 12px rgba(232,54,42,0.35), inset 0 1px 0 rgba(255,255,255,0.1);
        }
        .btn-primary:hover { background: #d42d22; box-shadow: 0 4px 20px rgba(232,54,42,0.45); }
        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border-color: var(--border-mid);
        }
        .btn-secondary:hover { background: #252a3a; border-color: rgba(255,255,255,0.2); }
        .btn-success {
            background: #17a85a;
            color: white;
            box-shadow: 0 2px 12px rgba(23,168,90,0.3);
        }
        .btn-success:hover { background: #14964f; }
        .btn-amber {
            background: #c9960f;
            color: white;
            box-shadow: 0 2px 12px rgba(201,150,15,0.3);
        }
        .btn-amber:hover { background: #b5860e; }
        .btn-indigo {
            background: var(--accent-indigo);
            color: white;
            box-shadow: 0 2px 12px rgba(91,110,245,0.3);
        }
        .btn-indigo:hover { background: #4a5ce0; }
        .btn-ghost { background: transparent; color: var(--text-secondary); border-color: var(--border); }
        .btn-ghost:hover { color: var(--text-primary); background: var(--bg-elevated); }
        .btn-full { width: 100%; }
        .btn-lg { padding: 15px 24px; font-size: 0.85rem; border-radius: 12px; }

        /* ══════════════════════════════════════════
           TV / DISPLAY SCREEN
        ══════════════════════════════════════════ */
        #display-screen {
            position: fixed; inset: 0;
            background: black; z-index: 200;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 48px;
            text-align: center;
            cursor: none;
        }
        #display-screen .video-container {
            border: 8px solid rgba(255,255,255,0.04);
            border-radius: 24px;
        }
        .tv-dedication {
            position: absolute; top: 40px; left: 50%;
            transform: translateX(-50%);
            background: rgba(15,17,23,0.95);
            border: 1px solid var(--border-mid);
            backdrop-filter: blur(20px);
            border-radius: 20px; padding: 24px 32px;
            max-width: 600px; width: 90%;
            animation: slideUp 0.6s cubic-bezier(0.16,1,0.3,1);
        }

        /* ══════════════════════════════════════════
           UTILITIES
        ══════════════════════════════════════════ */
        .hidden { display: none !important; }
        .text-red   { color: var(--accent-red); }
        .text-green { color: var(--accent-green); }
        .text-amber { color: var(--accent-amber); }
        .text-indigo{ color: var(--accent-indigo); }
        .text-purple{ color: var(--accent-purple); }
        .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Shimmer skeleton */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-card) 25%, var(--bg-elevated) 50%, var(--bg-card) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        /* ══════════════════════════════════════════
           RESPONSIVE — STAFF SIDEBAR on mobile
        ══════════════════════════════════════════ */
        @media (max-width: 768px) {
            :root { --sidebar-w: 200px; }
            .staff-content { padding: 16px; }
            .staff-topbar { padding: 0 16px; }
            .sampler-grid { grid-template-columns: repeat(2, 1fr); }
            .stats-grid   { grid-template-columns: repeat(2, 1fr); }
        }

        /* ADMIN VERSION - hide client screens */
        #client-app { display: none !important; }
        #menu-screen { display: none !important; }
        #registration-screen { display: none !important; }
    </style>
</head>
<body>

<!-- Script para mostrar login de admin inmediatamente si role=admin -->
<script>
    // Mostrar login admin al cargar la página (solo si no es modo display)
    window.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const urlMode = urlParams.get('mode');
        const isDisplayMode = urlMode === 'display';
        
        const loading = document.getElementById('loading-screen');
        const login = document.getElementById('admin-login-screen');
        
        if (loading) loading.classList.add('hidden');
        
        // Solo mostrar login si NO estamos en modo display
        if (!isDisplayMode) {
            if (login) login.classList.remove('hidden');
        }
        
        // Cargar logo en sidebar
        const sidebarLogoContainer = document.getElementById('sidebar-logo-container');
        if (sidebarLogoContainer) {
            sidebarLogoContainer.innerHTML = '<img src="/logo.png" style="max-height:32px;width:auto;object-fit:contain;" alt="Logo">';
        }
    });

    function updateDedicationCard() {
        const emptyEl  = document.getElementById('dj-dedication-empty');
        const bodyEl   = document.getElementById('dj-dedication-body');
        const textEl   = document.getElementById('dj-dedication-text');
        const fromEl   = document.getElementById('dj-dedication-from');
        const metaEl   = document.getElementById('dj-song-meta');
        const btn      = document.getElementById('toggle-dedication-btn');
        if (!emptyEl || !bodyEl) return;
        const hasDedic = currentTrack && currentTrack.dedication && currentTrack.dedication.trim();
        if (hasDedic) {
            emptyEl.style.display = 'none';
            bodyEl.style.display  = 'block';
            if (textEl) textEl.innerText = currentTrack.dedication;
            if (fromEl) fromEl.innerText = currentTrack.showName && currentTrack.userName ? 'De: ' + currentTrack.userName : '';
        } else {
            emptyEl.style.display = 'block';
            bodyEl.style.display  = 'none';
        }
        if (btn) {
            const active = currentTrack && !!currentTrack.showDedication;
            btn.style.background  = active ? 'rgba(91,110,245,0.2)' : '';
            btn.style.borderColor = active ? 'rgba(91,110,245,0.5)' : '';
            btn.style.color       = active ? 'var(--accent-indigo)' : '';
        }
        if (metaEl) {
            const parts = [];
            if (currentTrack && currentTrack.isKaraoke) parts.push('Karaoke');
            if (currentTrack && currentTrack.showName && currentTrack.userName) parts.push(currentTrack.userName);
            metaEl.innerText = parts.join(' · ') || '—';
        }
    }

    let dragSrcId = null;
    function renderDJPanelQueue() {
        const container = document.getElementById('dj-panel-queue');
        if (!container) return;
        const pending = queue;
        if (!currentTrack && !pending.length) {
            container.innerHTML = '<div style="font-size:0.78rem;font-weight:600;color:var(--text-muted);text-align:center;padding:14px 0;">Cola vacía</div>';
            return;
        }
        container.innerHTML = '';
        if (currentTrack) {
            const row = document.createElement('div');
            row.style.cssText = 'display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(31,214,112,0.08);border:1px solid rgba(31,214,112,0.25);border-radius:12px;margin-bottom:5px;';
            row.innerHTML = `
                <div style="width:20px;font-size:0.7rem;font-weight:800;color:var(--accent-green);text-align:center;">▶</div>
                <div style="flex:1;min-width:0;">
                    <div style="font-size:0.82rem;font-weight:700;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${currentTrack.title || 'Sin título'}</div>
                    <div style="font-size:0.62rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-top:1px;">${currentTrack.showName && currentTrack.userName ? currentTrack.userName : 'Anónimo'} · ${currentTrack.votes || 0} votos</div>
                </div>
                <button onclick="skipSong()" style="width:28px;height:28px;background:rgba(232,54,42,0.1);border:1px solid rgba(232,54,42,0.25);border-radius:8px;color:var(--accent-red);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><polygon points="5,4 13,12 5,20"/><rect x="15" y="4" width="3" height="16" rx="1"/></svg>
                </button>`;
            container.appendChild(row);
        }
        pending.forEach((s, i) => {
            const row = document.createElement('div');
            row.setAttribute('draggable', 'true');
            row.setAttribute('data-id', s.id);
            row.style.cssText = 'display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;cursor:grab;transition:all 0.15s;margin-bottom:5px;';
            row.innerHTML = `
                <div style="width:20px;font-size:0.65rem;font-weight:700;color:var(--text-muted);text-align:center;">${i + 1}</div>
                <div style="flex:1;min-width:0;">
                    <div style="font-size:0.82rem;font-weight:700;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${s.title || 'Sin título'}</div>
                    <div style="font-size:0.62rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-top:1px;">${s.showName && s.userName ? s.userName : 'Anónimo'} · ${s.votes || 0} votos</div>
                </div>
                <div style="display:flex;gap:4px;flex-shrink:0;">
                    ${i > 0 ? `<button onclick="moveQueueItem('${s.id}',-1)" style="width:26px;height:26px;background:var(--bg-elevated);border:1px solid var(--border-mid);border-radius:7px;color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="18,15 12,9 6,15"/></svg></button>` : '<div style="width:26px;"></div>'}
                    ${i < pending.length - 1 ? `<button onclick="moveQueueItem('${s.id}',1)" style="width:26px;height:26px;background:var(--bg-elevated);border:1px solid var(--border-mid);border-radius:7px;color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6,9 12,15 18,9"/></svg></button>` : '<div style="width:26px;"></div>'}
                    <button onclick="removeQueueItem('${s.id}')" style="width:26px;height:26px;background:rgba(232,54,42,0.08);border:1px solid rgba(232,54,42,0.2);border-radius:7px;color:var(--accent-red);cursor:pointer;display:flex;align-items:center;justify-content:center;"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                </div>`;
            row.addEventListener('dragstart', e => { dragSrcId = s.id; row.style.opacity='0.4'; e.dataTransfer.effectAllowed='move'; });
            row.addEventListener('dragend',   () => { row.style.opacity='1'; });
            row.addEventListener('dragover',  e => { e.preventDefault(); row.style.borderColor='var(--accent-indigo)'; });
            row.addEventListener('dragleave', () => { row.style.borderColor='var(--border)'; });
            row.addEventListener('drop', async e => {
                e.preventDefault(); row.style.borderColor='var(--border)';
                if (dragSrcId === s.id) return;
                const src = queue.find(x => x.id === dragSrcId);
                if (!src) return;
                await db.collection(`artifacts/${appId}/public/data/rocola_queue`).doc(src.id).update({ createdAt: s.createdAt });
                await db.collection(`artifacts/${appId}/public/data/rocola_queue`).doc(s.id).update({ createdAt: src.createdAt });
            });
            container.appendChild(row);
        });
        if (queue.length > 5) {
            const more = document.createElement('div');
            more.style.cssText = 'font-size:0.65rem;font-weight:600;color:var(--text-muted);text-align:center;padding:6px 0;';
            more.innerText = '+' + (queue.length - 5) + ' más en cola';
            container.appendChild(more);
        }
    }
    async function moveQueueItem(id, direction) {
        const idx = queue.findIndex(s => s.id === id);
        const targetIdx = idx + direction;
        if (targetIdx < 0 || targetIdx >= queue.length) return;
        const a = queue[idx], b = queue[targetIdx];
        await db.collection(`artifacts/${appId}/public/data/rocola_queue`).doc(a.id).update({ createdAt: b.createdAt });
        await db.collection(`artifacts/${appId}/public/data/rocola_queue`).doc(b.id).update({ createdAt: a.createdAt });
    }
    async function removeQueueItem(id) {
        await db.collection(`artifacts/${appId}/public/data/rocola_queue`).doc(id).delete();
    }
</script>

<!-- ═══════════════════════════════════════
     TOAST CONTAINER
═══════════════════════════════════════ -->
<div id="toast-container"></div>

<!-- ═══════════════════════════════════════
     LOADING SCREEN
═══════════════════════════════════════ -->
<div id="loading-screen">
    <div class="loading-logo"></div>
    <div class="loading-spinner"></div>
    <p id="sync-text" style="font-size:0.65rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-muted);margin-top:8px;">Sincronizando...</p>
    <noscript><p style="color:var(--accent-red);font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;">JavaScript desactivado.</p></noscript>
</div>

<!-- ═══════════════════════════════════════
     REGISTRATION SCREEN
═══════════════════════════════════════ -->
<div id="registration-screen" class="hidden">
    <div class="reg-card animate-fade-up">
        <div id="reg-logo-container" style="display:flex;justify-content:center;margin-bottom:8px;"></div>
        <h1 id="reg-title-text" class="font-display" style="font-size:2rem;font-weight:900;font-style:italic;letter-spacing:-0.02em;text-align:center;margin-bottom:4px;">Acceso Cliente</h1>
        <p style="font-size:0.7rem;font-weight:600;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);text-align:center;margin-bottom:28px;">Crea tu perfil para continuar</p>
        <div style="display:flex;flex-direction:column;gap:12px;">
            <input id="reg-name"     class="reg-input" type="text" placeholder="Nombre" autocomplete="given-name">
            <input id="reg-surname"  class="reg-input" type="text" placeholder="Apellido" autocomplete="family-name">
            <input id="reg-whatsapp" class="reg-input" type="tel"  placeholder="WhatsApp" autocomplete="tel">
            <button onclick="saveUserRegistration()" class="btn btn-primary btn-full btn-lg" style="margin-top:8px;">
                Ingresar
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
            </button>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════
     MENU SCREEN
═══════════════════════════════════════ -->
<div id="menu-screen" class="hidden">
    <div style="text-align:center;margin-bottom:40px;" class="animate-fade-up">
        <div id="menu-logo-container" style="display:flex;justify-content:center;margin-bottom:12px;"></div>
        <h1 class="font-display" style="font-size:3.5rem;font-weight:900;font-style:italic;letter-spacing:-0.03em;line-height:0.9;">Rocola<span class="text-red">Pro</span></h1>
        <p style="font-size:0.7rem;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--text-muted);margin-top:8px;">Selecciona tu modo</p>
    </div>
    <div style="display:flex;flex-direction:column;gap:8px;width:100%;max-width:400px;">
        <div class="menu-card animate-fade-up stagger-1" onclick="checkClientRegistration()">
            <div class="menu-icon" style="background:rgba(232,54,42,0.1);">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent-red)" stroke-width="2.5"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
            </div>
            <div>
                <div class="font-display" style="font-size:1rem;font-weight:900;font-style:italic;letter-spacing:0.02em;text-transform:uppercase;">Cliente</div>
                <div style="font-size:0.65rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);">Música y Servicios</div>
            </div>
            <svg style="margin-left:auto;color:var(--text-muted);" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
        </div>

        <div class="menu-card animate-fade-up stagger-2" onclick="setMode('waiter')">
            <div class="menu-icon" style="background:rgba(31,214,112,0.1);">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent-green)" stroke-width="2.5"><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/></svg>
            </div>
            <div>
                <div class="font-display" style="font-size:1rem;font-weight:900;font-style:italic;letter-spacing:0.02em;text-transform:uppercase;">Mesero</div>
                <div style="font-size:0.65rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);">Atención en Mesa</div>
            </div>
            <svg style="margin-left:auto;color:var(--text-muted);" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
        </div>

        <div class="menu-card animate-fade-up stagger-3" onclick="setMode('admin')">
            <div class="menu-icon" style="background:rgba(232,54,42,0.1);">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent-red)" stroke-width="2.5"><circle cx="12" cy="12" r="3"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M4.93 4.93a10 10 0 0 0 0 14.14"/></svg>
            </div>
            <div>
                <div class="font-display" style="font-size:1rem;font-weight:900;font-style:italic;letter-spacing:0.02em;text-transform:uppercase;">Modo DJ</div>
                <div style="font-size:0.65rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);">Gestión de Ambiente</div>
            </div>
            <svg style="margin-left:auto;color:var(--text-muted);" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
        </div>

        <div class="menu-card animate-fade-up stagger-4" onclick="setMode('analytics')">
            <div class="menu-icon" style="background:rgba(139,92,246,0.1);">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent-purple)" stroke-width="2.5"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
            </div>
            <div>
                <div class="font-display" style="font-size:1rem;font-weight:900;font-style:italic;letter-spacing:0.02em;text-transform:uppercase;">Analytics</div>
                <div style="font-size:0.65rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);">Estadísticas Detalladas</div>
            </div>
            <svg style="margin-left:auto;color:var(--text-muted);" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════
     ████ CLIENT APP — MOBILE FIRST ████
═══════════════════════════════════════ -->
<div id="client-app" class="hidden">

    <!-- Top Bar -->
    <div class="client-topbar">
        <div style="display:flex;align-items:center;gap:10px;">
            <div id="client-header-logo"></div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
            <div id="client-wait-pill" class="wait-pill hidden">
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                <span>~<span id="client-wait-mins">0</span> min</span>
            </div>
            <div id="client-status-dot" style="width:7px;height:7px;border-radius:50%;background:var(--text-muted);"></div>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="client-content">

        <!-- TAB: COLA (default) -->
        <div id="tab-queue" class="client-tab-panel active">
            <!-- Now Playing -->
            <div class="now-playing-hero" id="now-playing-section">
                <div style="font-size:0.65rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-muted);margin-bottom:8px;padding:0 4px;">Sonando ahora</div>
                <div class="now-playing-card" id="now-playing-card">
                    <div style="display:flex;align-items:center;gap:12px;">
                        <div class="np-thumb-placeholder" id="np-thumb-wrap">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                        </div>
                        <div style="flex:1;min-width:0;">
                            <div class="font-display truncate" style="font-size:1.3rem;font-weight:800;font-style:italic;" id="np-title">Sin reproducción</div>
                            <div style="font-size:0.65rem;color:var(--text-muted);font-weight:600;text-transform:uppercase;letter-spacing:0.06em;margin-top:2px;" id="np-meta">—</div>
                        </div>
                        <div class="eq-bars" id="eq-bars" style="display:none;">
                            <div class="eq-bar" style="height:18px;"></div>
                            <div class="eq-bar" style="height:12px;"></div>
                            <div class="eq-bar" style="height:16px;"></div>
                            <div class="eq-bar" style="height:10px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Queue List -->
            <div class="queue-section">
                <div class="queue-header">En espera</div>
                <div id="client-queue-list">
                    <div style="text-align:center;padding:32px 16px;color:var(--text-muted);">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin:0 auto 8px;display:block;opacity:0.4;"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                        <p style="font-size:0.75rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;opacity:0.5;">Cola vacía</p>
                    </div>
                </div>
            </div>
            <div style="height:16px;"></div>
        </div>

        <!-- TAB: PEDIR (search) — opens modal -->
        <div id="tab-request" class="client-tab-panel">
            <div id="request-cooldown-view" style="display:none;padding:32px 24px;text-align:center;">
                <div style="font-size:3.5rem;margin-bottom:16px;">⏳</div>
                <h2 class="font-display" style="font-size:1.8rem;font-weight:900;font-style:italic;margin-bottom:8px;">Turno en Espera</h2>
                <p style="font-size:0.85rem;color:var(--text-muted);font-weight:600;margin-bottom:24px;">Podrás pedir otra canción en</p>
                <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:20px;padding:28px;display:inline-block;min-width:160px;">
                    <div id="cooldown-display" class="font-display" style="font-size:3.5rem;font-weight:900;letter-spacing:-0.02em;color:var(--accent-red);line-height:1;">0:00</div>
                    <div style="font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-muted);margin-top:4px;">minutos</div>
                </div>
                <p style="font-size:0.7rem;color:var(--text-muted);font-weight:600;margin-top:20px;">Mientras esperas, puedes votar<br>por canciones en la cola 🔥</p>
            </div>
        </div>

        <!-- TAB: SERVICIOS -->
        <div id="tab-services" class="client-tab-panel">
            <div style="padding:16px 16px 8px;">
                <div class="font-display" style="font-size:0.65rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-muted);margin-bottom:12px;">Servicios de mesa</div>
                <div id="client-user-card" style="background:var(--bg-card);border:1px solid var(--border);border-radius:14px;padding:18px 20px;display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                    <div style="width:36px;height:36px;border-radius:10px;background:rgba(232,54,42,0.1);display:flex;align-items:center;justify-content:center;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent-red)" stroke-width="2.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    </div>
                    <div>
                        <div id="client-user-name" class="font-display" style="font-size:1.1rem;font-weight:700;font-style:italic;"></div>
                        <div id="client-table-info" style="font-size:0.8rem;color:var(--text-muted);font-weight:600;letter-spacing:0.06em;text-transform:uppercase;"></div>
                    </div>
                    <button onclick="document.getElementById('table-modal').classList.remove('hidden')" style="margin-left:auto;font-size:0.65rem;font-weight:700;letter-spacing:0.06em;text-transform:uppercase;color:var(--accent-indigo);background:none;border:none;cursor:pointer;">Cambiar mesa</button>
                </div>
            </div>

            <div class="service-grid">
                <div class="service-card" id="waiter-card" onclick="handleCallWaiter()" style="position:relative;">
                    <div class="service-card-icon" id="waiter-card-icon" style="background:rgba(31,214,112,0.12);">
                        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#1fd670" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M18 8h.01M6 8h.01M15 8a3 3 0 1 1-6 0"/><path d="M3 8h18v8a5 5 0 0 1-5 5H8a5 5 0 0 1-5-5V8z"/>
                        </svg>
                    </div>
                    <div>
                        <div class="service-card-label" id="waiter-card-label">Llamar Mesero</div>
                        <div class="service-card-sub" id="waiter-card-sub">Solicitar atención</div>
                    </div>
                </div>
                <div class="service-card" id="bill-card" onclick="handleRequestBill()" style="position:relative;">
                    <div class="service-card-icon" id="bill-card-icon" style="background:rgba(240,180,41,0.12);">
                        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#f0b429" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/>
                        </svg>
                    </div>
                    <div>
                        <div class="service-card-label" id="bill-card-label">Pedir Cuenta</div>
                        <div class="service-card-sub" id="bill-card-sub">Elegir forma de pago</div>
                    </div>
                </div>
                <div class="service-card" onclick="openSearch()">
                    <div class="service-card-icon" style="background:rgba(232,54,42,0.12);">
                        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#e8362a" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>
                        </svg>
                    </div>
                    <div>
                        <div class="service-card-label">Pedir Canción</div>
                        <div class="service-card-sub">Agregar a la cola</div>
                    </div>
                </div>
                <div class="service-card" onclick="openSearch(); document.querySelector && setSearchType('karaoke')">
                    <div class="service-card-icon" style="background:rgba(91,110,245,0.12);">
                        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#5b6ef5" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2a3 3 0 0 1 3 3v7a3 3 0 0 1-6 0V5a3 3 0 0 1 3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="22"/>
                        </svg>
                    </div>
                    <div>
                        <div class="service-card-label">Karaoke</div>
                        <div class="service-card-sub">Canta tu favorita</div>
                    </div>
                </div>
            </div>
        </div>

    </div><!-- end client-content -->

    <!-- Bottom Nav -->
    <div class="client-bottom-nav">
        <div class="nav-tab active" id="nav-queue" onclick="switchClientTab('queue')">
            <svg class="nav-tab-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
            <span class="nav-tab-label">Cola</span>
        </div>
        <div class="nav-tab" id="nav-request">
            <div class="nav-tab-cta">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M12 5v14M5 12h14"/></svg>
            </div>
        </div>
        <div class="nav-tab" id="nav-services" onclick="switchClientTab('services')">
            <svg class="nav-tab-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/></svg>
            <span class="nav-tab-label">Servicios</span>
        </div>
    </div>

</div><!-- end client-app -->


<!-- ═══════════════════════════════════════
     ████ STAFF APP — SAAS LAYOUT ████
═══════════════════════════════════════ -->
<div id="staff-app" class="hidden">

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo-text" id="sidebar-logo-container"></div>
            <button class="sidebar-toggle" onclick="toggleSidebar()" title="Colapsar sidebar">
                <svg id="sidebar-toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 18l-6-6 6-6"/></svg>
            </button>
        </div>

        <nav class="sidebar-nav">

            <!-- DJ -->
            <div class="sidebar-section-label">Modo DJ</div>
            <div class="sidebar-item" id="sitem-dashboard" onclick="switchStaffPanel('dashboard')">
                <svg class="sidebar-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="7" height="9" rx="1"/><rect x="2" y="14" width="7" height="7" rx="1"/><rect x="11" y="3" width="11" height="5" rx="1"/><rect x="11" y="10" width="11" height="11" rx="1"/></svg>
                <span class="sidebar-item-label">Dashboard</span>
            </div>
            <div class="sidebar-item" id="sitem-player" onclick="switchStaffPanel('player')">
                <svg class="sidebar-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polygon points="10,8 16,12 10,16"/></svg>
                <span class="sidebar-item-label">Reproductor</span>
            </div>
            <div class="sidebar-item" id="sitem-queue-dj" onclick="switchStaffPanel('queue-dj')">
                <svg class="sidebar-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
                <span class="sidebar-item-label">Cola de canciones</span>
                <span class="sidebar-badge" id="sb-queue-count" style="display:none;">0</span>
            </div>
            <div class="sidebar-item" id="sitem-sampler" onclick="switchStaffPanel('sampler')">
                <svg class="sidebar-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="8" width="4" height="12" rx="1"/><rect x="8" y="4" width="4" height="16" rx="1"/><rect x="14" y="10" width="4" height="10" rx="1"/><rect x="20" y="6" width="4" height="14" rx="1" transform="translate(-4,0)"/></svg>
                <span class="sidebar-item-label">Sampler DJ</span>
            </div>

            <div style="height:8px;"></div>
            <div style="height:1px;background:var(--border);margin:4px 8px;"></div>
            <div style="height:8px;"></div>

            <!-- WAITER -->
            <div class="sidebar-section-label">Mesero</div>
            <div class="sidebar-item" id="sitem-waiter" onclick="switchStaffPanel('waiter')">
                <svg class="sidebar-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/></svg>
                <span class="sidebar-item-label">Solicitudes</span>
                <span class="sidebar-badge" id="sb-waiter-count" style="display:none;">0</span>
            </div>
            <div class="sidebar-item" id="sitem-history" onclick="switchStaffPanel('history')">
                <svg class="sidebar-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M8 17V9M12 17V12M16 17V5"/></svg>
                <span class="sidebar-item-label">Historial</span>
            </div>

            <div style="height:8px;"></div>
            <div style="height:1px;background:var(--border);margin:4px 8px;"></div>
            <div style="height:8px;"></div>

            <!-- ANALYTICS -->
            <div class="sidebar-section-label">Analytics</div>
            <div class="sidebar-item" id="sitem-analytics" onclick="switchStaffPanel('analytics')">
                <svg class="sidebar-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
                <span class="sidebar-item-label">Métricas</span>
            </div>

            <div style="height:8px;"></div>
            <div style="height:1px;background:var(--border);margin:4px 8px;"></div>
            <div style="height:8px;"></div>

            <!-- SYSTEM -->
            <div class="sidebar-section-label">Sistema</div>
            <div class="sidebar-item" onclick="copyRoleLink(currentMode)">
                <svg class="sidebar-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                <span class="sidebar-item-label">Copiar enlace</span>
            </div>
            <div class="sidebar-item" id="sitem-manage-staff" onclick="switchStaffPanel('manage-staff')">
                <svg class="sidebar-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                <span class="sidebar-item-label">Gestionar Staff</span>
            </div>
            <div class="sidebar-item" onclick="location.href=window.location.origin + window.location.pathname">
                <svg class="sidebar-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                <span class="sidebar-item-label">Salir</span>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="sidebar-status">
                <div class="status-dot offline" id="sidebar-status-dot"></div>
                <span class="sidebar-status-text" id="sidebar-status-text">Desconectado</span>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <div class="staff-main">
        <!-- Topbar -->
        <div class="staff-topbar">
            <span class="staff-page-title" id="staff-page-title">Dashboard</span>
            <div class="staff-topbar-right">
                <span class="role-chip" id="staff-role-chip">ROL</span>
                <div id="conn-status-badge" style="display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:100px;">
                    <div class="status-dot offline" id="staff-status-dot"></div>
                    <span id="staff-status-text" style="font-size:0.65rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);">Desconectado</span>
                </div>
            </div>
        </div>

        <!-- Content area -->
        <div class="staff-content">

            <!-- ── PANEL: DASHBOARD ── -->
            <div class="staff-panel active" id="panel-dashboard">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label text-red">Canción Favorita</div>
                        <div class="font-display truncate" id="stat-top-song" style="font-size:1.35rem;font-weight:800;font-style:italic;color:var(--text-primary);line-height:1.3;margin:6px 0;">Esperando...</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label" style="color:var(--accent-indigo);">Ritmo</div>
                        <div class="stat-value" id="stat-songs-hour">0</div>
                        <div class="stat-sub">canciones/hora</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label text-green">Total hoy</div>
                        <div class="stat-value" id="stat-total-today">0</div>
                        <div class="stat-sub">canciones</div>
                    </div>
                </div>
                <div class="content-card">
                    <div class="content-card-title">Acciones rápidas</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                        <button onclick="switchStaffPanel('player')" class="btn btn-secondary">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polygon points="10,8 16,12 10,16"/></svg>
                            Reproductor
                        </button>
                        <button onclick="openTVTab()" class="btn btn-primary">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="2" y="4" width="20" height="15" rx="2"/><path d="M8 20h8M12 19v1"/></svg>
                            Abrir TV
                        </button>
                        <button onclick="switchStaffPanel('waiter')" class="btn btn-secondary">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/></svg>
                            Solicitudes
                        </button>
                        <button onclick="switchStaffPanel('analytics')" class="btn btn-secondary">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
                            Analytics
                        </button>
                    </div>
                </div>
            </div>

            <!-- ── PANEL: PLAYER (DJ) ── -->
            <div class="staff-panel" id="panel-player">

                <!-- NOW PLAYING -->
                <div class="dj-panel">
                    <div class="dj-section dj-now-playing">
                        <div class="dj-section-label">Ahora suena</div>
                        <div class="dj-song-title" id="admin-current-title">Standby</div>
                        <div class="dj-song-meta" id="dj-song-meta">—</div>
                        <div class="dj-progress-bar"><div class="dj-progress-fill" id="dj-progress"></div></div>
                    </div>

                    <!-- TRANSPORT -->
                    <div class="dj-section">
                        <div class="dj-transport">
                            <button class="dj-btn" onclick="sendCommand('seek',{offset:-30})" title="−30s">
                                <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><path d="M11 17l-5-5 5-5M18 17l-5-5 5-5"/></svg>
                            </button>
                            <button class="dj-btn" onclick="sendCommand('seek',{offset:-10})" title="−10s">
                                <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><polyline points="15,18 9,12 15,6"/></svg>
                            </button>
                            <button class="dj-btn dj-btn-play" id="dj-play-btn" onclick="sendCommand('play')" title="Play" style="display:flex;">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="white"><polygon points="5,3 19,12 5,21"/></svg>
                            </button>
                            <button class="dj-btn dj-btn-pause" id="dj-pause-btn" onclick="sendCommand('pause')" title="Pausa" style="display:none;">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="white"><rect x="5" y="4" width="5" height="16"/><rect x="14" y="4" width="5" height="16"/></svg>
                            </button>
                            <button class="dj-btn" onclick="sendCommand('seek',{offset:10})" title="+10s">
                                <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><polyline points="9,18 15,12 9,6"/></svg>
                            </button>
                            <button class="dj-btn" onclick="sendCommand('seek',{offset:30})" title="+30s">
                                <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><path d="M13 17l5-5-5-5M6 17l5-5-5-5"/></svg>
                            </button>
                            <button class="dj-btn dj-btn-skip" onclick="skipSong()" title="Saltar canción">
                                <svg width="17" height="17" viewBox="0 0 24 24" fill="currentColor"><polygon points="5,4 15,12 5,20"/><rect x="17" y="4" width="3" height="16" rx="1"/></svg>
                            </button>
                        </div>
                    </div>

                    <!-- VOLUME -->
                    <div class="dj-section">
                        <div class="dj-section-label">Volumen monitor</div>
                        <div class="dj-vol-row">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2.5"><path d="M11 5L6 9H2v6h4l5 4V5z"/></svg>
                            <input type="range" class="dj-vol-slider" id="dj-volume" min="0" max="100" value="100" oninput="setPlayerVolume(this.value)">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2.5"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
                            <span class="dj-vol-label" id="dj-vol-label">100</span>
                            <button class="dj-btn dj-btn-mute" id="admin-mute-btn" onclick="toggleAdminMute()" title="Mute monitor" style="width:36px;height:36px;">
                                <svg id="mute-icon" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- DEDICATORIA -->
                <div class="dj-panel" style="margin-top:12px;">
                    <div class="dj-section">
                        <div class="dj-section-label">Dedicatoria de esta canción</div>
                        <div class="dj-dedication-card" id="dj-dedication-card">
                            <div class="dj-dedication-empty" id="dj-dedication-empty">Sin dedicatoria</div>
                            <div id="dj-dedication-body" style="display:none;">
                                <div class="dj-dedication-text" id="dj-dedication-text"></div>
                                <div class="dj-dedication-from" id="dj-dedication-from"></div>
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;margin-top:10px;">
                            <button class="dj-action-btn" id="toggle-dedication-btn" onclick="toggleDedication()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                                Mostrar en TV
                            </button>
                            <button class="dj-action-btn tv-active" onclick="openTVTab()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
                                Abrir TV
                            </button>
                        </div>
                    </div>
                </div>

                <!-- COLA DJ -->
                <div class="dj-section" style="border-top:1px solid var(--border);">
                    <div class="dj-section-label">Cola completa</div>
                    <div id="dj-panel-queue"></div>
                </div>

                <!-- CHAT FEED DJ -->
                <div class="dj-panel" style="margin-top:12px;">
                    <div class="dj-section">
                        <div class="dj-section-label">Chat en vivo</div>
                        <div id="dj-chat-feed" style="display:flex;flex-direction:column;gap:6px;max-height:180px;overflow-y:auto;margin-top:6px;"></div>
                    </div>
                </div>

                <!-- SAMPLER PAD -->
                <div class="dj-panel" style="margin-top:12px;">
                    <div class="dj-section">
                        <div class="dj-section-label">Sampler en vivo</div>
                        <div id="sampler-pad" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px;">
                            <div style="text-align:center;color:var(--text-muted);font-size:0.72rem;padding:16px;grid-column:1/-1;">Sin samplers — créalos en el panel Sampler</div>
                        </div>
                    </div>
                </div>

                <!-- BANNER TV -->
                <div class="dj-panel" style="margin-top:12px;">
                    <div class="dj-section">
                        <div class="dj-section-label">Banners TV — 1920 × 200 px</div>

                        <!-- Upload area -->
                        <div style="display:flex;gap:10px;align-items:flex-end;margin-bottom:14px;">
                            <div style="flex:1;">
                                <input id="banner-name-input" type="text" placeholder="Nombre del banner..." style="width:100%;background:var(--bg-card);border:1px solid var(--border-mid);border-radius:10px;padding:9px 12px;color:var(--text-primary);font-family:'Barlow',sans-serif;font-size:0.8rem;outline:none;margin-bottom:8px;">
                                <label for="banner-file-input" style="display:flex;align-items:center;justify-content:center;gap:8px;height:40px;background:var(--bg-card);border:1px dashed var(--border-mid);border-radius:10px;cursor:pointer;font-size:0.72rem;font-weight:700;color:var(--text-muted);letter-spacing:0.08em;text-transform:uppercase;transition:all 0.15s;" onmouseover="this.style.borderColor='var(--accent-indigo)'" onmouseout="this.style.borderColor='var(--border-mid)'">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                    Seleccionar imagen
                                </label>
                                <input type="file" id="banner-file-input" accept="image/*" onchange="handleBannerUpload(event)" style="display:none;">
                            </div>
                            <button onclick="saveBanner()" style="height:40px;padding:0 16px;background:var(--accent-indigo);border:none;border-radius:10px;color:white;font-family:'Barlow',sans-serif;font-size:0.72rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;cursor:pointer;flex-shrink:0;">Guardar</button>
                        </div>

                        <!-- Preview of selected file -->
                        <div id="banner-new-preview" style="display:none;margin-bottom:14px;border-radius:10px;overflow:hidden;border:1px solid var(--border);">
                            <img id="banner-preview-img" style="width:100%;height:60px;object-fit:cover;display:block;">
                        </div>

                        <!-- Saved banners list -->
                        <div id="banner-list" style="display:flex;flex-direction:column;gap:8px;">
                            <div style="font-size:0.72rem;color:var(--text-muted);text-align:center;padding:12px 0;">Sin banners guardados</div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- ── PANEL: QUEUE DJ ── -->
            <div class="staff-panel" id="panel-queue-dj">
                <div class="content-card">
                    <div class="content-card-title">Cola de reproducción</div>
                    <div id="dj-queue-list" style="display:flex;flex-direction:column;gap:6px;">
                        <p style="text-align:center;color:var(--text-muted);font-size:0.8rem;padding:24px 0;font-weight:600;">Cola vacía</p>
                    </div>
                </div>
            </div>

            <!-- ── PANEL: SAMPLER ── -->
            <div class="staff-panel" id="panel-sampler">
                <div class="content-card">
                    <div class="content-card-title">Gestionar Samplers</div>

                    <!-- Crear nuevo sampler -->
                    <div style="background:var(--bg-elevated);border:1px solid var(--border-mid);border-radius:14px;padding:16px;margin-bottom:16px;">
                        <div style="font-size:0.65rem;font-weight:800;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-muted);margin-bottom:12px;">Nuevo Sampler</div>
                        <div style="display:flex;flex-direction:column;gap:10px;">
                            <input id="sampler-name" type="text" placeholder="Nombre del botón (ej: Aplausos)" style="background:var(--bg-card);border:1px solid var(--border-mid);border-radius:10px;padding:9px 12px;color:var(--text-primary);font-family:'Barlow',sans-serif;font-size:0.82rem;outline:none;width:100%;">
                            <div style="display:flex;gap:8px;align-items:center;">
                                <div style="font-size:0.65rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.08em;flex-shrink:0;">Color:</div>
                                <div style="display:flex;gap:6px;">
                                    <div onclick="selectSamplerColor('#e8362a')" style="width:22px;height:22px;border-radius:50%;background:#e8362a;cursor:pointer;border:2px solid transparent;" class="sampler-color-opt"></div>
                                    <div onclick="selectSamplerColor('#f0b429')" style="width:22px;height:22px;border-radius:50%;background:#f0b429;cursor:pointer;border:2px solid transparent;" class="sampler-color-opt"></div>
                                    <div onclick="selectSamplerColor('#1fd670')" style="width:22px;height:22px;border-radius:50%;background:#1fd670;cursor:pointer;border:2px solid transparent;" class="sampler-color-opt"></div>
                                    <div onclick="selectSamplerColor('#5b6ef5')" style="width:22px;height:22px;border-radius:50%;background:#5b6ef5;cursor:pointer;border:2px solid transparent;" class="sampler-color-opt"></div>
                                    <div onclick="selectSamplerColor('#8b5cf6')" style="width:22px;height:22px;border-radius:50%;background:#8b5cf6;cursor:pointer;border:2px solid transparent;" class="sampler-color-opt"></div>
                                </div>
                                <div id="sampler-color-preview" style="width:22px;height:22px;border-radius:50%;background:#e8362a;border:2px solid white;margin-left:4px;"></div>
                            </div>
                            <!-- Audio source selector -->
                            <div style="display:flex;gap:8px;">
                                <button onclick="setSamplerSource('file')" id="sampler-src-file" style="flex:1;padding:8px;border-radius:10px;border:1px solid var(--accent-indigo);background:rgba(91,110,245,0.12);color:var(--accent-indigo);font-family:'Barlow',sans-serif;font-size:0.72rem;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;text-transform:uppercase;letter-spacing:0.08em;">
                                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                    Subir archivo
                                </button>
                                <button onclick="setSamplerSource('record')" id="sampler-src-record" style="flex:1;padding:8px;border-radius:10px;border:1px solid var(--border-mid);background:transparent;color:var(--text-muted);font-family:'Barlow',sans-serif;font-size:0.72rem;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;text-transform:uppercase;letter-spacing:0.08em;">
                                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
                                    Grabar
                                </button>
                            </div>
                            <!-- File upload -->
                            <div id="sampler-file-area">
                                <label for="sampler-file-input" style="display:flex;align-items:center;justify-content:center;gap:8px;height:40px;background:var(--bg-card);border:1px dashed var(--border-mid);border-radius:10px;cursor:pointer;font-size:0.72rem;font-weight:700;color:var(--text-muted);letter-spacing:0.08em;text-transform:uppercase;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                                    Seleccionar audio
                                </label>
                                <input type="file" id="sampler-file-input" accept="audio/*" onchange="handleSamplerFile(event)" style="display:none;">
                                <div id="sampler-file-name" style="font-size:0.7rem;color:var(--accent-green);margin-top:6px;display:none;"></div>
                            </div>
                            <!-- Record area -->
                            <div id="sampler-record-area" style="display:none;">
                                <button id="sampler-record-btn" onclick="toggleSamplerRecording()" style="width:100%;padding:10px;border-radius:10px;border:none;background:rgba(232,54,42,0.12);color:var(--accent-red);font-family:'Barlow',sans-serif;font-size:0.78rem;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;text-transform:uppercase;letter-spacing:0.08em;">
                                    <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="6"/></svg>
                                    Grabar audio
                                </button>
                                <div id="sampler-record-status" style="font-size:0.7rem;color:var(--text-muted);text-align:center;margin-top:6px;display:none;"></div>
                            </div>
                            <button onclick="saveSampler()" style="width:100%;padding:10px;background:var(--accent-red);border:none;border-radius:10px;color:white;font-family:'Barlow',sans-serif;font-size:0.78rem;font-weight:700;cursor:pointer;text-transform:uppercase;letter-spacing:0.08em;">Guardar Sampler</button>
                        </div>
                    </div>

                    <!-- Lista de samplers guardados -->
                    <div style="font-size:0.65rem;font-weight:800;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-muted);margin-bottom:10px;">Samplers guardados</div>
                    <div id="sampler-list" style="display:flex;flex-direction:column;gap:8px;">
                        <div style="text-align:center;color:var(--text-muted);font-size:0.72rem;padding:12px;">Sin samplers guardados</div>
                    </div>
                </div>
            </div>

            <!-- ── PANEL: WAITER ── -->
            <div class="staff-panel" id="panel-waiter">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label text-red">Pendientes</div>
                        <div class="stat-value" id="waiter-stat-open">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label" style="color:var(--text-muted);">Cerradas</div>
                        <div class="stat-value" id="waiter-stat-closed">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label text-indigo">Atención prom.</div>
                        <div class="stat-value" id="waiter-stat-avg">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label text-amber">Satisfacción</div>
                        <div class="stat-value" id="waiter-stat-satisfaction">--</div>
                    </div>
                </div>
                <div class="content-card">
                    <div class="content-card-title">Cargar Riffs a usuario</div>
                    <div style="display:flex;flex-direction:column;gap:12px;">
                        <input id="riffs-search" type="text" placeholder="Nombre del usuario..." class="reg-input" oninput="searchRiffsUser(this.value)">
                        <div id="riffs-search-results" style="display:flex;flex-direction:column;gap:6px;"></div>
                        <div id="riffs-selected-user" style="display:none;background:var(--bg-card);border:1px solid var(--border-mid);border-radius:12px;padding:14px 16px;">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                                <div>
                                    <div style="font-size:0.85rem;font-weight:700;color:var(--text-primary);" id="riffs-user-name">—</div>
                                    <div style="font-size:0.68rem;font-weight:600;color:var(--text-muted);margin-top:2px;">Saldo actual: <span id="riffs-user-balance" style="color:var(--accent-amber);">0</span> Riffs</div>
                                </div>
                                <button onclick="clearRiffsUser()" style="font-size:0.65rem;font-weight:700;color:var(--text-muted);background:none;border:none;cursor:pointer;letter-spacing:0.1em;text-transform:uppercase;">Cambiar</button>
                            </div>
                            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
                                <button onclick="chargeRiffs('chico')" style="background:var(--bg-elevated);border:1px solid var(--border-mid);border-radius:12px;padding:12px 8px;cursor:pointer;transition:all 0.15s;text-align:center;">
                                    <div style="font-size:0.7rem;font-weight:800;color:var(--text-primary);text-transform:uppercase;letter-spacing:0.05em;">Pack Chico</div>
                                    <div style="font-size:1.1rem;font-weight:900;color:var(--accent-amber);margin:4px 0;">80 Riffs</div>
                                    <div style="font-size:0.65rem;font-weight:600;color:var(--text-muted);">$100 MXN</div>
                                </button>
                                <button onclick="chargeRiffs('medio')" style="background:var(--bg-elevated);border:1px solid var(--border-mid);border-radius:12px;padding:12px 8px;cursor:pointer;transition:all 0.15s;text-align:center;">
                                    <div style="font-size:0.7rem;font-weight:800;color:var(--text-primary);text-transform:uppercase;letter-spacing:0.05em;">Pack Medio</div>
                                    <div style="font-size:1.1rem;font-weight:900;color:var(--accent-amber);margin:4px 0;">180 Riffs</div>
                                    <div style="font-size:0.65rem;font-weight:600;color:var(--text-muted);">$200 MXN</div>
                                </button>
                                <button onclick="chargeRiffs('grande')" style="background:rgba(232,54,42,0.08);border:1px solid rgba(232,54,42,0.2);border-radius:12px;padding:12px 8px;cursor:pointer;transition:all 0.15s;text-align:center;">
                                    <div style="font-size:0.7rem;font-weight:800;color:var(--text-primary);text-transform:uppercase;letter-spacing:0.05em;">Pack Grande</div>
                                    <div style="font-size:1.1rem;font-weight:900;color:var(--accent-amber);margin:4px 0;">300 Riffs</div>
                                    <div style="font-size:0.65rem;font-weight:600;color:var(--text-muted);">$300 MXN</div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="content-card">
                    <div class="content-card-title">Solicitudes activas</div>
                    <div class="calls-grid" id="waiter-calls-list">
                        <p style="text-align:center;color:var(--text-muted);font-size:0.8rem;padding:24px 0;font-weight:600;grid-column:1/-1;">Sin solicitudes</p>
                    </div>
                </div>
            </div>

            <!-- ── PANEL: HISTORY ── -->
            <div class="staff-panel" id="panel-history">
                <div class="content-card">
                    <div class="content-card-title">Historial de mesas</div>
                    <div style="overflow-x:auto;">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>Mesa</th>
                                    <th>Pedidos</th>
                                    <th>Atención</th>
                                    <th>Rating</th>
                                </tr>
                            </thead>
                            <tbody id="waiter-closed-list">
                                <tr><td colspan="4" style="text-align:center;color:var(--text-muted);padding:24px;">Sin historial</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ── PANEL: MANAGE STAFF ── -->
            <div class="staff-panel" id="panel-manage-staff">
                <div class="content-card">
                    <div class="content-card-title">Crear cuenta de staff</div>
                    <div style="display:flex;flex-direction:column;gap:12px;">
                        <input id="new-staff-email"    type="email"    placeholder="Correo" class="reg-input">
                        <input id="new-staff-password" type="password" placeholder="Contraseña (mín. 6 caracteres)" class="reg-input">
                        <input id="new-staff-name"     type="text"     placeholder="Nombre" class="reg-input">
                        <select id="new-staff-role" style="background:var(--bg-elevated);border:1px solid var(--border);border-radius:12px;padding:14px 16px;color:var(--text-primary);font-family:'Barlow',sans-serif;font-size:15px;outline:none;width:100%;">
                            <option value="waiter">Mesero</option>
                            <option value="dj">DJ</option>
                            <option value="analytics">Analytics</option>
                        </select>
                        <button onclick="createStaffAccount()" class="btn btn-primary">Crear cuenta</button>
                    </div>
                </div>
                <div class="content-card">
                    <div class="content-card-title">Cuentas activas</div>
                    <div id="staff-list">
                        <p style="color:var(--text-muted);font-size:0.8rem;font-weight:600;text-align:center;padding:20px 0;">Cargando...</p>
                    </div>
                </div>
            </div>

            <!-- ── PANEL: ANALYTICS ── -->
            <div class="staff-panel" id="panel-analytics">
                <div class="content-card">
                    <div class="content-card-title">Período de análisis</div>
                    <div class="period-tabs">
                        <button onclick="setAnalyticsPeriod('today')"  id="btn-period-today"  class="period-tab active">Hoy</button>
                        <button onclick="setAnalyticsPeriod('week')"   id="btn-period-week"   class="period-tab">Semana</button>
                        <button onclick="setAnalyticsPeriod('month')"  id="btn-period-month"  class="period-tab">Mes</button>
                        <button onclick="setAnalyticsPeriod('year')"   id="btn-period-year"   class="period-tab">Año</button>
                        <button onclick="toggleCustomDateRange()"      id="btn-period-custom" class="period-tab">Rango</button>
                    </div>
                    <div id="custom-date-range" class="hidden" style="margin-top:16px;display:flex;flex-direction:column;gap:12px;border-top:1px solid var(--border);padding-top:16px;">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                            <div>
                                <label style="font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-muted);display:block;margin-bottom:6px;">Desde</label>
                                <input id="date-from" type="date" style="width:100%;background:var(--bg-elevated);border:1px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--text-primary);font-family:'Barlow',sans-serif;font-size:14px;outline:none;">
                            </div>
                            <div>
                                <label style="font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-muted);display:block;margin-bottom:6px;">Hasta</label>
                                <input id="date-to" type="date" style="width:100%;background:var(--bg-elevated);border:1px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--text-primary);font-family:'Barlow',sans-serif;font-size:14px;outline:none;">
                            </div>
                        </div>
                        <button onclick="applyCustomDateRange()" class="btn btn-primary">Aplicar rango</button>
                    </div>
                </div>
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label text-purple">Atención prom.</div>
                        <div class="kpi-value" id="analytics-avg-attention">--</div>
                        <div class="kpi-unit">minutos</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label text-green">Calidad</div>
                        <div class="kpi-value" id="analytics-avg-quality">--</div>
                        <div class="kpi-unit">rating</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label" style="color:var(--accent-indigo);">Mesas</div>
                        <div class="kpi-value" id="analytics-total-tables">0</div>
                        <div class="kpi-unit">atendidas</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label text-amber">Pedidos/Mesa</div>
                        <div class="kpi-value" id="analytics-avg-orders">--</div>
                        <div class="kpi-unit">promedio</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label text-red">Canciones</div>
                        <div class="kpi-value" id="analytics-songs-per-hour">--</div>
                        <div class="kpi-unit">por hora</div>
                    </div>
                </div>
                <div class="content-card" style="text-align:center;padding:32px;">
                    <div style="font-size:2rem;margin-bottom:8px;">📊</div>
                    <p style="color:var(--text-muted);font-size:0.8rem;font-weight:600;">Gráficos detallados disponibles pronto</p>
                </div>
            </div>

        </div><!-- end staff-content -->
    </div><!-- end staff-main -->
</div><!-- end staff-app -->


<!-- ═══════════════════════════════════════
     TV DISPLAY SCREEN
═══════════════════════════════════════ -->
<div id="display-screen" class="hidden">
    <div style="position:absolute;inset:0;background:radial-gradient(ellipse at 50% 120%, rgba(232,54,42,0.15) 0%, transparent 70%);pointer-events:none;"></div>
    <div id="tv-dedication-widget" class="tv-dedication hidden">
        <p id="tv-dedication-text" class="font-display" style="font-size:2rem;font-weight:700;font-style:italic;color:var(--text-primary);line-height:1.3;"></p>
        <p id="tv-dedication-from" style="font-size:0.85rem;font-weight:600;color:var(--text-muted);margin-top:12px;text-transform:uppercase;letter-spacing:0.08em;"></p>
    </div>
    <div style="position:relative;z-index:10;width:100%;max-width:1400px;display:flex;flex-direction:column;gap:32px;">
        <div class="video-container" style="box-shadow:0 40px 100px rgba(0,0,0,0.8);">
            <div id="display-yt-player"></div>
        </div>
        <div style="text-align:center;">
            <h1 id="display-title" class="font-display truncate" style="font-size:5rem;font-weight:900;font-style:italic;letter-spacing:-0.02em;line-height:1;margin-bottom:8px;"></h1>
            <p id="display-artist" style="font-size:1.4rem;color:var(--text-secondary);font-weight:600;text-transform:uppercase;letter-spacing:0.3em;"></p>
        </div>
    </div>
</div>


<!-- ═══════════════════════════════════════
     MODALS
═══════════════════════════════════════ -->

<!-- SEARCH MODAL -->
<div id="search-modal" class="modal-overlay hidden">
    <div class="modal-sheet">
        <div class="modal-handle"></div>
        <div class="modal-header">
            <span class="modal-title">Nueva Petición</span>
            <button class="modal-close" onclick="closeSearch()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
        </div>
        <div class="modal-body">
            <div style="display:flex;flex-direction:column;gap:14px;">
                <div class="search-type-toggle">
                    <button class="search-type-btn active" id="btn-type-music" onclick="setSearchType('music')">🎵 Música</button>
                    <button class="search-type-btn" id="btn-type-karaoke" onclick="setSearchType('karaoke')">🎤 Karaoke</button>
                </div>
                <div class="search-input-wrapper">
                    <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                    <input id="search-input" class="search-input" type="text" placeholder="Busca tu rola favorita..." oninput="debounceSearch()" autocomplete="off">
                </div>
                <div id="search-results" style="display:flex;flex-direction:column;gap:4px;min-height:48px;">
                    <p style="text-align:center;color:var(--text-muted);font-size:0.75rem;font-weight:600;padding:16px;text-transform:uppercase;letter-spacing:0.08em;">Escribe para buscar</p>
                </div>
                <div id="final-step-container" class="hidden" style="display:flex;flex-direction:column;gap:12px;">
                    <div class="confirm-panel">
                        <div style="font-size:0.6rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--accent-red);margin-bottom:4px;">Selección:</div>
                        <div class="confirm-song-name" id="selected-song-preview"></div>
                    </div>
                    <input id="song-dedication" type="text" placeholder="Dedicatoria (opcional)" style="background:var(--bg-elevated);border:1px solid var(--border);border-radius:12px;padding:13px 16px;color:var(--text-primary);font-family:'Barlow',sans-serif;font-size:15px;outline:none;width:100%;">
                    <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:10px 12px;background:var(--bg-elevated);border-radius:10px;border:1px solid var(--border);">
                        <input id="song-show-name" type="checkbox" checked style="width:16px;height:16px;accent-color:var(--accent-red);">
                        <span style="font-size:0.75rem;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.06em;">Mostrar mi nombre</span>
                    </label>
                </div>
            </div>
        </div>
        <div class="modal-footer" id="search-modal-footer" style="display:none;">
            <button onclick="confirmOrder()" class="btn btn-success btn-full btn-lg" id="confirm-order-btn">
                🚀 Enviar a la cola
            </button>
        </div>
    </div>
</div>

<!-- BILL MODAL -->
<div id="bill-modal" class="modal-overlay hidden">
    <div class="modal-sheet">
        <div class="modal-handle"></div>
        <div class="modal-header">
            <span class="modal-title">Pedir la Cuenta</span>
            <button class="modal-close" onclick="closeBillModal()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
        </div>
        <div class="modal-body">
            <div style="display:flex;flex-direction:column;gap:20px;">
                <div>
                    <div style="font-size:0.65rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-muted);margin-bottom:10px;">Forma de pago</div>
                    <div style="display:flex;gap:8px;">
                        <button onclick="selectPayment('efectivo')" id="pay-efectivo" class="payment-option">💵 Efectivo</button>
                        <button onclick="selectPayment('tarjeta')" id="pay-tarjeta" class="payment-option">💳 Tarjeta</button>
                    </div>
                </div>
                <div>
                    <div style="font-size:0.65rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-muted);margin-bottom:16px;">Califica nuestro servicio</div>
                    <div class="satisfaction-row">
                        <button onclick="selectSatisfaction(1)" class="sat-btn">😫</button>
                        <button onclick="selectSatisfaction(2)" class="sat-btn">☹️</button>
                        <button onclick="selectSatisfaction(3)" class="sat-btn">😐</button>
                        <button onclick="selectSatisfaction(4)" class="sat-btn">🙂</button>
                        <button onclick="selectSatisfaction(5)" class="sat-btn">🤩</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer" style="display:flex;gap:8px;">
            <button onclick="closeBillModal()" class="btn btn-ghost">Cancelar</button>
            <button id="confirm-bill-btn" onclick="sendBillRequest()" disabled class="btn btn-amber btn-full" style="opacity:0.5;">Enviar solicitud</button>
        </div>
    </div>
</div>

<!-- TABLE MODAL -->
<div id="table-modal" class="modal-overlay center hidden">
    <div class="modal-sheet is-center" style="max-width:360px;">
        <div class="modal-header">
            <span class="modal-title">Tu Mesa</span>
        </div>
        <div class="modal-body" style="text-align:center;">
            <input id="table-number-input" type="text" class="table-input" placeholder="#">
            <p style="font-size:0.7rem;color:var(--text-muted);font-weight:600;margin-top:12px;text-transform:uppercase;letter-spacing:0.08em;">Ingresa el número de tu mesa</p>
        </div>
        <div class="modal-footer">
            <button onclick="saveTableNumber()" class="btn btn-success btn-full btn-lg">Guardar mesa</button>
        </div>
    </div>
</div>


<!-- ═══════════════════════════════════════
     JAVASCRIPT MODULES
═══════════════════════════════════════ -->
<script>
/* ═══════════════════════════════════════
   MODULE: CONFIG
═══════════════════════════════════════ */
const LOGO_URL = "/logo.png";
const manualFirebaseConfig = {
    apiKey: "AIzaSyAia_yRHvYg3gGQ60VwPRwcRm3B0aja4cw",
    authDomain: "rocola-crowdplay2.firebaseapp.com",
    projectId: "rocola-crowdplay2",
    storageBucket: "rocola-crowdplay2.firebasestorage.app",
    messagingSenderId: "519952213703",
    appId: "1:519952213703:web:0e0ecb8cb3fc81064240e2"
};
const YOUTUBE_API_KEY = "AIzaSyBB32TS0dFywl8N7cV1zWAuJsHWyxO3Pkk";
const BUILD_ID = '2026-02-18-cambio9-typography';

let firebaseConfig = manualFirebaseConfig;
try { if (!firebaseConfig && typeof __firebase_config !== 'undefined') firebaseConfig = JSON.parse(__firebase_config); } catch(e) {}

let app, auth, db;
let isAppReady = false;
let appId = typeof __app_id !== 'undefined' ? __app_id : 'rocola-crowdplay2-v1';
let player = null;
let currentTrack = null;
let currentSongId = null;
let queue = [];
let searchTimeout = null;
let isAdminMuted = true;
let currentMode = null;
let searchType = 'music';
let selectedPayment = null;
let selectedSatisfactionValue = 0;
let selectedVideo = null;
let isSidebarCollapsed = false;
let currentStaffPanel = 'dashboard';

/* ═══════════════════════════════════════
   MODULE: TOAST
═══════════════════════════════════════ */
function toast(message, type = 'info', duration = 3000) {
    const container = document.getElementById('toast-container');
    const icons = {
        success: '✓',
        error:   '✕',
        info:    'ℹ',
        warning: '⚠'
    };
    const el = document.createElement('div');
    el.className = `toast toast-${type}`;
    el.innerHTML = `<span style="font-size:1rem;">${icons[type]}</span><span>${message}</span>`;
    container.appendChild(el);
    setTimeout(() => {
        el.classList.add('removing');
        setTimeout(() => el.remove(), 300);
    }, duration);
}

/* ═══════════════════════════════════════
   MODULE: INIT
═══════════════════════════════════════ */
window.addEventListener('error', (e) => {
    console.error('Global error:', e.error || e.message);
    setSyncError('Error JS. Revisa consola.');
});
window.addEventListener('unhandledrejection', (e) => {
    console.error('Unhandled rejection:', e.reason);
    setSyncError('Error de red o Firebase.');
});
// CAMBIO 3: Toggle fullscreen con tecla F en display mode
window.addEventListener('keydown', (e) => {
    if ((e.key === 'f' || e.key === 'F') && currentMode === 'display') {
        const el = document.getElementById('display-screen');
        if (document.fullscreenElement) {
            document.exitFullscreen();
        } else {
            if (el.requestFullscreen) el.requestFullscreen();
            else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
        }
    }
});

async function initFirebase() {
    try {
        const syncText = document.getElementById('sync-text');
        if (!window.firebase) { setSyncError('Firebase SDK no cargó.'); return; }
        if (syncText) syncText.innerText = 'Conectando...';

        if (!firebase.apps.length) app = firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();

        // Detectar role y mode ANTES de autenticar
        const urlParams = new URLSearchParams(window.location.search);
        const urlRole = urlParams.get('role');
        const urlMode = urlParams.get('mode');
        const isDisplayMode = urlMode === 'display';

        const syncTimeout = setTimeout(() => setSyncError('Tiempo de conexión agotado.'), 12000);

        const proceedApp = () => {
            clearTimeout(syncTimeout);
            isAppReady = true;
            document.getElementById('loading-screen').classList.add('hidden');
            updateStatus(true);
            applyLogo();
            
            // Si estamos en mode=display, mostrar directamente el reproductor
            if (isDisplayMode) {
                setMode('display');
            } else {
                // Admin: mostrar login
                const loginScreen = document.getElementById('admin-login-screen');
                if (loginScreen) loginScreen.classList.remove('hidden');
            }
        };

        // Always proceed for display mode
        proceedApp();

    } catch(e) {
        console.error('Firebase init error:', e);
        setSyncError('Error al conectar Firebase.');
    }
}

function setSyncError(message) {
    updateStatus(false);
    const el = document.getElementById('sync-text');
    if (el) { el.innerText = message; el.style.color = 'var(--accent-red)'; }
}

/* ═══════════════════════════════════════
   MODULE: STATUS & LOGO
═══════════════════════════════════════ */
function updateStatus(online) {
    // Sidebar dot
    const ssDot  = document.getElementById('sidebar-status-dot');
    const ssTxt  = document.getElementById('sidebar-status-text');
    if (ssDot) ssDot.className = online ? 'status-dot online' : 'status-dot offline';
    if (ssTxt) ssTxt.innerText = online ? 'Sincronizado' : 'Sin conexión';
    // Staff topbar dot
    const stDot  = document.getElementById('staff-status-dot');
    const stTxt  = document.getElementById('staff-status-text');
    if (stDot) stDot.className = online ? 'status-dot online' : 'status-dot offline';
    if (stTxt) stTxt.innerText = online ? 'Sincronizado' : 'Sin conexión';
    // Client dot
    const cDot = document.getElementById('client-status-dot');
    if (cDot) cDot.style.background = online ? 'var(--accent-green)' : 'var(--accent-red)';
}

function applyLogo() {
    const containers = ['reg-logo-container', 'menu-logo-container', 'client-header-logo'];
    containers.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const isSmall = id === 'client-header-logo';
        el.innerHTML = `<img src="${LOGO_URL}" style="max-height:${isSmall ? '32px' : '100px'};width:auto;object-fit:contain;" alt="Logo" onerror="handleLogoError('${id}')">`;
        if (id === 'reg-logo-container') {
            const title = document.getElementById('reg-title-text');
            if (title) title.classList.add('hidden');
        }
    });
    // CAMBIO 4: Reemplazar sidebar-logo-text con img
    const sidebarHeader = document.getElementById('sidebar-header');
    if (sidebarHeader) {
        const logoText = sidebarHeader.querySelector('.sidebar-logo-text');
        if (logoText) {
            console.log('Reemplazando sidebar logo');
            logoText.outerHTML = `<img src="/logo.png" style="max-height:32px;width:auto;object-fit:contain;" alt="Logo" id="sidebar-logo-img">`;
        }
    }
    // CAMBIO 4: Reemplazar RocolaPro en menu screen y loading screen
    const menuH1 = document.querySelector('#menu-screen h1');
    if (menuH1) {
        menuH1.innerHTML = 'CrowdPlay';
    }
    const loadingLogo = document.querySelector('.loading-logo');
    if (loadingLogo) {
        loadingLogo.innerHTML = `<img src="${LOGO_URL}" style="max-height:60px;width:auto;object-fit:contain;" alt="Logo" onerror="this.outerHTML='CrowdPlay'">`;
    }
}

function handleLogoError(id) {
    const el = document.getElementById(id);
    if (!el) return;
    // En client-header-logo, dejar vacío si falla
    if (id === 'client-header-logo') {
        el.innerHTML = '';
    } else {
        el.innerHTML = 'CrowdPlay';
    }
}

/* ═══════════════════════════════════════
   MODULE: ROUTING / MODE
═══════════════════════════════════════ */
function setMode(mode) {
    currentMode = mode;
    document.getElementById('menu-screen').classList.add('hidden');
    document.getElementById('client-app').classList.add('hidden');
    document.getElementById('staff-app').classList.add('hidden');
    document.getElementById('display-screen').classList.add('hidden');

    if (mode === 'display') {
        document.getElementById('display-screen').classList.remove('hidden');
        initYouTube('display-yt-player');
        // CAMBIO 3: Fullscreen después de 1.5s
        setTimeout(() => {
            const el = document.getElementById('display-screen');
            if (el.requestFullscreen) el.requestFullscreen();
            else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
        }, 1500);

    } else if (mode === 'client') {
        document.getElementById('client-app').classList.remove('hidden');
        const u = JSON.parse(localStorage.getItem('rocola_user_v1'));
        if (u) {
            const nameEl = document.getElementById('client-user-name');
            if (nameEl) nameEl.innerText = u.name + ' ' + (u.surname || '');
        }
        const tableN = localStorage.getItem('rocola_table_v1');
        const tInfo = document.getElementById('client-table-info');
        if (tInfo) tInfo.innerText = tableN ? `Mesa ${tableN}` : 'Mesa no asignada';
        if (!tableN) setTimeout(() => document.getElementById('table-modal').classList.remove('hidden'), 800);

    } else {
        // Staff modes: admin (DJ), waiter, analytics
        document.getElementById('staff-app').classList.remove('hidden');
        const roleMap = { admin: 'MODO DJ', waiter: 'MESERO', analytics: 'ANALYTICS' };
        const chipEl = document.getElementById('staff-role-chip');
        if (chipEl) chipEl.innerText = roleMap[mode] || mode.toUpperCase();

        if (mode === 'admin') {
            switchStaffPanel('dashboard');
            initYouTube('yt-player');
        } else if (mode === 'waiter') {
            switchStaffPanel('waiter');
            loadWaiterInitialData();
        } else if (mode === 'analytics') {
            switchStaffPanel('analytics');
            initAnalytics();
        }
    }
}

/* ═══════════════════════════════════════
   MODULE: SIDEBAR (Staff)
═══════════════════════════════════════ */
function toggleSidebar() {
    isSidebarCollapsed = !isSidebarCollapsed;
    const sidebar = document.getElementById('sidebar');
    const icon = document.getElementById('sidebar-toggle-icon');
    sidebar.classList.toggle('collapsed', isSidebarCollapsed);
    if (icon) {
        icon.innerHTML = isSidebarCollapsed
            ? '<path d="M9 18l6-6-6-6"/>'
            : '<path d="M15 18l-6-6 6-6"/>';
    }
}

function switchStaffPanel(panelName) {
    currentStaffPanel = panelName;
    // Hide all panels
    document.querySelectorAll('.staff-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
    // Show target
    const panel = document.getElementById(`panel-${panelName}`);
    if (panel) panel.classList.add('active');
    const sitem = document.getElementById(`sitem-${panelName}`);
    if (sitem) sitem.classList.add('active');
    if (panelName === 'player') { updatePlayIcon(); updateDedicationCard(); renderDJPanelQueue(); loadBanners(); startAdminChatListener(); }
    if (panelName === 'sampler' || panelName === 'player') loadSamplers();
    // Update topbar title
    const titles = {
        'dashboard': 'Dashboard',
        'player': 'Reproductor',
        'queue-dj': 'Cola de Canciones',
        'sampler': 'Sampler DJ',
        'waiter': 'Solicitudes',
        'history': 'Historial',
        'analytics': 'Analytics',
        'tv': 'Emisión TV'
    };
    const titleEl = document.getElementById('staff-page-title');
    if (titleEl) titleEl.innerText = titles[panelName] || panelName;
}

/* ═══════════════════════════════════════
   MODULE: CLIENT TABS
═══════════════════════════════════════ */
function switchClientTab(tabName) {
    document.querySelectorAll('.client-tab-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    const panel = document.getElementById(`tab-${tabName}`);
    if (panel) panel.classList.add('active');
    const nav = document.getElementById(`nav-${tabName}`);
    if (nav) nav.classList.add('active');
}

/* ═══════════════════════════════════════
   MODULE: REALTIME SYNC
═══════════════════════════════════════ */
function startRealtimeSync() {
    db.collection(`artifacts/${appId}/public/data/rocola_queue`).onSnapshot(snap => {
        let items = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        items.sort((a, b) => ((b.votes || 0) - (a.votes || 0)) || ((a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)));
        currentTrack = items.find(i => i.status === 'playing') || null;
        if (currentTrack) currentSongId = currentTrack.id;
        queue = items.filter(i => i.status === 'pending');
        updateClientUI();
        updateDJQueuePanel();
        syncVideo();
        // CAMBIO 3: Sincronizar video en display mode con delay
        if (currentMode === 'display' && currentTrack) {
            setTimeout(() => syncVideo(), 1000);
        }
        // Sincronizar video en admin mode también
        if (currentMode === 'admin' && currentTrack) {
            setTimeout(() => syncVideo(), 500);
        }

        if (currentMode === 'display' && currentTrack) {
            const dTitle = document.getElementById('display-title');
            const dArtist = document.getElementById('display-artist');
            if (dTitle) dTitle.innerText = currentTrack.title;
            if (dArtist) dArtist.innerText = currentTrack.artist;
        } else if (currentMode === 'display' && !currentTrack) {
            const dTitle = document.getElementById('display-title');
            if (dTitle) dTitle.innerText = 'Esperando canciones...';
        }

        if (currentMode === 'admin') {
            updateAdminDashboard(items);
            // Actualizar título en admin
            const adminTitle = document.getElementById('admin-current-title');
            if (adminTitle) adminTitle.innerText = currentTrack ? currentTrack.title : 'Standby...';
            updateDedicationCard();
            renderDJPanelQueue();
            updatePlayIcon();
        }
    });

    db.collection(`artifacts/${appId}/public/data/waiter_calls`).onSnapshot(snap => {
        const calls = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (currentMode === 'waiter' || currentStaffPanel === 'waiter' || currentStaffPanel === 'history') {
            updateWaiterView(calls);
        }
        updateClientWaiterStatus(calls);
        // Update waiter badge
        const activeCalls = calls.filter(c => c.status !== 'completed');
        const badge = document.getElementById('sb-waiter-count');
        if (badge) {
            badge.style.display = activeCalls.length > 0 ? 'block' : 'none';
            badge.innerText = activeCalls.length;
        }
    });
}

/* ═══════════════════════════════════════
   MODULE: CLIENT UI UPDATE
═══════════════════════════════════════ */
function updateClientUI() {
    // Now playing card
    const npTitle = document.getElementById('np-title');
    const npMeta  = document.getElementById('np-meta');
    const eqBars  = document.getElementById('eq-bars');
    const npThumbWrap = document.getElementById('np-thumb-wrap');

    if (currentTrack) {
        if (npTitle) npTitle.innerText = currentTrack.title;
        if (npMeta) {
            const tags = [];
            if (currentTrack.isKaraoke) tags.push('🎤 Karaoke');
            else tags.push('🎵 Música');
            if (currentTrack.showName && currentTrack.userName) tags.push(currentTrack.userName);
            npMeta.innerText = tags.join(' · ');
        }
        if (eqBars) eqBars.style.display = 'flex';
        if (npThumbWrap) {
            npThumbWrap.outerHTML = `<img class="np-thumb" id="np-thumb-wrap" src="https://img.youtube.com/vi/${currentTrack.videoId}/mqdefault.jpg" onerror="this.style.display='none'" />`;
        }
    } else {
        if (npTitle) npTitle.innerText = 'Sin reproducción';
        if (npMeta) npMeta.innerText = '—';
        if (eqBars) eqBars.style.display = 'none';
    }

    // Wait time estimate
    const waitMins = document.getElementById('client-wait-mins');
    const waitPill = document.getElementById('client-wait-pill');
    const avgSongLen = 3.5;
    const waitTime = Math.round(queue.length * avgSongLen);
    if (waitMins) waitMins.innerText = waitTime;
    if (waitPill) waitPill.classList.toggle('hidden', queue.length === 0);

    // Queue list
    const qList = document.getElementById('client-queue-list');
    if (qList) {
        if (queue.length === 0) {
            qList.innerHTML = `<div style="text-align:center;padding:32px 16px;color:var(--text-muted);">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin:0 auto 8px;display:block;opacity:0.4;"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                <p style="font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;opacity:0.5;">Cola vacía — ¡Pide la primera!</p>
            </div>`;
        } else {
            qList.innerHTML = queue.map((s, idx) => `
                <div class="queue-item" style="animation-delay:${idx * 0.04}s;">
                    <span class="queue-rank">${idx + 1}</span>
                    <img class="queue-thumb" src="https://img.youtube.com/vi/${s.videoId}/default.jpg" onerror="this.style.display='none'">
                    <div class="queue-info">
                        <div class="queue-title">${s.title}</div>
                        <div class="queue-meta">${s.isKaraoke ? '🎤' : '🎵'} ${s.showName ? s.userName : 'Anónimo'}</div>
                    </div>
                    <button class="vote-btn" onclick="voteSong('${s.id}', ${s.votes || 0})">
                        🔥 <span>${s.votes || 0}</span>
                    </button>
                </div>
            `).join('');
        }
    }

    // DJ queue badge
    const qBadge = document.getElementById('sb-queue-count');
    if (qBadge) {
        qBadge.style.display = queue.length > 0 ? 'block' : 'none';
        qBadge.innerText = queue.length;
    }
}

function updateDJQueuePanel() {
    const list = document.getElementById('dj-queue-list');
    if (!list) return;
    const allItems = currentTrack ? [currentTrack, ...queue] : queue;
    if (allItems.length === 0) {
        list.innerHTML = '<p style="text-align:center;color:var(--text-muted);font-size:0.8rem;padding:24px 0;font-weight:600;">Cola vacía</p>';
        return;
    }
    list.innerHTML = allItems.map((s, idx) => `
        <div style="display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px;${s.status === 'playing' ? 'background:rgba(232,54,42,0.08);border:1px solid rgba(232,54,42,0.15);' : ''}">
            <img src="https://img.youtube.com/vi/${s.videoId}/default.jpg" style="width:48px;height:36px;object-fit:cover;border-radius:6px;flex-shrink:0;">
            <div style="flex:1;min-width:0;">
                <div class="font-display" style="font-size:0.9rem;font-weight:700;font-style:italic;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;${s.status === 'playing' ? 'color:var(--accent-red);' : ''}">${s.status === 'playing' ? '▶ ' : ''}${s.title}</div>
                <div style="font-size:0.65rem;color:var(--text-muted);font-weight:600;text-transform:uppercase;letter-spacing:0.05em;margin-top:1px;">${s.isKaraoke ? '🎤' : '🎵'} ${s.showName ? s.userName : 'Anónimo'} · 🔥 ${s.votes || 0}</div>
            </div>
        </div>
    `).join('');
    // Update admin title
    if (currentTrack) {
        const adminTitle = document.getElementById('admin-current-title');
        if (adminTitle) adminTitle.innerText = currentTrack.title;
        updatePlayIcon(); updateDedicationCard(); renderDJPanelQueue();
    }
}

/* ═══════════════════════════════════════
   MODULE: SEARCH
═══════════════════════════════════════ */
function openSearch() {
    document.getElementById('search-modal').classList.remove('hidden');
}
function closeSearch() {
    document.getElementById('search-modal').classList.add('hidden');
    document.getElementById('search-input').value = '';
    document.getElementById('search-results').innerHTML = `<p style="text-align:center;color:var(--text-muted);font-size:0.75rem;font-weight:600;padding:16px;text-transform:uppercase;letter-spacing:0.08em;">Escribe para buscar</p>`;
    document.getElementById('search-results').style.display = '';
    document.getElementById('final-step-container').classList.add('hidden');
    document.getElementById('search-modal-footer').style.display = 'none';
    const btn = document.getElementById('confirm-order-btn');
    if (btn) { btn.disabled = false; btn.innerHTML = '🚀 Enviar a la cola'; }
    selectedVideo = null;
}

function debounceSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(performSearch, 600);
}

async function performSearch() {
    const q = document.getElementById('search-input').value.trim();
    const resultsEl = document.getElementById('search-results');
    if (q.length < 2) {
        resultsEl.innerHTML = `<p style="text-align:center;color:var(--text-muted);font-size:0.75rem;font-weight:600;padding:16px;text-transform:uppercase;letter-spacing:0.08em;">Escribe para buscar</p>`;
        return;
    }
    resultsEl.innerHTML = `<div style="text-align:center;padding:20px;"><div class="loading-spinner" style="margin:0 auto;width:24px;height:24px;"></div></div>`;
    document.getElementById('final-step-container').classList.add('hidden');
    document.getElementById('search-modal-footer').style.display = 'none';
    try {
        const query = searchType === 'karaoke' ? `${q} karaoke` : q;
        const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&q=${encodeURIComponent(query)}&maxResults=8&key=${YOUTUBE_API_KEY}`;
        const res = await fetch(url);
        const data = await res.json();
        if (!data || !Array.isArray(data.items) || data.items.length === 0) {
            resultsEl.innerHTML = `<p style="text-align:center;color:var(--text-muted);font-size:0.75rem;font-weight:600;padding:16px;text-transform:uppercase;letter-spacing:0.08em;">Sin resultados</p>`;
            return;
        }
        resultsEl.innerHTML = data.items.map(i => {
            const videoId = i.id?.videoId || '';
            const title = (i.snippet.title || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
            const thumb = i.snippet.thumbnails?.default?.url || '';
            return `<div class="search-result-item" onclick="selectForOrder('${videoId}', '${title}', '')">
                <img class="search-result-thumb" src="${thumb}">
                <div style="flex:1;min-width:0;">
                    <div class="search-result-title">${title}</div>
                </div>
            </div>`;
        }).join('');
    } catch(e) {
        resultsEl.innerHTML = `<p style="text-align:center;color:var(--accent-red);font-size:0.75rem;font-weight:600;padding:16px;text-transform:uppercase;letter-spacing:0.08em;">Error de búsqueda</p>`;
    }
}

function selectForOrder(videoId, title, artist) {
    selectedVideo = { videoId, title: title.replace(/&#39;/g, "'").replace(/&quot;/g, '"'), artist };
    document.getElementById('search-results').style.display = 'none';
    document.getElementById('selected-song-preview').innerText = selectedVideo.title;
    document.getElementById('final-step-container').classList.remove('hidden');
    document.getElementById('search-modal-footer').style.display = 'block';
}

async function confirmOrder() {
    if (!selectedVideo) return;
    const btn = document.getElementById('confirm-order-btn');
    
    // CAMBIO 1: Cooldown de 3 minutos
    const lastOrderTs = localStorage.getItem('rocola_last_order_ts');
    const cooldownMs = 180000; // 3 minutos
    if (lastOrderTs) {
        const elapsed = Date.now() - parseInt(lastOrderTs);
        if (elapsed < cooldownMs) {
            const remaining = cooldownMs - elapsed;
            const mins = Math.floor(remaining / 60000);
            const secs = Math.floor((remaining % 60000) / 1000);
            localStorage.setItem('rocola_cooldown_remaining', JSON.stringify({ mins, secs, until: parseInt(lastOrderTs) + cooldownMs }));
            closeSearch();
            switchClientTab('request');
            return;
        }
    }
    
    btn.disabled = true;
    btn.innerHTML = '<div class="loading-spinner" style="width:18px;height:18px;margin:0 auto;"></div>';
    try {
        const u = JSON.parse(localStorage.getItem('rocola_user_v1'));
        await db.collection(`artifacts/${appId}/public/data/rocola_queue`).add({
            ...selectedVideo,
            status: (!currentTrack && queue.length === 0) ? 'playing' : 'pending',
            votes: 1, userId: u.id, userName: u.name,
            dedication: document.getElementById('song-dedication').value,
            showName: document.getElementById('song-show-name').checked,
            isKaraoke: searchType === 'karaoke',
            showDedication: false, lastCommand: 'play',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        // CAMBIO 1: Guardar timestamp del último pedido
        localStorage.setItem('rocola_last_order_ts', Date.now().toString());
        toast('¡Canción enviada a la cola! 🎵', 'success');
        closeSearch();
        switchClientTab('queue');
    } catch(err) {
        console.error('Error sending song:', err);
        btn.disabled = false;
        btn.innerHTML = '🚀 Enviar a la cola';
        toast('Error al enviar. Intenta de nuevo.', 'error');
    }
}

function setSearchType(t) {
    searchType = t;
    document.getElementById('btn-type-music').className = t === 'music' ? 'search-type-btn active' : 'search-type-btn';
    document.getElementById('btn-type-karaoke').className = t === 'karaoke' ? 'search-type-btn active' : 'search-type-btn';
    if (document.getElementById('search-input').value.length >= 2) performSearch();
}

/* ═══════════════════════════════════════
   MODULE: REGISTRATION
═══════════════════════════════════════ */
function checkClientRegistration() {
    try {
        const u = JSON.parse(localStorage.getItem('rocola_user_v1'));
        if (u && u.id) setMode('client');
        else {
            document.getElementById('registration-screen').classList.remove('hidden');
            document.getElementById('menu-screen').classList.add('hidden');
        }
    } catch(e) {
        document.getElementById('registration-screen').classList.remove('hidden');
        document.getElementById('menu-screen').classList.add('hidden');
    }
}

function saveUserRegistration() {
    const n = document.getElementById('reg-name').value.trim();
    const s = document.getElementById('reg-surname').value.trim();
    const w = document.getElementById('reg-whatsapp').value.trim();
    if (!n || !s || !w) { toast('Por favor completa todos los campos.', 'warning'); return; }
    localStorage.setItem('rocola_user_v1', JSON.stringify({ name: n, surname: s, whatsapp: w, id: auth.currentUser.uid }));
    document.getElementById('registration-screen').classList.add('hidden');
    setMode('client');
}

/* ═══════════════════════════════════════
   MODULE: TABLE
═══════════════════════════════════════ */
function saveTableNumber() {
    const table = document.getElementById('table-number-input').value.trim();
    if (!table) { toast('Ingresa el número o código de tu mesa.', 'warning'); return; }
    localStorage.setItem('rocola_table_v1', table);
    document.getElementById('table-modal').classList.add('hidden');
    document.getElementById('table-number-input').value = '';
    const tInfo = document.getElementById('client-table-info');
    if (tInfo) tInfo.innerText = `Mesa ${table}`;
    toast(`Mesa ${table} guardada ✓`, 'success');
}

/* ═══════════════════════════════════════
   MODULE: WAITER CALLS (Client side)
═══════════════════════════════════════ */
async function handleCallWaiter() {
    const table = localStorage.getItem('rocola_table_v1');
    if (!table) { document.getElementById('table-modal').classList.remove('hidden'); return; }
    const card = document.querySelector('.service-card:nth-child(1)');
    try {
        await sendWaiterCall(table, 'service');
        toast('Mesero en camino 🛎️', 'success');
    } catch(err) {
        toast('Error al llamar mesero. Intenta de nuevo.', 'error');
    }
}

function handleRequestBill() {
    const table = localStorage.getItem('rocola_table_v1');
    if (!table) document.getElementById('table-modal').classList.remove('hidden');
    else document.getElementById('bill-modal').classList.remove('hidden');
}

async function sendWaiterCall(table, type, extra = {}) {
    if (!isAppReady || !db) throw new Error('App no lista.');
    const u = JSON.parse(localStorage.getItem('rocola_user_v1'));
    if (!u?.id) throw new Error('Usuario no registrado.');
    const docRef = await db.collection(`artifacts/${appId}/public/data/waiter_calls`).add({
        userId: u.id, userName: u.name, table: String(table),
        type, status: 'sent',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        ...extra
    });
    return docRef.id;
}

function updateClientWaiterStatus(calls) {
    const u = JSON.parse(localStorage.getItem('rocola_user_v1'));
    if (!u) return;
    const myCalls = calls.filter(c => c.userId === u.id && c.status !== 'completed');

    const waiterCard  = document.getElementById('waiter-card');
    const waiterIcon  = document.getElementById('waiter-card-icon');
    const waiterLabel = document.getElementById('waiter-card-label');
    const waiterSub   = document.getElementById('waiter-card-sub');
    const billCard    = document.getElementById('bill-card');
    const billIcon    = document.getElementById('bill-card-icon');
    const billLabel   = document.getElementById('bill-card-label');
    const billSub     = document.getElementById('bill-card-sub');

    // Reset ambas cards a estado normal
    if (waiterCard)  { waiterCard.style.background = ''; waiterCard.style.border = ''; waiterCard.style.animation = ''; }
    if (waiterIcon)  waiterIcon.style.background = 'rgba(31,214,112,0.12)';
    if (waiterLabel) waiterLabel.innerText = 'Llamar Mesero';
    if (waiterSub)   waiterSub.innerText   = 'Solicitar atención';
    if (billCard)    { billCard.style.background = ''; billCard.style.border = ''; billCard.style.animation = ''; }
    if (billIcon)    billIcon.style.background = 'rgba(240,180,41,0.12)';
    if (billLabel)   billLabel.innerText = 'Pedir Cuenta';
    if (billSub)     billSub.innerText   = 'Elegir forma de pago';

    myCalls.forEach(call => {
        const isSent   = call.status === 'sent';
        const isOnWay  = call.status === 'on_way';

        if (call.type === 'service') {
            if (!waiterCard) return;
            if (isSent) {
                waiterCard.style.background  = 'rgba(31,214,112,0.15)';
                waiterCard.style.border      = '1px solid rgba(31,214,112,0.4)';
                waiterCard.style.animation   = 'pulse-green 2s ease-in-out infinite';
                if (waiterIcon)  waiterIcon.style.background  = 'rgba(31,214,112,0.25)';
                if (waiterLabel) waiterLabel.innerText = 'Mesero notificado ✓';
                if (waiterSub)   waiterSub.innerText   = 'Esperando respuesta...';
            } else if (isOnWay) {
                waiterCard.style.background  = 'rgba(31,214,112,0.25)';
                waiterCard.style.border      = '1px solid rgba(31,214,112,0.6)';
                waiterCard.style.animation   = '';
                if (waiterIcon)  waiterIcon.style.background  = 'rgba(31,214,112,0.35)';
                if (waiterLabel) waiterLabel.innerText = 'Mesero en camino 🚶';
                if (waiterSub)   waiterSub.innerText   = 'Ya va para tu mesa';
            }
        }

        if (call.type === 'bill') {
            if (!billCard) return;
            if (isSent) {
                billCard.style.background  = 'rgba(240,180,41,0.15)';
                billCard.style.border      = '1px solid rgba(240,180,41,0.4)';
                billCard.style.animation   = 'pulse-amber 2s ease-in-out infinite';
                if (billIcon)  billIcon.style.background  = 'rgba(240,180,41,0.25)';
                if (billLabel) billLabel.innerText = 'Solicitud enviada ✓';
                if (billSub)   billSub.innerText   = 'Esperando respuesta...';
            } else if (isOnWay) {
                billCard.style.background  = 'rgba(240,180,41,0.25)';
                billCard.style.border      = '1px solid rgba(240,180,41,0.6)';
                billCard.style.animation   = '';
                if (billIcon)  billIcon.style.background  = 'rgba(240,180,41,0.35)';
                if (billLabel) billLabel.innerText = 'Cuenta en camino 🚶';
                if (billSub)   billSub.innerText   = 'El mesero ya va';
            }
        }
    });
}

/* ═══════════════════════════════════════
   MODULE: BILL
═══════════════════════════════════════ */
function selectPayment(type) {
    selectedPayment = type;
    document.getElementById('pay-efectivo').className = type === 'efectivo' ? 'payment-option selected' : 'payment-option';
    document.getElementById('pay-tarjeta').className  = type === 'tarjeta'  ? 'payment-option selected' : 'payment-option';
    checkBillForm();
}
function selectSatisfaction(level) {
    selectedSatisfactionValue = level;
    document.querySelectorAll('.sat-btn').forEach((btn, i) => {
        btn.classList.toggle('active', (i + 1) === level);
    });
    checkBillForm();
}
function checkBillForm() {
    const btn = document.getElementById('confirm-bill-btn');
    if (selectedPayment && selectedSatisfactionValue > 0) {
        btn.disabled = false;
        btn.style.opacity = '1';
    }
}
function closeBillModal() {
    document.getElementById('bill-modal').classList.add('hidden');
    selectedPayment = null; selectedSatisfactionValue = 0;
    document.querySelectorAll('.sat-btn').forEach(b => b.classList.remove('active'));
    const btn = document.getElementById('confirm-bill-btn');
    btn.disabled = true; btn.style.opacity = '0.5';
}
async function sendBillRequest() {
    const table = localStorage.getItem('rocola_table_v1');
    if (!table) { toast('Mesa no asignada.', 'warning'); return; }
    const btn = document.getElementById('confirm-bill-btn');
    btn.disabled = true; btn.innerText = 'Enviando...';
    try {
        await sendWaiterCall(table, 'bill', { payment: selectedPayment, satisfaction: selectedSatisfactionValue });
        toast('Solicitud de cuenta enviada 💳', 'success');
        setTimeout(() => closeBillModal(), 1000);
    } catch(err) {
        btn.disabled = false; btn.innerText = 'Enviar solicitud';
        toast('Error al enviar solicitud.', 'error');
    }
}

/* ═══════════════════════════════════════
   MODULE: WAITER VIEW (Staff)
═══════════════════════════════════════ */
function loadWaiterInitialData() {
    db.collection(`artifacts/${appId}/public/data/waiter_calls`).get()
        .then(snap => updateWaiterView(snap.docs.map(d => ({ id: d.id, ...d.data() }))))
        .catch(err => console.error('Error loading waiter data:', err));
}

function updateWaiterView(calls) {
    if (!calls) calls = [];
    const activeCalls    = calls.filter(c => c.status !== 'completed');
    const completedCalls = calls.filter(c => c.status === 'completed');

    const el = (id) => document.getElementById(id);
    if (el('waiter-stat-open'))    el('waiter-stat-open').innerText    = activeCalls.length;
    if (el('waiter-stat-closed'))  el('waiter-stat-closed').innerText  = completedCalls.length;

    const ratedCalls = completedCalls.filter(c => c.satisfaction);
    if (ratedCalls.length > 0 && el('waiter-stat-satisfaction')) {
        const avg = ratedCalls.reduce((a, c) => a + c.satisfaction, 0) / ratedCalls.length;
        el('waiter-stat-satisfaction').innerText = ["😫","😫","☹️","😐","🙂","🤩"][Math.round(avg)];
    }
    if (completedCalls.length > 0 && el('waiter-stat-avg')) {
        const avgT = completedCalls.reduce((a, c) => a + (c.responseTime || 0), 0) / completedCalls.length;
        el('waiter-stat-avg').innerText = Math.round(avgT / 60) + 'm';
    }

    const list = el('waiter-calls-list');
    if (list) {
        if (activeCalls.length === 0) {
            list.innerHTML = '<p style="text-align:center;color:var(--text-muted);font-size:0.8rem;padding:32px 0;font-weight:600;grid-column:1/-1;">Sin solicitudes pendientes ✓</p>';
        } else {
            list.innerHTML = activeCalls.map(c => `
                <div class="call-card ${c.type === 'bill' ? 'bill-type' : ''}">
                    <div class="call-card-header">
                        <div>
                            <div class="call-table">Mesa ${c.table}</div>
                            <div class="call-type-label">${c.type === 'bill' ? `💰 Cuenta · ${(c.payment || '').toUpperCase()}` : '🛎️ Servicio'}</div>
                        </div>
                        <span class="call-status-badge ${c.status === 'sent' ? 'badge-waiting pulse-red' : 'badge-onway'}">
                            ${c.status === 'sent' ? 'Esperando' : 'En camino'}
                        </span>
                    </div>
                    <button onclick="updateCallStatus('${c.id}', '${c.status === 'sent' ? 'on_way' : 'completed'}')" class="btn ${c.status === 'sent' ? 'btn-indigo' : 'btn-success'} btn-full">
                        ${c.status === 'sent' ? 'Tomar pedido' : '✓ Completar'}
                    </button>
                </div>
            `).join('');
        }
    }

    // History table
    const closedList = el('waiter-closed-list');
    if (closedList) {
        const sessions = {};
        completedCalls.forEach(c => {
            if (!sessions[c.table]) sessions[c.table] = { reqs: 0, time: 0, satisf: 0, count: 0 };
            sessions[c.table].reqs++;
            sessions[c.table].time += (c.responseTime || 0);
            if (c.satisfaction) { sessions[c.table].satisf += c.satisfaction; sessions[c.table].count++; }
        });
        const keys = Object.keys(sessions);
        if (keys.length === 0) {
            closedList.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);padding:24px;">Sin historial</td></tr>';
        } else {
            const faces = ['-','😫','☹️','😐','🙂','🤩'];
            closedList.innerHTML = keys.map(mesa => {
                const s = sessions[mesa];
                return `<tr>
                    <td><span style="font-weight:700;color:var(--text-primary);">Mesa ${mesa}</span></td>
                    <td style="text-align:center;">${s.reqs}</td>
                    <td style="text-align:center;">${Math.round(s.time / s.reqs / 60)} min</td>
                    <td style="text-align:center;">${s.count > 0 ? faces[Math.round(s.satisf / s.count)] : '—'}</td>
                </tr>`;
            }).join('');
        }
    }
}

async function updateCallStatus(id, newStatus) {
    const ref = db.collection(`artifacts/${appId}/public/data/waiter_calls`).doc(id);
    const snap = await ref.get();
    const update = { status: newStatus };
    if (newStatus === 'completed') update.responseTime = Math.floor(Date.now() / 1000) - (snap.data().createdAt?.seconds || 0);
    await ref.update(update);
    toast(newStatus === 'completed' ? 'Solicitud completada ✓' : 'En camino 🚶', 'success');
}

/* ═══════════════════════════════════════
   MODULE: DJ / ADMIN
═══════════════════════════════════════ */
function updateAdminDashboard(items) {
    const totalEl = document.getElementById('stat-total-today');
    const topEl   = document.getElementById('stat-top-song');
    const rpmEl   = document.getElementById('stat-songs-hour');
    if (totalEl) totalEl.innerText = items.length;
    if (items.length > 0) {
        const top = [...items].sort((a, b) => b.votes - a.votes)[0];
        if (topEl) topEl.innerText = top.title;
        const first = items.reduce((acc, i) => Math.min(acc, i.createdAt?.seconds || Infinity), Infinity);
        const hours = Math.max((Math.floor(Date.now() / 1000) - first) / 3600, 0.2);
        if (rpmEl) rpmEl.innerText = Math.round(items.length / hours);
    }
}

function sendCommand(cmd, extra = {}) {
    if (!currentTrack) return;
    db.collection(`artifacts/${appId}/public/data/rocola_queue`).doc(currentTrack.id).update({ lastCommand: cmd, commandId: Math.random(), ...extra });
    currentTrack.lastCommand = cmd;
    updatePlayIcon();
}
function handleDJToggle() {
    if (!currentTrack) return;
    const isPaused = currentTrack.lastCommand === 'pause';
    sendCommand(isPaused ? 'play' : 'pause');
    const icon = document.getElementById('dj-play-icon');
    if (icon) {
        icon.innerHTML = isPaused
            ? '<polygon points="5,3 19,12 5,21"/>'
            : '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>';
    }
}

function updatePlayIcon() {
    const playBtn  = document.getElementById('dj-play-btn');
    const pauseBtn = document.getElementById('dj-pause-btn');
    if (!playBtn || !pauseBtn) return;
    const isPaused = !currentTrack || currentTrack.lastCommand === 'pause';
    playBtn.style.display  = isPaused ? 'flex' : 'none';
    pauseBtn.style.display = isPaused ? 'none' : 'flex';
}

function setPlayerVolume(val) {
    if (player && typeof player.setVolume === 'function') {
        try { player.setVolume(parseInt(val)); } catch(e) {}
    }
    const label = document.getElementById('dj-vol-label');
    if (label) label.innerText = val;
    isAdminMuted = parseInt(val) === 0;
    const btn = document.getElementById('admin-mute-btn');
    if (btn) btn.classList.toggle('muted', isAdminMuted);
}

let progressInterval = null;
function startProgressBar() {
    if (progressInterval) clearInterval(progressInterval);
    const fill = document.getElementById('dj-progress');
    if (!fill) return;
    progressInterval = setInterval(() => {
        if (!player || typeof player.getCurrentTime !== 'function') return;
        try {
            const cur = player.getCurrentTime();
            const dur = player.getDuration();
            if (dur > 0) fill.style.width = ((cur / dur) * 100) + '%';
        } catch(e) {}
    }, 1000);
}

async function toggleDedication() {
    if (!currentTrack) return;
    const newVal = !currentTrack.showDedication;
    await db.collection(`artifacts/${appId}/public/data/rocola_queue`).doc(currentTrack.id).update({ showDedication: newVal });
    const btn = document.getElementById('toggle-dedication-btn');
    if (btn) {
        btn.style.background   = newVal ? 'rgba(91,110,245,0.2)' : '';
        btn.style.borderColor  = newVal ? 'rgba(91,110,245,0.5)' : '';
        btn.style.color        = newVal ? 'var(--accent-indigo)' : '';
    }
}
async function skipSong() {
    await fadeOutPlayer();
    const trackToDelete = currentTrack;
    const nextTrack = queue.length > 0 ? queue[0] : null;
    if (nextTrack) {
        await db.collection(`artifacts/${appId}/public/data/rocola_queue`).doc(nextTrack.id).update({
            status: 'playing',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            showDedication: false,
            lastCommand: 'play'
        });
    }
    if (trackToDelete) {
        await db.collection(`artifacts/${appId}/public/data/rocola_queue`).doc(trackToDelete.id).delete();
    }
}

function fadeOutPlayer() {
    return new Promise(resolve => {
        if (!player || typeof player.getVolume !== 'function') { resolve(); return; }
        let vol = player.getVolume();
        const step = setInterval(() => {
            vol = Math.max(0, vol - 8);
            try { player.setVolume(vol); } catch(e) {}
            if (vol <= 0) { clearInterval(step); resolve(); }
        }, 50);
    });
}

function fadeInPlayer() {
    if (!player || typeof player.setVolume !== 'function') return;
    const targetVol = isAdminMuted ? 0 : 100;
    let vol = 0;
    player.setVolume(0);
    const step = setInterval(() => {
        vol = Math.min(targetVol, vol + 8);
        try { player.setVolume(vol); } catch(e) {}
        if (vol >= targetVol) clearInterval(step);
    }, 50);
}
async function voteSong(id, v) {
    // CAMBIO 2: Un voto por canción por usuario
    const votes = JSON.parse(localStorage.getItem('rocola_votes') || '{}');
    if (votes[id] === true) {
        toast('Ya votaste por esta canción', 'info');
        return;
    }
    
    await db.collection(`artifacts/${appId}/public/data/rocola_queue`).doc(id).update({ votes: v + 1 });
    
    // Guardar el voto en localStorage
    votes[id] = true;
    localStorage.setItem('rocola_votes', JSON.stringify(votes));
}
function toggleAdminMute() {
    if (!player) return;
    isAdminMuted = !isAdminMuted;
    try { isAdminMuted ? player.mute?.() : player.unMute?.(); } catch(e) {}
    document.getElementById('mute-icon').innerHTML = isAdminMuted
        ? `<path d="M11 5L6 9H2v6h4l5 4V5z"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/>`
        : `<path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>`;
}

/* ═══════════════════════════════════════
   MODULE: YOUTUBE
═══════════════════════════════════════ */
function initYouTube(divId) {
    if (window.YT && window.YT.Player) createPlayer(divId);
    else {
        window.onYouTubeIframeAPIReady = () => createPlayer(divId);
    }
}
function createPlayer(divId) {
    const isDisplay = divId === 'display-yt-player';
    player = new window.YT.Player(divId, {
        height: '100%', width: '100%',
        videoId: currentTrack?.videoId || '',
        playerVars: {
            autoplay: 1, controls: 0, modestbranding: 1,
            rel: 0, enablejsapi: 1, fs: 1, iv_load_policy: 3,
            mute: isDisplay ? 1 : 0,
            origin: window.location.origin
        },
        events: {
            onReady: (e) => {
                if (currentMode === 'admin' && isAdminMuted) e.target.mute();
                if (isDisplay) { e.target.unMute(); e.target.setVolume(100); }
                if (currentTrack) syncVideo();
            },
            onStateChange: (e) => {
                if (e.data === window.YT.PlayerState.ENDED) { skipSong(); return; }
                updatePlayIcon();
                if (e.data === window.YT.PlayerState.PLAYING) {
                    const overlay = document.getElementById('player-overlay');
                    if (overlay) overlay.style.opacity = '0';
                    startProgressBar();
                }
            },
            onError: (e) => {
                console.error('Player error:', e.data);
                setTimeout(() => skipSong(), 2000);
            }
        }
    });
}
function syncVideo() {
    if (!currentTrack || !currentTrack.videoId) return;
    if (!player) {
        if (currentMode === 'display') initYouTube('display-yt-player');
        else if (currentMode === 'admin') initYouTube('yt-player');
        return;
    }
    try {
        let currentVideoId = '';
        try { currentVideoId = player.getVideoData?.()?.video_id || ''; } catch(e) {}
        const overlay = document.getElementById('player-overlay');
        if (currentVideoId !== currentTrack.videoId) {
            player.loadVideoById?.(currentTrack.videoId);
        }
        setTimeout(() => {
            if (!player || !currentTrack) return;
            if (currentTrack.lastCommand === 'pause') {
                player.pauseVideo?.();
            } else {
                player.playVideo?.();
                if (overlay) overlay.style.opacity = '0';
            }
            updatePlayIcon();
            startProgressBar();
        }, 800);
        if (currentTrack.lastCommand === 'seek' && currentTrack.offset) {
            player.seekTo?.(player.getCurrentTime?.() + currentTrack.offset, true);
            sendCommand('play');
        }
    } catch(e) { console.error('syncVideo error:', e); }
}
function openTVTab() {
    const tvUrl = window.location.origin + '/tv.html';
    window.open(tvUrl, '_blank');
}
function copyRoleLink(mode) {
    const url = `${window.location.origin}${window.location.pathname}?mode=${mode}`;
    navigator.clipboard.writeText(url).then(() => toast('Enlace copiado al portapapeles', 'info'));
}

/* ═══════════════════════════════════════
   MODULE: ADMIN AUTH (CAMBIO 6)
═══════════════════════════════════════ */
// SETUP: Para crear el superadmin inicial, ejecuta esto UNA VEZ en la consola de Firebase:
// db.collection(`artifacts/rocola-crowdplay2-v1/public/data/staff_profiles`).doc('UID_DEL_USUARIO').set({ email: 'admin@tucorreo.com', name: 'Admin', role: 'superadmin', createdAt: new Date() });

async function adminLogin() {
    const email = document.getElementById('admin-email').value.trim();
    const password = document.getElementById('admin-password').value;
    const errEl = document.getElementById('admin-login-error');
    errEl.style.display = 'none';
    if (!email || !password) { errEl.innerText = 'Completa todos los campos.'; errEl.style.display = 'block'; return; }
    try {
        const btn = document.querySelector('#admin-login-screen button');
        btn.innerText = 'Verificando...'; btn.disabled = true;
        await auth.signInWithEmailAndPassword(email, password);
        const user = auth.currentUser;
        // Leer rol del usuario desde Firestore
        console.log('UID encontrado:', user.uid);
        console.log('Buscando en:', `artifacts/${appId}/public/data/staff_profiles`);
        const profileDoc = await db.collection(`artifacts/${appId}/public/data/staff_profiles`).doc(user.uid).get();
        console.log('Documento existe:', profileDoc.exists);
        if (!profileDoc.exists) throw new Error('Perfil no encontrado. Contacta al administrador.');
        const profile = profileDoc.data();
        document.getElementById('admin-login-screen').classList.add('hidden');
        currentMode = 'admin';
        startRealtimeSync();
        // Redirigir según rol
        if (profile.role === 'superadmin') showAdminPanel(profile);
        else setMode(profile.role === 'dj' ? 'admin' : profile.role);
    } catch(err) {
        const msg = err.code === 'auth/wrong-password' ? 'Contraseña incorrecta.' :
                    err.code === 'auth/user-not-found'  ? 'Usuario no encontrado.' :
                    err.code === 'auth/invalid-email'   ? 'Email inválido.' : err.message;
        const errEl = document.getElementById('admin-login-error');
        errEl.innerText = msg; errEl.style.display = 'block';
        const btn = document.querySelector('#admin-login-screen button');
        btn.innerText = 'Ingresar'; btn.disabled = false;
    }
}

function showAdminPanel(profile) {
    document.getElementById('staff-app').classList.remove('hidden');
    const chip = document.getElementById('staff-role-chip');
    if (chip) { chip.innerText = 'SUPER ADMIN'; chip.style.background = 'rgba(232,54,42,0.15)'; chip.style.borderColor = 'rgba(232,54,42,0.3)'; chip.style.color = 'var(--accent-red)'; }
    currentMode = 'admin';
    switchStaffPanel('dashboard');
}

async function createStaffAccount() {
    const email    = document.getElementById('new-staff-email').value.trim();
    const password = document.getElementById('new-staff-password').value;
    const name     = document.getElementById('new-staff-name').value.trim();
    const role     = document.getElementById('new-staff-role').value;
    if (!email || !password || !name) { toast('Completa todos los campos.', 'warning'); return; }
    if (password.length < 6) { toast('La contraseña debe tener al menos 6 caracteres.', 'warning'); return; }
    try {
        const secondaryApp = firebase.initializeApp(firebaseConfig, 'secondary_' + Date.now());
        const secondaryAuth = secondaryApp.auth();
        const cred = await secondaryAuth.createUserWithEmailAndPassword(email, password);
        const newUid = cred.user.uid;
        await secondaryAuth.signOut();
        secondaryApp.delete();
        await db.collection(`artifacts/${appId}/public/data/staff_profiles`).doc(newUid).set({
            email, name, role,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: auth.currentUser.uid
        });
        toast(`Cuenta de ${name} (${role}) creada ✓`, 'success');
        loadStaffList();
        ['new-staff-email','new-staff-password','new-staff-name'].forEach(id => document.getElementById(id).value = '');
    } catch(err) {
        const msg = err.code === 'auth/email-already-in-use' ? 'Este email ya está registrado.' : err.message;
        toast(msg, 'error');
    }
}

async function loadStaffList() {
    const listEl = document.getElementById('staff-list');
    if (!listEl) return;
    try {
        const snap = await db.collection(`artifacts/${appId}/public/data/staff_profiles`).get();
        if (snap.empty) { listEl.innerHTML = '<p style="color:var(--text-muted);font-size:0.8rem;text-align:center;padding:20px 0;">Sin cuentas creadas</p>'; return; }
        const roleLabels = { waiter: 'Mesero', dj: 'DJ', analytics: 'Analytics', superadmin: 'Super Admin' };
        listEl.innerHTML = snap.docs.map(doc => {
            const d = doc.data();
            return `<div style="display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border);">
                <div>
                    <div style="font-weight:700;font-size:0.9rem;color:var(--text-primary);">${d.name}</div>
                    <div style="font-size:0.7rem;color:var(--text-muted);font-weight:600;">${d.email} · ${roleLabels[d.role] || d.role}</div>
                </div>
                <button onclick="deleteStaffAccount('${doc.id}')" style="background:rgba(232,54,42,0.1);border:1px solid rgba(232,54,42,0.2);border-radius:8px;padding:6px 10px;color:var(--accent-red);font-size:0.7rem;font-weight:700;cursor:pointer;text-transform:uppercase;letter-spacing:0.05em;">
                    Eliminar
                </button>
            </div>`;
        }).join('');
    } catch(err) { listEl.innerHTML = '<p style="color:var(--accent-red);font-size:0.8rem;text-align:center;padding:20px 0;">Error cargando lista</p>'; }
}

async function deleteStaffAccount(uid) {
    if (!confirm('¿Eliminar esta cuenta? Esta acción no puede deshacerse.')) return;
    try {
        await db.collection(`artifacts/${appId}/public/data/staff_profiles`).doc(uid).delete();
        toast('Cuenta eliminada (el acceso de Firebase Auth debe borrarse manualmente en la consola).', 'info', 5000);
        loadStaffList();
    } catch(err) { toast('Error al eliminar: ' + err.message, 'error'); }
}

/* ═══════════════════════════════════════
   MODULE: ANALYTICS
═══════════════════════════════════════ */
let analyticsPeriod = 'today';
let analyticsDateFrom = null;
let analyticsDateTo = null;

function initAnalytics() {
    console.log('initAnalytics llamado');
    setAnalyticsPeriod('today');
}

function setAnalyticsPeriod(period) {
    console.log('setAnalyticsPeriod:', period);
    analyticsPeriod = period;
    analyticsDateFrom = null; analyticsDateTo = null;
    document.getElementById('custom-date-range').classList.add('hidden');
    updateAnalyticsButtons();
    loadAnalyticsData();
}

function toggleCustomDateRange() {
    const el = document.getElementById('custom-date-range');
    el.classList.toggle('hidden');
    el.style.display = el.classList.contains('hidden') ? 'none' : 'flex';
}

function applyCustomDateRange() {
    const from = document.getElementById('date-from').value;
    const to   = document.getElementById('date-to').value;
    if (!from || !to) { toast('Completa ambas fechas', 'warning'); return; }
    analyticsDateFrom = new Date(from).getTime() / 1000;
    analyticsDateTo   = new Date(to).getTime() / 1000 + 86400;
    analyticsPeriod = 'custom';
    updateAnalyticsButtons();
    loadAnalyticsData();
}

function updateAnalyticsButtons() {
    document.querySelectorAll('.period-tab').forEach(b => b.classList.remove('active'));
    const active = document.getElementById(`btn-period-${analyticsPeriod}`);
    if (active) active.classList.add('active');
}

async function loadAnalyticsData() {
    try {
        if (!db) {
            console.error('db no inicializado');
            toast('Firebase no está listo. Intenta de nuevo.', 'error');
            return;
        }
        const { dateFrom, dateTo } = getDateRange();
        console.log('Cargando analytics desde', new Date(dateFrom*1000), 'hasta', new Date(dateTo*1000));
        const tsFrom = new Date(dateFrom * 1000);
        const tsTo = new Date(dateTo * 1000);
        const [waiterSnap, queueSnap] = await Promise.all([
            db.collection(`artifacts/${appId}/public/data/waiter_calls`).where('createdAt','>=',tsFrom).where('createdAt','<',tsTo).get(),
            db.collection(`artifacts/${appId}/public/data/rocola_queue`).where('createdAt','>=',tsFrom).where('createdAt','<',tsTo).get()
        ]);
        console.log('Waiter calls:', waiterSnap.docs.length, 'Queue items:', queueSnap.docs.length);
        calculateMetrics(
            waiterSnap.docs.map(d => ({ id: d.id, ...d.data() })),
            queueSnap.docs.map(d => ({ id: d.id, ...d.data() })),
            dateFrom, dateTo
        );
    } catch(err) {
        console.error('Analytics error:', err);
        toast('Error al cargar métricas: ' + err.message, 'error');
    }
}

function getDateRange() {
    const now = Math.floor(Date.now() / 1000);
    const today = new Date(); today.setHours(0,0,0,0);
    const todayS = Math.floor(today.getTime() / 1000);
    if (analyticsPeriod === 'today')  return { dateFrom: todayS, dateTo: now };
    if (analyticsPeriod === 'week')   { const w = new Date(today); w.setDate(today.getDate()-today.getDay()); return { dateFrom: Math.floor(w.getTime()/1000), dateTo: now }; }
    if (analyticsPeriod === 'month')  return { dateFrom: Math.floor(new Date(today.getFullYear(), today.getMonth(), 1).getTime()/1000), dateTo: now };
    if (analyticsPeriod === 'year')   return { dateFrom: Math.floor(new Date(today.getFullYear(), 0, 1).getTime()/1000), dateTo: now };
    if (analyticsPeriod === 'custom') return { dateFrom: analyticsDateFrom || todayS, dateTo: analyticsDateTo || now };
    return { dateFrom: todayS, dateTo: now };
}

function calculateMetrics(waiterCalls, queueItems, dateFrom, dateTo) {
    const completed = waiterCalls.filter(c => c.status === 'completed');
    const rated     = completed.filter(c => c.satisfaction);

    const avgAttn    = completed.length > 0 ? Math.round(completed.reduce((a,c) => a+(c.responseTime||0),0)/completed.length/60)+' min' : '--';
    const avgQuality = rated.length > 0 ? (rated.reduce((a,c) => a+c.satisfaction,0)/rated.length).toFixed(1) : '--';
    const uniqueTbls = new Set(completed.map(c => c.table)).size;
    const avgOrders  = uniqueTbls > 0 ? (completed.length / uniqueTbls).toFixed(1) : '--';
    const hrs        = Math.max((dateTo - dateFrom) / 3600, 1);
    const sph        = hrs > 0 ? (queueItems.length / hrs).toFixed(1) : '--';

    const el = (id) => document.getElementById(id);
    if (el('analytics-avg-attention'))   el('analytics-avg-attention').innerText   = avgAttn;
    if (el('analytics-avg-quality'))     el('analytics-avg-quality').innerText     = avgQuality;
    if (el('analytics-total-tables'))    el('analytics-total-tables').innerText    = uniqueTbls;
    if (el('analytics-avg-orders'))      el('analytics-avg-orders').innerText      = avgOrders;
    if (el('analytics-songs-per-hour'))  el('analytics-songs-per-hour').innerText  = sph;
}

/* ═══════════════════════════════════════
   BOOT
═══════════════════════════════════════ */
try {
    const syncText = document.getElementById('sync-text');
    if (syncText) syncText.innerText = `Sincronizando... (${BUILD_ID})`;
    
    // En modo display, no inicializar Firebase
    const urlMode = new URLSearchParams(window.location.search).get('mode');
    if (urlMode === 'display') {
        // Modo display: solo mostrar reproductor
        if (syncText) syncText.style.display = 'none';
        setMode('display');
    } else {
        // Modo normal: inicializar Firebase
        if (!firebaseConfig) { alert('Configura Firebase.'); }
        else initFirebase();
    }
} catch(e) {
    console.error('Boot error:', e);
    const syncText = document.getElementById('sync-text');
    if (syncText) syncText.innerText = `Error: ${e.message}`;
}

function updateCooldownUI() {
    const navBtn     = document.getElementById('nav-request');
    const ctaInner   = navBtn ? navBtn.querySelector('.nav-tab-cta') : null;

    const raw = localStorage.getItem('rocola_cooldown_remaining');

    if (!raw) {
        // Sin cooldown — botón normal
        if (ctaInner) {
            ctaInner.style.background = 'var(--accent-red)';
            ctaInner.style.boxShadow  = '0 4px 20px rgba(232,54,42,0.4)';
            ctaInner.innerHTML = `<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M12 5v14M5 12h14"/></svg>`;
        }
        if (navBtn) navBtn.onclick = () => openSearch();
        return;
    }

    const { until } = JSON.parse(raw);
    const remaining = until - Date.now();

    if (remaining <= 0) {
        localStorage.removeItem('rocola_cooldown_remaining');
        updateCooldownUI();
        return;
    }

    const mins = Math.floor(remaining / 60000);
    const secs = Math.floor((remaining % 60000) / 1000);
    const label = `${mins}:${secs.toString().padStart(2, '0')}`;

    // Botón en modo cooldown
    if (ctaInner) {
        ctaInner.style.background = 'var(--bg-elevated)';
        ctaInner.style.boxShadow  = 'none';
        ctaInner.style.border     = '1px solid var(--border-mid)';
        ctaInner.innerHTML = `<span style="font-family:'Barlow Condensed',sans-serif;font-size:0.8rem;font-weight:900;color:var(--text-secondary);letter-spacing:-0.01em;line-height:1;">${label}</span>`;
    }

    // Al tocar el botón en cooldown va al tab de cola
    if (navBtn) navBtn.onclick = () => switchClientTab('queue');

    // Mostrar/ocultar vista cooldown
    const cooldownView = document.getElementById('request-cooldown-view');
    if (cooldownView) {
        cooldownView.style.display = 'block';
        const display = document.getElementById('cooldown-display');
        if (display) display.innerText = label;
    }
}

// Iniciar el ticker del cooldown cada segundo
setInterval(updateCooldownUI, 1000);
updateCooldownUI(); // ejecutar inmediatamente al cargar

// ── RIFFS ──
let riffsSelectedUser = null;

async function searchRiffsUser(query) {
    const container = document.getElementById('riffs-search-results');
    if (!query || query.length < 2) { container.innerHTML = ''; return; }
    const snap = await db.collection(`artifacts/${appId}/public/data/client_profiles`).get();
    const results = snap.docs
        .map(d => ({ id: d.id, ...d.data() }))
        .filter(u => (u.name + ' ' + (u.surname||'')).toLowerCase().includes(query.toLowerCase()));
    if (!results.length) {
        container.innerHTML = '<div style="font-size:0.78rem;color:var(--text-muted);padding:8px 0;">Sin resultados</div>';
        return;
    }
    container.innerHTML = results.slice(0,5).map(u => `
        <div onclick="selectRiffsUser('${u.id}','${u.name} ${u.surname||''}',${u.credits||0})"
             style="padding:10px 14px;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;">
            <div style="font-size:0.82rem;font-weight:700;color:var(--text-primary);">${u.name} ${u.surname||''}</div>
            <div style="font-size:0.68rem;font-weight:600;color:var(--accent-amber);">${u.credits||0} Riffs</div>
        </div>`).join('');
}

function selectRiffsUser(id, name, balance) {
    riffsSelectedUser = { id, name, balance };
    document.getElementById('riffs-search-results').innerHTML = '';
    document.getElementById('riffs-search').value = '';
    document.getElementById('riffs-user-name').innerText = name;
    document.getElementById('riffs-user-balance').innerText = balance;
    document.getElementById('riffs-selected-user').style.display = 'block';
}

function clearRiffsUser() {
    riffsSelectedUser = null;
    document.getElementById('riffs-selected-user').style.display = 'none';
    document.getElementById('riffs-search').value = '';
}

async function chargeRiffs(pack) {
    if (!riffsSelectedUser) return;
    const packs = { chico: 80, medio: 180, grande: 300 };
    const amount = packs[pack];
    const newBalance = (riffsSelectedUser.balance || 0) + amount;
    await db.collection(`artifacts/${appId}/public/data/client_profiles`).doc(riffsSelectedUser.id).update({ credits: newBalance });
    riffsSelectedUser.balance = newBalance;
    document.getElementById('riffs-user-balance').innerText = newBalance;
    toast(`+${amount} Riffs cargados a ${riffsSelectedUser.name}`, 'success');
}


// ── BANNER MANAGER ──
let bannerNewDataUrl = null;

function handleBannerUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
        bannerNewDataUrl = ev.target.result;
        const preview = document.getElementById('banner-new-preview');
        const img = document.getElementById('banner-preview-img');
        if (preview) preview.style.display = 'block';
        if (img) img.src = bannerNewDataUrl;
        // Auto-fill name from filename if empty
        const nameInput = document.getElementById('banner-name-input');
        if (nameInput && !nameInput.value) {
            nameInput.value = file.name.replace(/\.[^.]+$/, '');
        }
    };
    reader.readAsDataURL(file);
}

async function saveBanner() {
    if (!bannerNewDataUrl) { toast('Selecciona una imagen primero', 'warning'); return; }
    const name = document.getElementById('banner-name-input')?.value.trim() || 'Banner';
    const id = 'banner_' + Date.now();
    await db.collection(`artifacts/${appId}/public/data/banners`).doc(id).set({
        id, name,
        url: bannerNewDataUrl,
        active: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    // Reset form
    bannerNewDataUrl = null;
    document.getElementById('banner-name-input').value = '';
    document.getElementById('banner-file-input').value = '';
    document.getElementById('banner-new-preview').style.display = 'none';
    toast('Banner guardado', 'success');
    loadBanners();
}

async function loadBanners() {
    const container = document.getElementById('banner-list');
    if (!container) return;
    const snap = await db.collection(`artifacts/${appId}/public/data/banners`).get();
    if (snap.empty) {
        container.innerHTML = '<div style="font-size:0.72rem;color:var(--text-muted);text-align:center;padding:12px 0;">Sin banners guardados</div>';
        return;
    }
    container.innerHTML = '';
    const sortedDocs = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (a.createdAt?.seconds||0) - (b.createdAt?.seconds||0));
    sortedDocs.forEach(b => {
        const row = document.createElement('div');
        row.style.cssText = `display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg-card);border:1px solid ${b.active ? 'rgba(31,214,112,0.3)' : 'var(--border)'};border-radius:12px;`;
        row.innerHTML = `
            <img src="${b.url}" style="width:80px;height:22px;object-fit:cover;border-radius:6px;flex-shrink:0;border:1px solid var(--border);">
            <div style="flex:1;min-width:0;">
                <div style="font-size:0.78rem;font-weight:700;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${b.name}</div>
                <div style="font-size:0.62rem;color:var(--text-muted);font-weight:600;margin-top:1px;">${b.active ? '<span style="color:var(--accent-green);">● En TV</span>' : 'Inactivo'}</div>
            </div>
            <!-- Toggle switch -->
            <div onclick="toggleBanner('${b.id}', ${!b.active})" style="width:40px;height:22px;border-radius:11px;background:${b.active ? 'var(--accent-green)' : 'var(--bg-elevated)'};border:1px solid ${b.active ? 'var(--accent-green)' : 'var(--border-mid)'};cursor:pointer;position:relative;transition:all 0.2s;flex-shrink:0;">
                <div style="width:16px;height:16px;border-radius:50%;background:white;position:absolute;top:2px;${b.active ? 'right:2px;' : 'left:2px;'}transition:all 0.2s;box-shadow:0 1px 4px rgba(0,0,0,0.3);"></div>
            </div>
            <button onclick="deleteBanner('${b.id}')" style="width:28px;height:28px;background:rgba(232,54,42,0.08);border:1px solid rgba(232,54,42,0.2);border-radius:8px;color:var(--accent-red);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>`;
        container.appendChild(row);
    });
}

async function toggleBanner(id, activate) {
    try {
        const batch = db.batch();
        const snap = await db.collection(`artifacts/${appId}/public/data/banners`).get();
        snap.docs.forEach(doc => batch.update(doc.ref, { active: false }));
        if (activate) {
            batch.update(db.collection(`artifacts/${appId}/public/data/banners`).doc(id), { active: true });
        }
        await batch.commit();
        const bannerDoc = activate ? await db.collection(`artifacts/${appId}/public/data/banners`).doc(id).get() : null;
        await db.collection(`artifacts/${appId}/public/data/rocola_settings`).doc('banner').set({
            active: activate,
            url: activate && bannerDoc ? bannerDoc.data().url : '',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        loadBanners();
        toast(activate ? 'Banner activado en TV' : 'Banner desactivado', activate ? 'success' : 'info');
    } catch(e) { toast('Error al cambiar banner: ' + e.message, 'error'); console.error(e); }
}

async function deleteBanner(id) {
    if (!confirm('¿Eliminar este banner?')) return;
    try {
        await db.collection(`artifacts/${appId}/public/data/banners`).doc(id).delete();
        const setting = await db.collection(`artifacts/${appId}/public/data/rocola_settings`).doc('banner').get();
        if (setting.exists && setting.data().active) {
            await db.collection(`artifacts/${appId}/public/data/rocola_settings`).doc('banner').set({ active: false, url: '', updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        }
        loadBanners();
        toast('Banner eliminado', 'info');
    } catch(e) { toast('Error al eliminar: ' + e.message, 'error'); console.error(e); }
}

// ── SAMPLER MANAGER ──
let samplerColor = '#e8362a';
let samplerSource = 'file';
let samplerAudioData = null;
let samplerMediaRecorder = null;
let samplerRecording = false;
let samplerRecordChunks = [];

function selectSamplerColor(color) {
    samplerColor = color;
    document.getElementById('sampler-color-preview').style.background = color;
    document.querySelectorAll('.sampler-color-opt').forEach(el => {
        el.style.border = el.style.background === color || el.getAttribute('onclick').includes(color)
            ? '2px solid white' : '2px solid transparent';
    });
}

function setSamplerSource(src) {
    samplerSource = src;
    document.getElementById('sampler-file-area').style.display = src === 'file' ? 'block' : 'none';
    document.getElementById('sampler-record-area').style.display = src === 'record' ? 'block' : 'none';
    const fileBtn = document.getElementById('sampler-src-file');
    const recBtn  = document.getElementById('sampler-src-record');
    if (src === 'file') {
        fileBtn.style.background = 'rgba(91,110,245,0.12)'; fileBtn.style.color = 'var(--accent-indigo)'; fileBtn.style.borderColor = 'var(--accent-indigo)';
        recBtn.style.background  = 'transparent'; recBtn.style.color = 'var(--text-muted)'; recBtn.style.borderColor = 'var(--border-mid)';
    } else {
        recBtn.style.background  = 'rgba(232,54,42,0.12)'; recBtn.style.color = 'var(--accent-red)'; recBtn.style.borderColor = 'var(--accent-red)';
        fileBtn.style.background = 'transparent'; fileBtn.style.color = 'var(--text-muted)'; fileBtn.style.borderColor = 'var(--border-mid)';
    }
}

function handleSamplerFile(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
        samplerAudioData = ev.target.result;
        const nameEl = document.getElementById('sampler-file-name');
        nameEl.innerText = '✓ ' + file.name;
        nameEl.style.display = 'block';
    };
    reader.readAsDataURL(file);
}

async function toggleSamplerRecording() {
    const btn = document.getElementById('sampler-record-btn');
    const status = document.getElementById('sampler-record-status');
    if (!samplerRecording) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            samplerRecordChunks = [];
            samplerMediaRecorder = new MediaRecorder(stream);
            samplerMediaRecorder.ondataavailable = e => samplerRecordChunks.push(e.data);
            samplerMediaRecorder.onstop = () => {
                const blob = new Blob(samplerRecordChunks, { type: 'audio/webm' });
                const reader = new FileReader();
                reader.onload = ev => { samplerAudioData = ev.target.result; };
                reader.readAsDataURL(blob);
                stream.getTracks().forEach(t => t.stop());
                status.innerText = '✓ Audio grabado';
                status.style.color = 'var(--accent-green)';
                status.style.display = 'block';
            };
            samplerMediaRecorder.start();
            samplerRecording = true;
            btn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/></svg> Detener grabación';
            btn.style.background = 'rgba(232,54,42,0.25)';
        } catch(e) { toast('No se pudo acceder al micrófono', 'error'); }
    } else {
        samplerMediaRecorder.stop();
        samplerRecording = false;
        btn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="6"/></svg> Grabar audio';
        btn.style.background = 'rgba(232,54,42,0.12)';
    }
}

async function saveSampler() {
    const name = document.getElementById('sampler-name').value.trim();
    if (!name) { toast('Ponle nombre al sampler', 'warning'); return; }
    if (!samplerAudioData) { toast('Selecciona o graba un audio', 'warning'); return; }
    try {
        await db.collection(`artifacts/${appId}/public/data/samplers`).add({
            name, color: samplerColor, audioData: samplerAudioData,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('sampler-name').value = '';
        document.getElementById('sampler-file-name').style.display = 'none';
        document.getElementById('sampler-file-input').value = '';
        samplerAudioData = null;
        loadSamplers();
        toast('Sampler guardado', 'success');
    } catch(e) { toast('Error al guardar: ' + e.message, 'error'); }
}

async function loadSamplers() {
    const container = document.getElementById('sampler-list');
    if (!container) return;
    const snap = await db.collection(`artifacts/${appId}/public/data/samplers`).get();
    if (snap.empty) {
        container.innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:0.72rem;padding:12px;">Sin samplers guardados</div>';
        return;
    }
    const samplers = snap.docs.map(d => ({ id: d.id, ...d.data() }))
        .sort((a,b) => (a.createdAt?.seconds||0) - (b.createdAt?.seconds||0));
    container.innerHTML = samplers.map(s => `
        <div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;">
            <div style="width:12px;height:12px;border-radius:50%;background:${s.color};flex-shrink:0;"></div>
            <div style="flex:1;font-size:0.82rem;font-weight:700;color:var(--text-primary);">${s.name}</div>
            <button onclick="testSampler('${s.id}')" style="padding:5px 10px;background:rgba(31,214,112,0.1);border:1px solid rgba(31,214,112,0.25);border-radius:8px;color:var(--accent-green);font-family:'Barlow',sans-serif;font-size:0.65rem;font-weight:700;cursor:pointer;text-transform:uppercase;letter-spacing:0.08em;">▶ Test</button>
            <button onclick="deleteSampler('${s.id}')" style="padding:5px 10px;background:rgba(232,54,42,0.08);border:1px solid rgba(232,54,42,0.2);border-radius:8px;color:var(--accent-red);font-family:'Barlow',sans-serif;font-size:0.65rem;font-weight:700;cursor:pointer;text-transform:uppercase;letter-spacing:0.08em;">✕</button>
        </div>`).join('');
    // Also refresh sampler pad in player panel
    renderSamplerPad(samplers);
}

let samplerAudioCache = {};
async function testSampler(id) {
    const snap = await db.collection(`artifacts/${appId}/public/data/samplers`).doc(id).get();
    if (!snap.exists) return;
    playSamplerAudio(snap.data().audioData);
}

const _samplerAudioCtx = new (window.AudioContext || window.webkitAudioContext)();

async function playSamplerAudio(audioData) {
    try {
        const base64 = audioData.split(',')[1];
        const binary = atob(base64);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
        const buffer = await _samplerAudioCtx.decodeAudioData(bytes.buffer);
        const source = _samplerAudioCtx.createBufferSource();
        source.buffer = buffer;
        source.connect(_samplerAudioCtx.destination);
        source.start(0);
    } catch(e) {
        console.error('Sampler error:', e);
        toast('Error al reproducir: ' + e.message, 'error');
    }
}

async function deleteSampler(id) {
    if (!confirm('¿Eliminar este sampler?')) return;
    await db.collection(`artifacts/${appId}/public/data/samplers`).doc(id).delete();
    loadSamplers();
    toast('Sampler eliminado', 'info');
}

function renderSamplerPad(samplers) {
    const pad = document.getElementById('sampler-pad');
    if (!pad) return;
    if (!samplers || samplers.length === 0) {
        pad.innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:0.72rem;padding:16px;">Sin samplers — créalos en el panel Sampler</div>';
        return;
    }
    pad.innerHTML = samplers.map(s => `
        <button onclick="fireSampler('${s.id}')" data-sampler-id="${s.id}"
            style="padding:14px 8px;border-radius:12px;border:1px solid ${s.color}33;background:${s.color}15;
            color:${s.color};font-family:'Barlow',sans-serif;font-size:0.78rem;font-weight:800;
            cursor:pointer;text-align:center;text-transform:uppercase;letter-spacing:0.06em;
            transition:all 0.1s;" 
            onmousedown="this.style.transform='scale(0.94)';this.style.background='${s.color}30'"
            onmouseup="this.style.transform='';this.style.background='${s.color}15'"
            title="${s.name}">
            ${s.name}
        </button>`).join('');
}

let samplerCache = {};
async function fireSampler(id) {
    if (samplerCache[id]) {
        playSamplerAudio(samplerCache[id]);
        return;
    }
    const snap = await db.collection(`artifacts/${appId}/public/data/samplers`).doc(id).get();
    if (!snap.exists) return;
    samplerCache[id] = snap.data().audioData;
    playSamplerAudio(samplerCache[id]);
}

// ── ADMIN CHAT ──
function startAdminChatListener() {
    db.collection(`artifacts/${appId}/public/data/chat_messages`)
        .limit(50)
        .onSnapshot(snap => {
            const msgs = snap.docs.map(d => ({ id: d.id, ...d.data() }))
                .sort((a,b) => (a.createdAt?.seconds||0) - (b.createdAt?.seconds||0));
            renderAdminChat(msgs);
            const unread = msgs.filter(m => !m._seen).length;
            const badge = document.getElementById('sb-chat-count');
            if (badge) { badge.style.display = unread > 0 ? 'flex' : 'none'; badge.innerText = unread; }
        }, err => console.warn('admin chat:', err.message));
}

function renderAdminChat(msgs) {
    const typeColors = { join_tables:'#5b6ef5', karaoke_challenge:'#e8362a', dedication:'#f0b429', applause:'#1fd670', birthday:'#8b5cf6', louder:'#e8362a' };
    const html = msgs.length === 0 ? '<div style="text-align:center;color:var(--text-muted);font-size:0.72rem;padding:12px;">Sin mensajes</div>' :
        msgs.map(m => {
            const color = typeColors[m.type] || '#5b6ef5';
            const time = m.createdAt?.seconds ? new Date(m.createdAt.seconds*1000).toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'}) : '';
            const repliesHTML = m.replies?.length ? `<div style="font-size:0.65rem;color:var(--text-muted);margin-top:2px;">↩ ${m.replies.map(r=>`Mesa ${r.fromTable}: ${r.text}`).join(' · ')}</div>` : '';
            return `<div style="padding:8px 10px;background:var(--bg-card);border:1px solid var(--border);border-left:3px solid ${color};border-radius:8px;">
                <div style="display:flex;align-items:center;gap:6px;margin-bottom:2px;">
                    <span style="font-size:0.65rem;font-weight:800;color:${color};text-transform:uppercase;">${m.fromTable ? 'Mesa '+m.fromTable : m.fromName}</span>
                    <span style="font-size:0.6rem;color:var(--text-muted);margin-left:auto;">${time}</span>
                </div>
                <div style="font-size:0.75rem;font-weight:600;color:var(--text-primary);">${m.text}</div>
                ${repliesHTML}
            </div>`;
        }).join('');
    const feed1 = document.getElementById('admin-chat-feed');
    const feed2 = document.getElementById('dj-chat-feed');
    if (feed1) { feed1.innerHTML = html; feed1.scrollTop = feed1.scrollHeight; }
    if (feed2) { feed2.innerHTML = html; feed2.scrollTop = feed2.scrollHeight; }
}

async function clearChatMessages() {
    if (!confirm('¿Limpiar todos los mensajes del chat?')) return;
    const snap = await db.collection(`artifacts/${appId}/public/data/chat_messages`).get();
    const batch = db.batch();
    snap.docs.forEach(d => batch.delete(d.ref));
    await batch.commit();
    toast('Chat limpiado', 'info');
}

</script>
<!-- ═══════════════════════════════════════
     ADMIN LOGIN SCREEN (CAMBIO 6)
═══════════════════════════════════════ -->
<div id="admin-login-screen" class="hidden" style="
  min-height:100dvh; display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  background:var(--bg-base); padding:24px;">
  <div style="width:100%;max-width:400px;background:var(--bg-surface);
    border:1px solid var(--border);border-radius:24px;padding:36px 28px;">
    <div style="text-align:center;margin-bottom:28px;">
      <img src="logo.png" style="max-height:50px;width:auto;margin-bottom:16px;" onerror="this.style.display='none'">
      <div class="font-display" style="font-size:1.4rem;font-weight:900;font-style:italic;text-transform:uppercase;letter-spacing:0.02em;">Acceso Staff</div>
      <div style="font-size:0.7rem;color:var(--text-muted);font-weight:600;text-transform:uppercase;letter-spacing:0.08em;margin-top:4px;">Panel de administración</div>
    </div>
    <div style="display:flex;flex-direction:column;gap:12px;">
      <input id="admin-email"    type="email"    placeholder="Correo" class="reg-input" autocomplete="email">
      <input id="admin-password" type="password" placeholder="Contraseña" class="reg-input" autocomplete="current-password">
      <button onclick="adminLogin()" class="btn btn-primary btn-full btn-lg" style="margin-top:4px;">Ingresar</button>
    </div>
    <div id="admin-login-error" style="display:none;margin-top:12px;padding:10px 14px;background:rgba(232,54,42,0.1);border:1px solid rgba(232,54,42,0.2);border-radius:10px;font-size:0.75rem;font-weight:600;color:var(--accent-red);text-align:center;"></div>
  </div>
</div>

</body>
</html>
