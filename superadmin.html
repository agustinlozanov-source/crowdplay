<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrowdPlay — SuperAdmin</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Barlow:ital,wght@0,400;0,600;0,700;0,800;0,900;1,700&display=swap');

        :root {
            --bg-base:    #090b11;
            --bg-surface: #10131c;
            --bg-card:    #171b27;
            --bg-elevated:#1f2435;
            --border:     rgba(255,255,255,0.09);
            --border-mid: rgba(255,255,255,0.16);
            --text-primary:   #eef0f8;
            --text-secondary: #8b92b0;
            --text-muted:     #4a5070;
            --accent-red:   #e8362a;
            --accent-green: #1fd670;
            --accent-amber: #f0b429;
            --accent-indigo:#5b6ef5;
            --sidebar-w: 220px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Barlow', sans-serif;
            background: var(--bg-base);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
        }

        /* ── LOGIN ── */
        #login-screen {
            position: fixed; inset: 0;
            background: var(--bg-base);
            display: flex; align-items: center; justify-content: center;
            z-index: 100;
        }
        .login-card {
            width: 100%; max-width: 380px;
            background: var(--bg-card);
            border: 1px solid var(--border-mid);
            border-radius: 20px;
            padding: 36px 32px;
        }
        .login-logo { font-size: 1.6rem; font-weight: 900; color: var(--accent-red); letter-spacing: -0.02em; margin-bottom: 4px; }
        .login-sub  { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.12em; margin-bottom: 28px; }
        .login-input {
            width: 100%; background: var(--bg-elevated); border: 1px solid var(--border-mid);
            border-radius: 12px; padding: 12px 14px; color: var(--text-primary);
            font-family: 'Barlow', sans-serif; font-size: 0.88rem; outline: none;
            margin-bottom: 10px; transition: border-color 0.2s;
        }
        .login-input:focus { border-color: var(--accent-indigo); }
        .btn-login {
            width: 100%; padding: 13px; background: var(--accent-red); border: none;
            border-radius: 12px; color: white; font-family: 'Barlow', sans-serif;
            font-size: 0.88rem; font-weight: 700; cursor: pointer; margin-top: 4px;
            letter-spacing: 0.05em; text-transform: uppercase; transition: opacity 0.2s;
        }
        .btn-login:hover { opacity: 0.88; }
        #login-error {
            display: none; margin-top: 12px; padding: 10px 14px;
            background: rgba(232,54,42,0.1); border: 1px solid rgba(232,54,42,0.2);
            border-radius: 10px; font-size: 0.75rem; font-weight: 600; color: var(--accent-red); text-align: center;
        }

        /* ── SIDEBAR ── */
        #sidebar {
            width: var(--sidebar-w); background: var(--bg-surface);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
            position: fixed; top: 0; left: 0; bottom: 0;
            z-index: 50;
        }
        .sidebar-brand {
            padding: 20px 18px 16px;
            border-bottom: 1px solid var(--border);
        }
        .brand-name { font-size: 1.2rem; font-weight: 900; color: var(--accent-red); letter-spacing: -0.02em; }
        .brand-badge {
            display: inline-block; margin-top: 3px;
            font-size: 0.55rem; font-weight: 800; letter-spacing: 0.14em; text-transform: uppercase;
            background: rgba(232,54,42,0.15); color: var(--accent-red);
            border: 1px solid rgba(232,54,42,0.3); border-radius: 6px; padding: 2px 7px;
        }
        .sidebar-nav { flex: 1; padding: 12px 10px; display: flex; flex-direction: column; gap: 3px; }
        .nav-item {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 12px; border-radius: 10px; cursor: pointer;
            font-size: 0.82rem; font-weight: 600; color: var(--text-secondary);
            transition: all 0.15s; border: 1px solid transparent;
        }
        .nav-item:hover { background: var(--bg-elevated); color: var(--text-primary); }
        .nav-item.active {
            background: rgba(232,54,42,0.1); color: var(--accent-red);
            border-color: rgba(232,54,42,0.2);
        }
        .nav-item svg { flex-shrink: 0; opacity: 0.7; }
        .nav-item.active svg { opacity: 1; }
        .sidebar-footer {
            padding: 12px 10px;
            border-top: 1px solid var(--border);
        }

        /* ── MAIN ── */
        #main {
            margin-left: var(--sidebar-w);
            flex: 1; display: flex; flex-direction: column;
            min-height: 100vh;
        }
        #topbar {
            height: 58px; background: var(--bg-surface);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 24px; position: sticky; top: 0; z-index: 40;
        }
        #topbar-title { font-size: 1rem; font-weight: 800; color: var(--text-primary); letter-spacing: -0.01em; }
        .topbar-user { font-size: 0.72rem; font-weight: 600; color: var(--text-muted); }

        #content { padding: 24px; flex: 1; }

        /* ── PANELS ── */
        .panel { display: none; flex-direction: column; gap: 20px; }
        .panel.active { display: flex; }

        /* ── CARDS ── */
        .card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 16px; padding: 20px 22px;
        }
        .card-title {
            font-size: 0.78rem; font-weight: 800; text-transform: uppercase;
            letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 16px;
        }

        /* ── STATS ── */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; }
        .stat-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 14px; padding: 16px 18px;
        }
        .stat-label { font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 6px; }
        .stat-value { font-size: 2rem; font-weight: 900; color: var(--text-primary); line-height: 1; }
        .stat-sub { font-size: 0.68rem; font-weight: 600; color: var(--text-muted); margin-top: 4px; }

        /* ── TABLE ── */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th {
            font-size: 0.65rem; font-weight: 800; text-transform: uppercase;
            letter-spacing: 0.1em; color: var(--text-muted); padding: 10px 14px;
            border-bottom: 1px solid var(--border); text-align: left;
        }
        .data-table td {
            padding: 12px 14px; border-bottom: 1px solid var(--border);
            font-size: 0.82rem; color: var(--text-primary);
        }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover td { background: var(--bg-elevated); }

        /* ── BADGES ── */
        .badge {
            display: inline-block; font-size: 0.6rem; font-weight: 800;
            text-transform: uppercase; letter-spacing: 0.08em;
            padding: 3px 8px; border-radius: 6px;
        }
        .badge-green  { background: rgba(31,214,112,0.12); color: var(--accent-green); border: 1px solid rgba(31,214,112,0.25); }
        .badge-red    { background: rgba(232,54,42,0.12);  color: var(--accent-red);   border: 1px solid rgba(232,54,42,0.25); }
        .badge-amber  { background: rgba(240,180,41,0.12); color: var(--accent-amber); border: 1px solid rgba(240,180,41,0.25); }
        .badge-indigo { background: rgba(91,110,245,0.12); color: var(--accent-indigo);border: 1px solid rgba(91,110,245,0.25); }
        .badge-gray   { background: var(--bg-elevated);    color: var(--text-muted);   border: 1px solid var(--border-mid); }

        /* ── INPUTS / FORM ── */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group.full { grid-column: 1 / -1; }
        .form-label { font-size: 0.68rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; }
        .form-input {
            background: var(--bg-elevated); border: 1px solid var(--border-mid);
            border-radius: 10px; padding: 10px 12px; color: var(--text-primary);
            font-family: 'Barlow', sans-serif; font-size: 0.85rem; outline: none;
            transition: border-color 0.2s;
        }
        .form-input:focus { border-color: var(--accent-indigo); }
        .form-select {
            background: var(--bg-elevated); border: 1px solid var(--border-mid);
            border-radius: 10px; padding: 10px 12px; color: var(--text-primary);
            font-family: 'Barlow', sans-serif; font-size: 0.85rem; outline: none;
            cursor: pointer;
        }

        /* ── BUTTONS ── */
        .btn {
            display: inline-flex; align-items: center; gap: 7px;
            padding: 9px 18px; border-radius: 10px; border: none;
            font-family: 'Barlow', sans-serif; font-size: 0.78rem;
            font-weight: 700; cursor: pointer; letter-spacing: 0.06em;
            text-transform: uppercase; transition: all 0.15s;
        }
        .btn-primary { background: var(--accent-red); color: white; }
        .btn-primary:hover { opacity: 0.88; }
        .btn-secondary { background: var(--bg-elevated); color: var(--text-secondary); border: 1px solid var(--border-mid); }
        .btn-secondary:hover { color: var(--text-primary); border-color: var(--border-mid); }
        .btn-green { background: rgba(31,214,112,0.12); color: var(--accent-green); border: 1px solid rgba(31,214,112,0.25); }
        .btn-sm { padding: 6px 12px; font-size: 0.68rem; }
        .btn-icon { padding: 7px; border-radius: 8px; }

        /* ── MODAL ── */
        .modal-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.7); z-index: 200;
            align-items: center; justify-content: center; padding: 20px;
        }
        .modal-overlay.open { display: flex; }
        .modal {
            background: var(--bg-card); border: 1px solid var(--border-mid);
            border-radius: 20px; padding: 28px; width: 100%; max-width: 560px;
            max-height: 90vh; overflow-y: auto;
        }
        .modal-title { font-size: 1rem; font-weight: 800; color: var(--text-primary); margin-bottom: 20px; }
        .modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

        /* ── TOAST ── */
        #toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 999; display: flex; flex-direction: column; gap: 8px; }
        .toast { padding: 12px 16px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; display: flex; align-items: center; gap: 10px; animation: slideIn 0.25s ease; min-width: 220px; max-width: 320px; }
        .toast-success { background: rgba(31,214,112,0.15); border: 1px solid rgba(31,214,112,0.3); color: var(--accent-green); }
        .toast-error   { background: rgba(232,54,42,0.15);  border: 1px solid rgba(232,54,42,0.3);  color: var(--accent-red); }
        .toast-info    { background: rgba(91,110,245,0.15); border: 1px solid rgba(91,110,245,0.3); color: var(--accent-indigo); }
        .toast-warning { background: rgba(240,180,41,0.15); border: 1px solid rgba(240,180,41,0.3); color: var(--accent-amber); }
        @keyframes slideIn { from { transform: translateX(40px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* ── PROGRESS BAR ── */
        .progress-bar { height: 4px; background: var(--bg-elevated); border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 2px; transition: width 0.3s; }

        /* ── PLAN CARDS ── */
        .plan-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 14px; }
        .plan-card {
            background: var(--bg-elevated); border: 1px solid var(--border-mid);
            border-radius: 16px; padding: 18px; cursor: pointer; transition: all 0.2s;
            position: relative;
        }
        .plan-card.selected { border-color: var(--accent-indigo); background: rgba(91,110,245,0.08); }
        .plan-name { font-size: 0.9rem; font-weight: 800; color: var(--text-primary); }
        .plan-price { font-size: 1.5rem; font-weight: 900; color: var(--accent-amber); margin: 6px 0 2px; }
        .plan-period { font-size: 0.68rem; font-weight: 600; color: var(--text-muted); }
        .plan-features { margin-top: 12px; display: flex; flex-direction: column; gap: 4px; }
        .plan-feature { font-size: 0.72rem; color: var(--text-secondary); display: flex; align-items: center; gap: 6px; }
        .plan-feature::before { content: "✓"; color: var(--accent-green); font-weight: 800; }

        /* ── VENUE ROW ACTIONS ── */
        .row-actions { display: flex; gap: 6px; }

        /* ── HIDDEN ── */
        .hidden { display: none !important; }
    </style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
    <div class="login-card">
        <div class="login-logo">CrowdPlay</div>
        <div class="login-sub">Super Admin</div>
        <input id="sa-email"    type="email"    class="login-input" placeholder="Email" onkeydown="if(event.key==='Enter')saLogin()">
        <input id="sa-password" type="password" class="login-input" placeholder="Contraseña" onkeydown="if(event.key==='Enter')saLogin()">
        <button class="btn-login" onclick="saLogin()">Entrar</button>
        <div id="login-error"></div>
    </div>
</div>

<!-- APP -->
<div id="app" class="hidden">

    <!-- SIDEBAR -->
    <div id="sidebar">
        <div class="sidebar-brand">
            <div class="brand-name">CrowdPlay</div>
            <div class="brand-badge">Super Admin</div>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-item active" id="nav-dashboard" onclick="switchPanel('dashboard')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
                Dashboard
            </div>
            <div class="nav-item" id="nav-venues" onclick="switchPanel('venues')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>
                Venues
            </div>
            <div class="nav-item" id="nav-plans" onclick="switchPanel('plans')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
                Planes
            </div>
            <div class="nav-item" id="nav-users" onclick="switchPanel('users')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                Usuarios
            </div>
            <div class="nav-item" id="nav-analytics" onclick="switchPanel('analytics')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/></svg>
                Analytics
            </div>
            <div class="nav-item" id="nav-export" onclick="switchPanel('export')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Exportar
            </div>
        </nav>
        <div class="sidebar-footer">
            <div class="nav-item" onclick="saLogout()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                Cerrar sesión
            </div>
        </div>
    </div>

    <!-- MAIN -->
    <div id="main">
        <div id="topbar">
            <div id="topbar-title">Dashboard</div>
            <div class="topbar-user" id="topbar-user">—</div>
        </div>

        <div id="content">

            <!-- DASHBOARD -->
            <div class="panel active" id="panel-dashboard">
                <div class="stats-grid" id="global-stats">
                    <div class="stat-card">
                        <div class="stat-label">Venues activos</div>
                        <div class="stat-value" id="stat-venues">—</div>
                        <div class="stat-sub">en producción</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Usuarios totales</div>
                        <div class="stat-value" id="stat-users">—</div>
                        <div class="stat-sub">registrados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Riffs emitidos</div>
                        <div class="stat-value" id="stat-riffs">—</div>
                        <div class="stat-sub">todas las noches</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Revenue MRR</div>
                        <div class="stat-value" id="stat-mrr">—</div>
                        <div class="stat-sub">mensual recurrente</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Venues recientes</div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Plan</th>
                                <th>Estado</th>
                                <th>Trial hasta</th>
                                <th>Usuarios</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard-venues-list">
                            <tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:20px;">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- VENUES -->
            <div class="panel" id="panel-venues">
                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
                    <input id="venues-search" type="text" class="form-input" placeholder="Buscar Venue..." style="width:260px;" oninput="filterVenues(this.value)">
                    <button class="btn btn-primary" onclick="openVenueModal()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Nuevo Venue
                    </button>
                </div>
                <div class="card">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Venue</th>
                                <th>App ID</th>
                                <th>Plan</th>
                                <th>Estado</th>
                                <th>Trial</th>
                                <th>Creado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="venues-list">
                            <tr><td colspan="7" style="text-align:center;color:var(--text-muted);padding:20px;">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PLANS -->
            <div class="panel" id="panel-plans">
                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
                    <div style="font-size:0.85rem;color:var(--text-muted);">Define los planes disponibles para los Venues.</div>
                    <button class="btn btn-primary" onclick="openPlanModal()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Nuevo Plan
                    </button>
                </div>
                <div id="plans-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px;">
                    <div style="text-align:center;color:var(--text-muted);padding:20px;">Cargando...</div>
                </div>
            </div>

            <!-- USERS -->
            <div class="panel" id="panel-users">
                <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                    <input id="users-search" type="text" class="form-input" placeholder="Buscar usuario..." style="width:260px;" oninput="filterUsers(this.value)">
                    <select id="users-venue-filter" class="form-select" style="width:200px;" onchange="filterUsers(document.getElementById('users-search').value)">
                        <option value="">Todos los Venues</option>
                    </select>
                </div>
                <div class="card">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Email</th>
                                <th>WhatsApp</th>
                                <th>Riffs</th>
                                <th>Venue</th>
                                <th>Registro</th>
                            </tr>
                        </thead>
                        <tbody id="users-list">
                            <tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:20px;">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ANALYTICS -->
            <div class="panel" id="panel-analytics">
                <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:4px;">
                    <select id="analytics-venue" class="form-select" style="width:220px;" onchange="loadAnalytics()">
                        <option value="">Todos los Venues</option>
                    </select>
                    <select id="analytics-period" class="form-select" style="width:160px;" onchange="loadAnalytics()">
                        <option value="7">Últimos 7 días</option>
                        <option value="30" selected>Últimos 30 días</option>
                        <option value="90">Últimos 90 días</option>
                    </select>
                </div>

                <div class="stats-grid" id="analytics-stats">
                    <div class="stat-card"><div class="stat-label">Canciones pedidas</div><div class="stat-value" id="an-songs">—</div></div>
                    <div class="stat-card"><div class="stat-label">Usuarios únicos</div><div class="stat-value" id="an-users">—</div></div>
                    <div class="stat-card"><div class="stat-label">Riffs gastados</div><div class="stat-value" id="an-riffs">—</div></div>
                    <div class="stat-card"><div class="stat-label">Boosts pagados</div><div class="stat-value" id="an-boosts">—</div></div>
                </div>

                <div class="card">
                    <div class="card-title">Top canciones pedidas</div>
                    <table class="data-table">
                        <thead><tr><th>#</th><th>Canción</th><th>Venue</th><th>Veces pedida</th><th>Votos totales</th></tr></thead>
                        <tbody id="analytics-top-songs">
                            <tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:20px;">Selecciona un período</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="card">
                    <div class="card-title">Actividad por Venue</div>
                    <table class="data-table">
                        <thead><tr><th>Venue</th><th>Plan</th><th>Canciones</th><th>Usuarios activos</th><th>Riffs emitidos</th></tr></thead>
                        <tbody id="analytics-venues">
                            <tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:20px;">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- EXPORT -->
            <div class="panel" id="panel-export">
                <div class="card">
                    <div class="card-title">Exportar datos</div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;">

                        <div style="background:var(--bg-elevated);border:1px solid var(--border-mid);border-radius:14px;padding:18px;">
                            <div style="font-size:0.85rem;font-weight:700;color:var(--text-primary);margin-bottom:4px;">Venues</div>
                            <div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:14px;">Lista completa de todos los Venues, planes y estado.</div>
                            <button class="btn btn-secondary btn-sm" onclick="exportData('venues')">Exportar CSV</button>
                        </div>

                        <div style="background:var(--bg-elevated);border:1px solid var(--border-mid);border-radius:14px;padding:18px;">
                            <div style="font-size:0.85rem;font-weight:700;color:var(--text-primary);margin-bottom:4px;">Usuarios</div>
                            <div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:14px;">Todos los usuarios registrados con saldo de Riffs.</div>
                            <button class="btn btn-secondary btn-sm" onclick="exportData('users')">Exportar CSV</button>
                        </div>

                        <div style="background:var(--bg-elevated);border:1px solid var(--border-mid);border-radius:14px;padding:18px;">
                            <div style="font-size:0.85rem;font-weight:700;color:var(--text-primary);margin-bottom:4px;">Historial de canciones</div>
                            <div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:14px;">Todas las canciones pedidas con fecha, usuario y Venue.</div>
                            <button class="btn btn-secondary btn-sm" onclick="exportData('songs')">Exportar CSV</button>
                        </div>

                        <div style="background:var(--bg-elevated);border:1px solid var(--border-mid);border-radius:14px;padding:18px;">
                            <div style="font-size:0.85rem;font-weight:700;color:var(--text-primary);margin-bottom:4px;">Transacciones Riffs</div>
                            <div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:14px;">Historial de carga y gasto de Riffs por usuario.</div>
                            <button class="btn btn-secondary btn-sm" onclick="exportData('riffs')">Exportar CSV</button>
                        </div>

                    </div>
                </div>
            </div>

        </div><!-- /content -->
    </div><!-- /main -->
</div><!-- /app -->

<!-- MODAL: VENUE -->
<div class="modal-overlay" id="modal-venue">
    <div class="modal">
        <div class="modal-title" id="venue-modal-title">Nuevo Venue</div>
        <div class="form-grid">
            <div class="form-group">
                <div class="form-label">Nombre del bar</div>
                <input id="v-name" type="text" class="form-input" placeholder="Ej: Bar La Cantina">
            </div>
            <div class="form-group">
                <div class="form-label">App ID (único)</div>
                <input id="v-appid" type="text" class="form-input" placeholder="Ej: rocola-la-cantina">
            </div>
            <div class="form-group">
                <div class="form-label">Ciudad</div>
                <input id="v-city" type="text" class="form-input" placeholder="Ciudad">
            </div>
            <div class="form-group">
                <div class="form-label">País</div>
                <input id="v-country" type="text" class="form-input" placeholder="México" value="México">
            </div>
            <div class="form-group">
                <div class="form-label">Email de contacto</div>
                <input id="v-email" type="email" class="form-input" placeholder="dueño@bar.com">
            </div>
            <div class="form-group">
                <div class="form-label">WhatsApp</div>
                <input id="v-phone" type="text" class="form-input" placeholder="+52 55 0000 0000">
            </div>
            <div class="form-group">
                <div class="form-label">YouTube API Key</div>
                <input id="v-ytkey" type="text" class="form-input" placeholder="AIzaSy...">
            </div>
            <div class="form-group">
                <div class="form-label">Plan</div>
                <select id="v-plan" class="form-select">
                    <option value="trial">Trial (30 días gratis)</option>
                    <option value="basico">Básico — $499/mes</option>
                    <option value="pro">Pro — $999/mes</option>
                    <option value="enterprise">Enterprise</option>
                </select>
            </div>
            <div class="form-group">
                <div class="form-label">Trial hasta</div>
                <input id="v-trial" type="date" class="form-input">
            </div>
            <div class="form-group">
                <div class="form-label">Estado</div>
                <select id="v-status" class="form-select">
                    <option value="active">Activo</option>
                    <option value="trial">Trial</option>
                    <option value="suspended">Suspendido</option>
                    <option value="inactive">Inactivo</option>
                </select>
            </div>
            <div class="form-group full">
                <div class="form-label">Notas internas</div>
                <input id="v-notes" type="text" class="form-input" placeholder="Notas...">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('modal-venue')">Cancelar</button>
            <button class="btn btn-primary" onclick="saveVenue()">Guardar Venue</button>
        </div>
    </div>
</div>

<!-- MODAL: PLAN -->
<div class="modal-overlay" id="modal-plan">
    <div class="modal">
        <div class="modal-title">Nuevo Plan</div>
        <div class="form-grid">
            <div class="form-group">
                <div class="form-label">ID del plan</div>
                <input id="p-id" type="text" class="form-input" placeholder="Ej: pro">
            </div>
            <div class="form-group">
                <div class="form-label">Nombre</div>
                <input id="p-name" type="text" class="form-input" placeholder="Ej: Pro">
            </div>
            <div class="form-group">
                <div class="form-label">Precio mensual (MXN)</div>
                <input id="p-price" type="number" class="form-input" placeholder="999">
            </div>
            <div class="form-group">
                <div class="form-label">Máx. usuarios por noche</div>
                <input id="p-maxusers" type="number" class="form-input" placeholder="100">
            </div>
            <div class="form-group full">
                <div class="form-label">Características (una por línea)</div>
                <textarea id="p-features" class="form-input" rows="4" style="resize:vertical;" placeholder="Cola de canciones&#10;Panel DJ&#10;Sistema Riffs&#10;Chat entre mesas"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('modal-plan')">Cancelar</button>
            <button class="btn btn-primary" onclick="savePlan()">Guardar Plan</button>
        </div>
    </div>
</div>

<!-- MODAL: VENUE DETAIL -->
<div class="modal-overlay" id="modal-venue-detail">
    <div class="modal" style="max-width:640px;">
        <div class="modal-title" id="detail-name">—</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
            <div><div style="font-size:0.65rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:4px;">App ID</div><div id="detail-appid" style="font-size:0.82rem;color:var(--text-primary);font-family:monospace;background:var(--bg-elevated);padding:6px 10px;border-radius:8px;"></div></div>
            <div><div style="font-size:0.65rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:4px;">Plan</div><div id="detail-plan" style="font-size:0.82rem;"></div></div>
            <div><div style="font-size:0.65rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:4px;">Estado</div><div id="detail-status"></div></div>
            <div><div style="font-size:0.65rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:4px;">Trial hasta</div><div id="detail-trial" style="font-size:0.82rem;color:var(--text-primary);"></div></div>
            <div><div style="font-size:0.65rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:4px;">Email</div><div id="detail-email" style="font-size:0.82rem;color:var(--text-primary);"></div></div>
            <div><div style="font-size:0.65rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:4px;">WhatsApp</div><div id="detail-phone" style="font-size:0.82rem;color:var(--text-primary);"></div></div>
        </div>
        <div style="font-size:0.75rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">URLs del Venue</div>
        <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px;" id="detail-urls"></div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('modal-venue-detail')">Cerrar</button>
            <button class="btn btn-secondary" id="detail-edit-btn">Editar</button>
            <button class="btn btn-primary" id="detail-toggle-btn">Suspender</button>
        </div>
    </div>
</div>

<div id="toast-container"></div>

<script>
const manualFirebaseConfig = {
    apiKey: "AIzaSyAia_yRHvYg3gGQ60VwPRwcRm3B0aja4cw",
    authDomain: "rocola-crowdplay2.firebaseapp.com",
    projectId: "rocola-crowdplay2",
    storageBucket: "rocola-crowdplay2.firebasestorage.app",
    messagingSenderId: "519952213703",
    appId: "1:519952213703:web:0e0ecb8cb3fc81064240e2"
};

const SA_COLLECTION = 'superadmin';
let app, auth, db;
let currentUser = null;
let allVenues = [];
let allUsers = [];
let editingVenueId = null;

// ── FIREBASE INIT ──
function loadFirebase() {
    const s1 = document.createElement('script');
    s1.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js';
    s1.onload = () => {
        const s2 = document.createElement('script');
        s2.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js';
        s2.onload = () => {
            const s3 = document.createElement('script');
            s3.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js';
            s3.onload = initFirebase;
            document.head.appendChild(s3);
        };
        document.head.appendChild(s2);
    };
    document.head.appendChild(s1);
}

function initFirebase() {
    if (!firebase.apps.length) firebase.initializeApp(manualFirebaseConfig);
    auth = firebase.auth();
    db   = firebase.firestore();
    // Check if already logged in
    auth.onAuthStateChanged(user => {
        if (user) checkSuperAdmin(user);
    });
}

async function checkSuperAdmin(user) {
    try {
        const doc = await db.collection('superadmin_users').doc(user.uid).get();
        if (doc.exists && doc.data().role === 'superadmin') {
            currentUser = user;
            document.getElementById('topbar-user').innerText = user.email;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            loadAll();
        } else {
            auth.signOut();
            showLoginError('Sin permisos de SuperAdmin.');
        }
    } catch(e) {
        showLoginError('Error al verificar permisos.');
    }
}

// ── AUTH ──
async function saLogin() {
    const email = document.getElementById('sa-email').value.trim();
    const pass  = document.getElementById('sa-password').value;
    if (!email || !pass) return;
    try {
        await auth.signInWithEmailAndPassword(email, pass);
    } catch(e) {
        const msgs = {
            'auth/wrong-password': 'Contraseña incorrecta.',
            'auth/user-not-found': 'Usuario no encontrado.',
            'auth/invalid-email':  'Email inválido.',
        };
        showLoginError(msgs[e.code] || e.message);
    }
}

function showLoginError(msg) {
    const el = document.getElementById('login-error');
    el.innerText = msg; el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 4000);
}

function saLogout() {
    auth.signOut();
    location.reload();
}

// ── NAVIGATION ──
function switchPanel(name) {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('panel-' + name).classList.add('active');
    document.getElementById('nav-' + name).classList.add('active');
    const titles = { dashboard: 'Dashboard', venues: 'Venues', plans: 'Planes', users: 'Usuarios', analytics: 'Analytics', export: 'Exportar datos' };
    document.getElementById('topbar-title').innerText = titles[name] || name;
    if (name === 'analytics') loadAnalytics();
    if (name === 'users') renderUsers(allUsers);
}

// ── LOAD ALL DATA ──
async function loadAll() {
    await Promise.all([loadVenues(), loadUsers(), loadPlans()]);
    loadDashboard();
}

// ── VENUES ──
async function loadVenues() {
    const snap = await db.collection(`${SA_COLLECTION}/data/venues`).orderBy('createdAt', 'desc').get().catch(() => db.collection(`${SA_COLLECTION}/data/venues`).get());
    allVenues = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderVenues(allVenues);
    // Populate venue selects
    const selects = ['analytics-venue', 'users-venue-filter'];
    selects.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.innerHTML = '<option value="">Todos los Venues</option>';
        allVenues.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.appId;
            opt.innerText = v.name;
            el.appendChild(opt);
        });
    });
}

function renderVenues(venues) {
    const tbody = document.getElementById('venues-list');
    if (!venues.length) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-muted);padding:20px;">Sin Venues</td></tr>'; return; }
    tbody.innerHTML = venues.map(v => {
        const statusBadge = { active: 'badge-green', trial: 'badge-amber', suspended: 'badge-red', inactive: 'badge-gray' }[v.status] || 'badge-gray';
        const statusLabel = { active: 'Activo', trial: 'Trial', suspended: 'Suspendido', inactive: 'Inactivo' }[v.status] || v.status;
        const trialDate = v.trialUntil ? new Date(v.trialUntil).toLocaleDateString('es-MX') : '—';
        const created = v.createdAt?.toDate ? v.createdAt.toDate().toLocaleDateString('es-MX') : '—';
        return `<tr>
            <td><div style="font-weight:700;">${v.name}</div><div style="font-size:0.68rem;color:var(--text-muted);">${v.city || ''}${v.city && v.country ? ', ' : ''}${v.country || ''}</div></td>
            <td><span style="font-family:monospace;font-size:0.75rem;color:var(--text-muted);">${v.appId || '—'}</span></td>
            <td><span class="badge badge-indigo">${v.plan || '—'}</span></td>
            <td><span class="badge ${statusBadge}">${statusLabel}</span></td>
            <td style="font-size:0.78rem;color:var(--text-muted);">${trialDate}</td>
            <td style="font-size:0.78rem;color:var(--text-muted);">${created}</td>
            <td><div class="row-actions">
                <button class="btn btn-secondary btn-sm btn-icon" onclick="openVenueDetail('${v.id}')" title="Ver">
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>
                <button class="btn btn-secondary btn-sm btn-icon" onclick="openVenueModal('${v.id}')" title="Editar">
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                </button>
                <button class="btn btn-secondary btn-sm btn-icon" onclick="deleteVenue('${v.id}')" title="Eliminar" style="color:var(--accent-red);">
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3,6 5,6 21,6"/><path d="M19,6l-1,14a2,2,0,0,1-2,2H8a2,2,0,0,1-2-2L5,6"/><path d="M10,11v6"/><path d="M14,11v6"/></svg>
                </button>
            </div></td>
        </tr>`;
    }).join('');
}

function filterVenues(q) {
    const filtered = allVenues.filter(v =>
        !q || v.name?.toLowerCase().includes(q.toLowerCase()) || v.appId?.toLowerCase().includes(q.toLowerCase())
    );
    renderVenues(filtered);
}

function openVenueModal(venueId = null) {
    editingVenueId = venueId;
    document.getElementById('venue-modal-title').innerText = venueId ? 'Editar Venue' : 'Nuevo Venue';
    if (venueId) {
        const v = allVenues.find(x => x.id === venueId);
        if (v) {
            document.getElementById('v-name').value    = v.name || '';
            document.getElementById('v-appid').value   = v.appId || '';
            document.getElementById('v-city').value    = v.city || '';
            document.getElementById('v-country').value = v.country || 'México';
            document.getElementById('v-email').value   = v.email || '';
            document.getElementById('v-phone').value   = v.phone || '';
            document.getElementById('v-ytkey').value   = v.ytApiKey || '';
            document.getElementById('v-plan').value    = v.plan || 'trial';
            document.getElementById('v-status').value  = v.status || 'active';
            document.getElementById('v-notes').value   = v.notes || '';
            document.getElementById('v-trial').value   = v.trialUntil || '';
        }
    } else {
        ['v-name','v-appid','v-city','v-email','v-phone','v-ytkey','v-notes','v-trial'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('v-country').value = 'México';
        document.getElementById('v-plan').value   = 'trial';
        document.getElementById('v-status').value = 'trial';
        // Default trial: 30 days
        const d = new Date(); d.setDate(d.getDate() + 30);
        document.getElementById('v-trial').value = d.toISOString().split('T')[0];
    }
    document.getElementById('modal-venue').classList.add('open');
}

async function saveVenue() {
    const name   = document.getElementById('v-name').value.trim();
    const appId  = document.getElementById('v-appid').value.trim().toLowerCase().replace(/\s+/g, '-');
    if (!name || !appId) { toast('Nombre y App ID son requeridos', 'warning'); return; }
    const data = {
        name, appId,
        city:      document.getElementById('v-city').value.trim(),
        country:   document.getElementById('v-country').value.trim(),
        email:     document.getElementById('v-email').value.trim(),
        phone:     document.getElementById('v-phone').value.trim(),
        ytApiKey:  document.getElementById('v-ytkey').value.trim(),
        plan:      document.getElementById('v-plan').value,
        status:    document.getElementById('v-status').value,
        notes:     document.getElementById('v-notes').value.trim(),
        trialUntil:document.getElementById('v-trial').value,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    };
    if (!editingVenueId) data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
    try {
        if (editingVenueId) {
            await db.collection(`${SA_COLLECTION}/data/venues`).doc(editingVenueId).update(data);
        } else {
            await db.collection(`${SA_COLLECTION}/data/venues`).add(data);
        }
        closeModal('modal-venue');
        await loadVenues();
        loadDashboard();
        toast(editingVenueId ? 'Venue actualizado' : 'Venue creado', 'success');
    } catch(e) { toast('Error: ' + e.message, 'error'); }
}

async function deleteVenue(id) {
    if (!confirm('¿Eliminar este Venue? Esta acción no se puede deshacer.')) return;
    await db.collection(`${SA_COLLECTION}/data/venues`).doc(id).delete();
    await loadVenues();
    loadDashboard();
    toast('Venue eliminado', 'info');
}

function openVenueDetail(id) {
    const v = allVenues.find(x => x.id === id);
    if (!v) return;
    document.getElementById('detail-name').innerText  = v.name;
    document.getElementById('detail-appid').innerText = v.appId || '—';
    document.getElementById('detail-plan').innerHTML  = `<span class="badge badge-indigo">${v.plan || '—'}</span>`;
    document.getElementById('detail-trial').innerText = v.trialUntil || '—';
    document.getElementById('detail-email').innerText = v.email || '—';
    document.getElementById('detail-phone').innerText = v.phone || '—';
    const statusBadge = { active: 'badge-green', trial: 'badge-amber', suspended: 'badge-red', inactive: 'badge-gray' }[v.status] || 'badge-gray';
    const statusLabel = { active: 'Activo', trial: 'Trial', suspended: 'Suspendido', inactive: 'Inactivo' }[v.status] || v.status;
    document.getElementById('detail-status').innerHTML = `<span class="badge ${statusBadge}">${statusLabel}</span>`;
    const base = window.location.origin;
    document.getElementById('detail-urls').innerHTML = [
        ['Cliente', `${base}/index.html?venue=${v.appId}`],
        ['Admin / DJ', `${base}/admin.html?venue=${v.appId}`],
        ['TV Display', `${base}/tv.html?venue=${v.appId}`],
    ].map(([label, url]) => `
        <div style="display:flex;align-items:center;gap:10px;background:var(--bg-elevated);border:1px solid var(--border-mid);border-radius:10px;padding:10px 14px;">
            <div style="font-size:0.65rem;font-weight:800;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-muted);width:60px;flex-shrink:0;">${label}</div>
            <div style="font-size:0.75rem;font-family:monospace;color:var(--text-primary);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${url}</div>
            <button onclick="navigator.clipboard.writeText('${url}');toast('URL copiada','success')" style="padding:4px 10px;background:none;border:1px solid var(--border-mid);border-radius:7px;color:var(--text-muted);font-family:'Barlow',sans-serif;font-size:0.65rem;font-weight:700;cursor:pointer;text-transform:uppercase;letter-spacing:0.08em;flex-shrink:0;">Copiar</button>
        </div>`).join('');
    const isActive = v.status === 'active' || v.status === 'trial';
    const toggleBtn = document.getElementById('detail-toggle-btn');
    toggleBtn.innerText = isActive ? 'Suspender' : 'Activar';
    toggleBtn.className = isActive ? 'btn btn-primary' : 'btn btn-green';
    toggleBtn.onclick = async () => {
        const newStatus = isActive ? 'suspended' : 'active';
        await db.collection(`${SA_COLLECTION}/data/venues`).doc(id).update({ status: newStatus });
        await loadVenues();
        closeModal('modal-venue-detail');
        toast(`Venue ${newStatus === 'active' ? 'activado' : 'suspendido'}`, newStatus === 'active' ? 'success' : 'warning');
    };
    document.getElementById('detail-edit-btn').onclick = () => { closeModal('modal-venue-detail'); openVenueModal(id); };
    document.getElementById('modal-venue-detail').classList.add('open');
}

// ── PLANS ──
async function loadPlans() {
    const snap = await db.collection(`${SA_COLLECTION}/data/plans`).get();
    let plans = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    if (!plans.length) {
        // Seed default plans
        const defaults = [
            { id: 'basico', name: 'Básico', price: 499, maxUsers: 50, features: ['Cola de canciones', 'Panel DJ básico', 'TV Display'] },
            { id: 'pro', name: 'Pro', price: 999, maxUsers: 150, features: ['Cola de canciones', 'Panel DJ completo', 'Sistema Riffs', 'Chat entre mesas', 'Banners TV', 'Analytics'] },
            { id: 'enterprise', name: 'Enterprise', price: 0, maxUsers: 999, features: ['Todo lo de Pro', 'Multi-sala', 'Soporte prioritario', 'Configuración a medida', 'SLA garantizado'] },
        ];
        for (const p of defaults) {
            await db.collection(`${SA_COLLECTION}/data/plans`).doc(p.id).set(p);
        }
        plans = defaults;
    }
    renderPlans(plans);
}

function renderPlans(plans) {
    const grid = document.getElementById('plans-grid');
    grid.innerHTML = plans.map(p => `
        <div class="plan-card">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                <div class="plan-name">${p.name}</div>
                <button onclick="deletePlan('${p.id}')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;padding:2px;font-size:0.8rem;" title="Eliminar">✕</button>
            </div>
            <div class="plan-price">${p.price > 0 ? '$' + p.price : 'Custom'}</div>
            <div class="plan-period">${p.price > 0 ? 'MXN / mes' : 'a consultar'}</div>
            <div style="font-size:0.65rem;color:var(--text-muted);margin-top:4px;">Hasta ${p.maxUsers || '∞'} usuarios/noche</div>
            <div class="plan-features">
                ${(p.features || []).map(f => `<div class="plan-feature">${f}</div>`).join('')}
            </div>
        </div>`).join('') + `
        <div style="background:var(--bg-elevated);border:1px dashed var(--border-mid);border-radius:16px;padding:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;min-height:120px;" onclick="openPlanModal()">
            <div style="text-align:center;color:var(--text-muted);">
                <div style="font-size:1.5rem;margin-bottom:4px;">+</div>
                <div style="font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;">Nuevo plan</div>
            </div>
        </div>`;
}

function openPlanModal() {
    ['p-id','p-name','p-price','p-maxusers','p-features'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('modal-plan').classList.add('open');
}

async function savePlan() {
    const id   = document.getElementById('p-id').value.trim().toLowerCase();
    const name = document.getElementById('p-name').value.trim();
    if (!id || !name) { toast('ID y nombre requeridos', 'warning'); return; }
    const features = document.getElementById('p-features').value.split('\n').map(f => f.trim()).filter(Boolean);
    await db.collection(`${SA_COLLECTION}/data/plans`).doc(id).set({
        id, name,
        price:    parseInt(document.getElementById('p-price').value) || 0,
        maxUsers: parseInt(document.getElementById('p-maxusers').value) || 100,
        features,
    });
    closeModal('modal-plan');
    loadPlans();
    toast('Plan guardado', 'success');
}

async function deletePlan(id) {
    if (!confirm('¿Eliminar este plan?')) return;
    await db.collection(`${SA_COLLECTION}/data/plans`).doc(id).delete();
    loadPlans();
    toast('Plan eliminado', 'info');
}

// ── USERS ──
async function loadUsers() {
    const snap = await db.collection('artifacts/rocola-crowdplay2-v1/public/data/client_profiles').get();
    allUsers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderUsers(allUsers);
}

function renderUsers(users) {
    const tbody = document.getElementById('users-list');
    const venueFilter = document.getElementById('users-venue-filter')?.value;
    let filtered = users;
    if (venueFilter) filtered = users.filter(u => u.venueId === venueFilter);
    if (!filtered.length) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:20px;">Sin usuarios</td></tr>'; return; }
    tbody.innerHTML = filtered.map(u => {
        const created = u.createdAt?.toDate ? u.createdAt.toDate().toLocaleDateString('es-MX') : '—';
        return `<tr>
            <td><div style="font-weight:700;">${u.name || '—'} ${u.surname || ''}</div></td>
            <td style="font-size:0.78rem;color:var(--text-muted);">${u.email || '—'}</td>
            <td style="font-size:0.78rem;color:var(--text-muted);">${u.whatsapp || '—'}</td>
            <td><span style="font-weight:800;color:var(--accent-amber);">${u.credits || 0}</span></td>
            <td style="font-size:0.72rem;color:var(--text-muted);">${u.venueId || 'default'}</td>
            <td style="font-size:0.72rem;color:var(--text-muted);">${created}</td>
        </tr>`;
    }).join('');
}

function filterUsers(q) {
    const filtered = allUsers.filter(u =>
        !q || `${u.name} ${u.surname} ${u.email}`.toLowerCase().includes(q.toLowerCase())
    );
    renderUsers(filtered);
}

// ── DASHBOARD ──
function loadDashboard() {
    document.getElementById('stat-venues').innerText = allVenues.filter(v => v.status === 'active' || v.status === 'trial').length;
    document.getElementById('stat-users').innerText  = allUsers.length;
    const totalRiffs = allUsers.reduce((sum, u) => sum + (u.credits || 0), 0);
    document.getElementById('stat-riffs').innerText  = totalRiffs.toLocaleString();
    const planPrices = { basico: 499, pro: 999, enterprise: 0 };
    const mrr = allVenues.filter(v => v.status === 'active').reduce((sum, v) => sum + (planPrices[v.plan] || 0), 0);
    document.getElementById('stat-mrr').innerText = mrr > 0 ? '$' + mrr.toLocaleString() : '—';
    const tbody = document.getElementById('dashboard-venues-list');
    const recent = allVenues.slice(0, 6);
    if (!recent.length) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:20px;">Sin Venues</td></tr>'; return; }
    tbody.innerHTML = recent.map(v => {
        const statusBadge = { active: 'badge-green', trial: 'badge-amber', suspended: 'badge-red', inactive: 'badge-gray' }[v.status] || 'badge-gray';
        const statusLabel = { active: 'Activo', trial: 'Trial', suspended: 'Suspendido', inactive: 'Inactivo' }[v.status] || v.status;
        const trial = v.trialUntil ? new Date(v.trialUntil).toLocaleDateString('es-MX') : '—';
        const users = allUsers.filter(u => u.venueId === v.appId).length;
        return `<tr>
            <td><div style="font-weight:700;">${v.name}</div></td>
            <td><span class="badge badge-indigo">${v.plan || '—'}</span></td>
            <td><span class="badge ${statusBadge}">${statusLabel}</span></td>
            <td style="font-size:0.78rem;color:var(--text-muted);">${trial}</td>
            <td style="font-weight:700;">${users}</td>
        </tr>`;
    }).join('');
}

// ── ANALYTICS ──
async function loadAnalytics() {
    const venueFilter = document.getElementById('analytics-venue')?.value;
    const period = parseInt(document.getElementById('analytics-period')?.value || '30');
    const since = new Date(); since.setDate(since.getDate() - period);

    // Load queue history (basic analytics from rocola_queue)
    try {
        let q = db.collection('artifacts/rocola-crowdplay2-v1/public/data/rocola_queue');
        const snap = await q.get();
        const items = snap.docs.map(d => d.data());

        document.getElementById('an-songs').innerText  = items.length;
        const uniqueUsers = new Set(items.map(i => i.userId)).size;
        document.getElementById('an-users').innerText  = uniqueUsers;
        document.getElementById('an-riffs').innerText  = '—';
        document.getElementById('an-boosts').innerText = '—';

        // Top songs
        const songCounts = {};
        items.forEach(i => {
            if (!i.title) return;
            if (!songCounts[i.title]) songCounts[i.title] = { count: 0, votes: 0, venue: i.venueId || 'default' };
            songCounts[i.title].count++;
            songCounts[i.title].votes += (i.votes || 0);
        });
        const topSongs = Object.entries(songCounts).sort((a,b) => b[1].count - a[1].count).slice(0, 10);
        document.getElementById('analytics-top-songs').innerHTML = topSongs.length
            ? topSongs.map(([title, data], i) => `<tr><td style="font-weight:800;color:var(--accent-amber);">${i+1}</td><td style="font-weight:600;">${title}</td><td style="font-size:0.72rem;color:var(--text-muted);">${data.venue}</td><td style="font-weight:700;">${data.count}</td><td style="color:var(--accent-red);">${data.votes}</td></tr>`).join('')
            : '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:20px;">Sin datos</td></tr>';

        // Venues activity
        document.getElementById('analytics-venues').innerHTML = allVenues.map(v => {
            const vItems = items.filter(i => (i.venueId || 'default') === v.appId);
            const vUsers = new Set(vItems.map(i => i.userId)).size;
            const statusBadge = { active: 'badge-green', trial: 'badge-amber', suspended: 'badge-red' }[v.status] || 'badge-gray';
            return `<tr><td style="font-weight:700;">${v.name}</td><td><span class="badge ${statusBadge} badge-indigo">${v.plan}</span></td><td style="font-weight:700;">${vItems.length}</td><td>${vUsers}</td><td style="color:var(--accent-amber);">—</td></tr>`;
        }).join('') || '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:20px;">Sin Venues</td></tr>';

    } catch(e) { console.error(e); }
}

// ── EXPORT ──
function exportData(type) {
    let data = [], headers = [], filename = '';
    if (type === 'venues') {
        headers = ['Nombre','AppID','Ciudad','País','Email','WhatsApp','Plan','Estado','Trial hasta','Creado'];
        data = allVenues.map(v => [v.name, v.appId, v.city, v.country, v.email, v.phone, v.plan, v.status, v.trialUntil, v.createdAt?.toDate?.()?.toLocaleDateString('es-MX') || '']);
        filename = 'crowdplay_venues.csv';
    } else if (type === 'users') {
        headers = ['Nombre','Apellido','Email','WhatsApp','Riffs','Venue','Registro'];
        data = allUsers.map(u => [u.name, u.surname, u.email, u.whatsapp, u.credits || 0, u.venueId || 'default', u.createdAt?.toDate?.()?.toLocaleDateString('es-MX') || '']);
        filename = 'crowdplay_usuarios.csv';
    } else {
        toast('Este export estará disponible pronto', 'info'); return;
    }
    const csv = [headers, ...data].map(row => row.map(c => `"${(c||'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url  = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
    toast('CSV exportado', 'success');
}

// ── MODAL UTILS ──
function closeModal(id) {
    document.getElementById(id).classList.remove('open');
}
document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', e => { if (e.target === overlay) overlay.classList.remove('open'); });
});

// ── TOAST ──
function toast(message, type = 'info', duration = 3000) {
    const container = document.getElementById('toast-container');
    const el = document.createElement('div');
    el.className = `toast toast-${type}`;
    el.innerText = message;
    container.appendChild(el);
    setTimeout(() => el.remove(), duration);
}

// ── START ──
loadFirebase();
</script>
</body>
</html>
